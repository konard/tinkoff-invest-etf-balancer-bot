$ DEBUG=bot:main,bot:provider,bot:balancer bun run ./src/index.ts
Warning: sum of weights for account 0 equals 24.990000000000002%, not 100%
2025-09-04T15:27:28.948Z bot:main main start
2025-09-04T15:27:28.949Z bot:provider Getting accounts list
2025-09-04T15:27:29.476Z bot:provider accountsResponse {
  accounts: [
    {
      id: '2272547076',
      type: 1,
      name: '–ë—Ä–æ–∫–µ—Ä—Å–∫–∏–π —Å—á–µ—Ç 4',
      status: 2,
      openedDate: 2025-08-08T00:00:00.000Z,
      closedDate: 1970-01-01T00:00:00.000Z,
      accessLevel: 1
    }
  ]
}
2025-09-04T15:27:29.478Z bot:provider Selected account by index {
  id: '2272547076',
  type: 1,
  name: '–ë—Ä–æ–∫–µ—Ä—Å–∫–∏–π —Å—á–µ—Ç 4',
  status: 2,
  openedDate: 2025-08-08T00:00:00.000Z,
  closedDate: 1970-01-01T00:00:00.000Z,
  accessLevel: 1
}
2025-09-04T15:27:29.478Z bot:provider Getting shares list
2025-09-04T15:27:34.105Z bot:provider shares count 1936
2025-09-04T15:27:39.107Z bot:provider Getting ETFs list
2025-09-04T15:27:39.879Z bot:provider etfs count 276
2025-09-04T15:27:44.880Z bot:provider Getting bonds list
2025-09-04T15:27:49.162Z bot:provider bonds count 1406
2025-09-04T15:27:54.165Z bot:provider Getting currencies list
2025-09-04T15:27:54.308Z bot:provider currencies count 16
2025-09-04T15:27:59.311Z bot:provider Getting futures list
2025-09-04T15:28:00.674Z bot:provider futures count 365
2025-09-04T15:28:05.678Z bot:provider =========================
2025-09-04T15:28:05.684Z bot:provider Checking trading schedule for MOEX. Current time: 2025-09-04T15:28:05.684Z
2025-09-04T15:28:05.684Z bot:provider Request params: from=2025-09-04T15:28:05.684Z, to=2025-09-05T15:28:05.684Z
2025-09-04T15:28:05.831Z bot:provider Trading schedules response: {
  "exchanges": [
    {
      "exchange": "MOEX",
      "days": [
        {
          "date": "2025-09-04T00:00:00.000Z",
          "isTradingDay": true,
          "startTime": "2025-09-04T07:00:00.000Z",
          "endTime": "2025-09-04T15:39:59.000Z",
          "openingAuctionStartTime": "2025-09-04T06:50:00.000Z",
          "closingAuctionEndTime": "2025-09-04T15:50:00.000Z",
          "closingAuctionStartTime": "2025-09-04T15:40:01.000Z",
          "openingAuctionEndTime": "2025-09-04T06:59:59.000Z",
          "intervals": [
            {
              "type": "regular_trading_session",
              "interval": {
                "startTs": "2025-09-04T07:00:00.000Z",
                "endTs": "2025-09-04T15:39:59.000Z"
              }
            },
            {
              "type": "regular_trading_session_main",
              "interval": {
                "startTs": "2025-09-04T07:00:00.000Z",
                "endTs": "2025-09-04T15:39:59.000Z"
              }
            },
            {
              "type": "opening_auction",
              "interval": {
                "startTs": "2025-09-04T06:50:00.000Z",
                "endTs": "2025-09-04T06:59:59.000Z"
              }
            },
            {
              "type": "opening_auction_main",
              "interval": {
                "startTs": "2025-09-04T06:50:00.000Z",
                "endTs": "2025-09-04T06:59:59.000Z"
              }
            },
            {
              "type": "closing_auction",
              "interval": {
                "startTs": "2025-09-04T15:40:01.000Z",
                "endTs": "2025-09-04T15:50:00.000Z"
              }
            },
            {
              "type": "closing_auction_main",
              "interval": {
                "startTs": "2025-09-04T15:40:01.000Z",
                "endTs": "2025-09-04T15:50:00.000Z"
              }
            }
          ]
        },
        {
          "date": "2025-09-05T00:00:00.000Z",
          "isTradingDay": true,
          "startTime": "2025-09-05T07:00:00.000Z",
          "endTime": "2025-09-05T15:39:59.000Z",
          "openingAuctionStartTime": "2025-09-05T06:50:00.000Z",
          "closingAuctionEndTime": "2025-09-05T15:50:00.000Z",
          "closingAuctionStartTime": "2025-09-05T15:40:01.000Z",
          "openingAuctionEndTime": "2025-09-05T06:59:59.000Z",
          "intervals": [
            {
              "type": "regular_trading_session",
              "interval": {
                "startTs": "2025-09-05T07:00:00.000Z",
                "endTs": "2025-09-05T15:39:59.000Z"
              }
            },
            {
              "type": "regular_trading_session_main",
              "interval": {
                "startTs": "2025-09-05T07:00:00.000Z",
                "endTs": "2025-09-05T15:39:59.000Z"
              }
            },
            {
              "type": "opening_auction",
              "interval": {
                "startTs": "2025-09-05T06:50:00.000Z",
                "endTs": "2025-09-05T06:59:59.000Z"
              }
            },
            {
              "type": "opening_auction_main",
              "interval": {
                "startTs": "2025-09-05T06:50:00.000Z",
                "endTs": "2025-09-05T06:59:59.000Z"
              }
            },
            {
              "type": "closing_auction",
              "interval": {
                "startTs": "2025-09-05T15:40:01.000Z",
                "endTs": "2025-09-05T15:50:00.000Z"
              }
            },
            {
              "type": "closing_auction_main",
              "interval": {
                "startTs": "2025-09-05T15:40:01.000Z",
                "endTs": "2025-09-05T15:50:00.000Z"
              }
            }
          ]
        }
      ]
    }
  ]
}
2025-09-04T15:28:05.831Z bot:provider Found 2 trading days in schedule
2025-09-04T15:28:05.831Z bot:provider Processing day: {
  "date": "2025-09-04T00:00:00.000Z",
  "isTradingDay": true,
  "startTime": "2025-09-04T07:00:00.000Z",
  "endTime": "2025-09-04T15:39:59.000Z",
  "openingAuctionStartTime": "2025-09-04T06:50:00.000Z",
  "closingAuctionEndTime": "2025-09-04T15:50:00.000Z",
  "closingAuctionStartTime": "2025-09-04T15:40:01.000Z",
  "openingAuctionEndTime": "2025-09-04T06:59:59.000Z",
  "intervals": [
    {
      "type": "regular_trading_session",
      "interval": {
        "startTs": "2025-09-04T07:00:00.000Z",
        "endTs": "2025-09-04T15:39:59.000Z"
      }
    },
    {
      "type": "regular_trading_session_main",
      "interval": {
        "startTs": "2025-09-04T07:00:00.000Z",
        "endTs": "2025-09-04T15:39:59.000Z"
      }
    },
    {
      "type": "opening_auction",
      "interval": {
        "startTs": "2025-09-04T06:50:00.000Z",
        "endTs": "2025-09-04T06:59:59.000Z"
      }
    },
    {
      "type": "opening_auction_main",
      "interval": {
        "startTs": "2025-09-04T06:50:00.000Z",
        "endTs": "2025-09-04T06:59:59.000Z"
      }
    },
    {
      "type": "closing_auction",
      "interval": {
        "startTs": "2025-09-04T15:40:01.000Z",
        "endTs": "2025-09-04T15:50:00.000Z"
      }
    },
    {
      "type": "closing_auction_main",
      "interval": {
        "startTs": "2025-09-04T15:40:01.000Z",
        "endTs": "2025-09-04T15:50:00.000Z"
      }
    }
  ]
}
2025-09-04T15:28:05.831Z bot:provider Session times: start=2025-09-04T07:00:00.000Z, end=2025-09-04T15:39:59.000Z
2025-09-04T15:28:05.831Z bot:provider Evening session: start=undefined, end=undefined
2025-09-04T15:28:05.831Z bot:provider Current time is within main trading session
2025-09-04T15:28:05.831Z bot:provider Getting portfolio and positions simultaneously
2025-09-04T15:28:05.994Z bot:provider portfolio {
  totalAmountShares: { currency: 'rub', units: 0, nano: 0 },
  totalAmountBonds: { currency: 'rub', units: 0, nano: 0 },
  totalAmountEtf: { currency: 'rub', units: 462, nano: 210000000 },
  totalAmountCurrencies: { currency: 'rub', units: 477, nano: 960000000 },
  totalAmountFutures: { currency: 'rub', units: 0, nano: 0 },
  expectedYield: { units: 0, nano: 10000000 },
  positions: [
    {
      figi: 'TCS00A108WX3',
      instrumentType: 'etf',
      quantity: [Object],
      averagePositionPrice: [Object],
      expectedYield: [Object],
      currentNkd: undefined,
      averagePositionPricePt: [Object],
      currentPrice: [Object],
      averagePositionPriceFifo: [Object],
      quantityLots: [Object],
      blocked: false,
      blockedLots: [Object],
      positionUid: '41be4f89-9d19-4eac-9ae4-09276f85956a',
      instrumentUid: '1d0e01e5-148c-40e5-bb8f-1bf2d8e03c1a',
      varMargin: [Object],
      expectedYieldFifo: [Object],
      dailyYield: [Object]
    },
    {
      figi: 'RUB000UTSTOM',
      instrumentType: 'currency',
      quantity: [Object],
      averagePositionPrice: [Object],
      expectedYield: [Object],
      currentNkd: undefined,
      averagePositionPricePt: [Object],
      currentPrice: [Object],
      averagePositionPriceFifo: [Object],
      quantityLots: [Object],
      blocked: false,
      blockedLots: [Object],
      positionUid: '33e24a92-aab0-409c-88b8-f2d57415b920',
      instrumentUid: 'a92e2e25-a698-45cc-a781-167cf465257c',
      varMargin: [Object],
      expectedYieldFifo: [Object],
      dailyYield: [Object]
    },
    {
      figi: 'TCS70A10A1L8',
      instrumentType: 'etf',
      quantity: [Object],
      averagePositionPrice: [Object],
      expectedYield: [Object],
      currentNkd: undefined,
      averagePositionPricePt: [Object],
      currentPrice: [Object],
      averagePositionPriceFifo: [Object],
      quantityLots: [Object],
      blocked: false,
      blockedLots: [Object],
      positionUid: '83fd264c-28fc-4b6a-b8f2-ae090148050d',
      instrumentUid: 'c5049184-ded4-49d0-8e14-bffefc40a223',
      varMargin: [Object],
      expectedYieldFifo: [Object],
      dailyYield: [Object]
    },
    {
      figi: 'TCS60A101X76',
      instrumentType: 'etf',
      quantity: [Object],
      averagePositionPrice: [Object],
      expectedYield: [Object],
      currentNkd: undefined,
      averagePositionPricePt: [Object],
      currentPrice: [Object],
      averagePositionPriceFifo: [Object],
      quantityLots: [Object],
      blocked: false,
      blockedLots: [Object],
      positionUid: 'ffd48f38-aa9b-491c-8e40-140a3f0bc931',
      instrumentUid: 'f509af83-6e71-462f-901f-bcb073f6773b',
      varMargin: [Object],
      expectedYieldFifo: [Object],
      dailyYield: [Object]
    }
  ],
  accountId: '2272547076',
  totalAmountOptions: { currency: 'rub', units: 0, nano: 0 },
  totalAmountSp: { currency: 'rub', units: 0, nano: 0 },
  totalAmountPortfolio: { currency: 'rub', units: 940, nano: 170000000 },
  virtualPositions: [],
  dailyYield: { currency: 'rub', units: 0, nano: 100000000 },
  dailyYieldRelative: { units: 0, nano: 10000000 }
}
2025-09-04T15:28:05.995Z bot:provider positions {
  money: [ { currency: 'rub', units: 477, nano: 960000000 } ],
  blocked: [],
  securities: [
    {
      figi: 'TCS00A108WX3',
      blocked: 0,
      balance: 2,
      positionUid: '41be4f89-9d19-4eac-9ae4-09276f85956a',
      instrumentUid: '1d0e01e5-148c-40e5-bb8f-1bf2d8e03c1a',
      exchangeBlocked: false,
      instrumentType: 'etf'
    },
    {
      figi: 'TCS60A101X76',
      blocked: 0,
      balance: 19,
      positionUid: 'ffd48f38-aa9b-491c-8e40-140a3f0bc931',
      instrumentUid: 'f509af83-6e71-462f-901f-bcb073f6773b',
      exchangeBlocked: false,
      instrumentType: 'etf'
    },
    {
      figi: 'TCS70A10A1L8',
      blocked: 0,
      balance: 10,
      positionUid: '83fd264c-28fc-4b6a-b8f2-ae090148050d',
      instrumentUid: 'c5049184-ded4-49d0-8e14-bffefc40a223',
      exchangeBlocked: false,
      instrumentType: 'etf'
    }
  ],
  limitsLoadingInProgress: false,
  futures: [],
  options: [],
  accountId: '2272547076'
}
2025-09-04T15:28:05.996Z bot:provider portfolioPositions [
  {
    figi: 'TCS00A108WX3',
    instrumentType: 'etf',
    quantity: { units: 2, nano: 0 },
    averagePositionPrice: { currency: 'rub', units: 100, nano: 680000000 },
    expectedYield: { units: 0, nano: 0 },
    currentNkd: undefined,
    averagePositionPricePt: { units: 0, nano: 0 },
    currentPrice: { currency: 'rub', units: 100, nano: 680000000 },
    averagePositionPriceFifo: { currency: 'rub', units: 100, nano: 680000000 },
    quantityLots: { units: 2, nano: 0 },
    blocked: false,
    blockedLots: { units: 0, nano: 0 },
    positionUid: '41be4f89-9d19-4eac-9ae4-09276f85956a',
    instrumentUid: '1d0e01e5-148c-40e5-bb8f-1bf2d8e03c1a',
    varMargin: { currency: '', units: 0, nano: 0 },
    expectedYieldFifo: { units: 0, nano: 0 },
    dailyYield: { currency: 'rub', units: 0, nano: 0 }
  },
  {
    figi: 'RUB000UTSTOM',
    instrumentType: 'currency',
    quantity: { units: 477, nano: 960000000 },
    averagePositionPrice: { currency: 'rub', units: 1, nano: 0 },
    expectedYield: { units: 0, nano: 0 },
    currentNkd: undefined,
    averagePositionPricePt: { units: 0, nano: 0 },
    currentPrice: { currency: 'rub', units: 1, nano: 0 },
    averagePositionPriceFifo: { currency: 'rub', units: 1, nano: 0 },
    quantityLots: { units: 477, nano: 960000000 },
    blocked: false,
    blockedLots: { units: 0, nano: 0 },
    positionUid: '33e24a92-aab0-409c-88b8-f2d57415b920',
    instrumentUid: 'a92e2e25-a698-45cc-a781-167cf465257c',
    varMargin: { currency: '', units: 0, nano: 0 },
    expectedYieldFifo: { units: 0, nano: 0 },
    dailyYield: { currency: 'rub', units: 0, nano: 0 }
  },
  {
    figi: 'TCS70A10A1L8',
    instrumentType: 'etf',
    quantity: { units: 10, nano: 0 },
    averagePositionPrice: { currency: 'rub', units: 13, nano: 440000000 },
    expectedYield: { units: 0, nano: 100000000 },
    currentNkd: undefined,
    averagePositionPricePt: { units: 0, nano: 0 },
    currentPrice: { currency: 'rub', units: 13, nano: 450000000 },
    averagePositionPriceFifo: { currency: 'rub', units: 13, nano: 440000000 },
    quantityLots: { units: 10, nano: 0 },
    blocked: false,
    blockedLots: { units: 0, nano: 0 },
    positionUid: '83fd264c-28fc-4b6a-b8f2-ae090148050d',
    instrumentUid: 'c5049184-ded4-49d0-8e14-bffefc40a223',
    varMargin: { currency: '', units: 0, nano: 0 },
    expectedYieldFifo: { units: 0, nano: 100000000 },
    dailyYield: { currency: 'rub', units: 0, nano: 100000000 }
  },
  {
    figi: 'TCS60A101X76',
    instrumentType: 'etf',
    quantity: { units: 19, nano: 0 },
    averagePositionPrice: { currency: 'rub', units: 6, nano: 650000000 },
    expectedYield: { units: 0, nano: 0 },
    currentNkd: undefined,
    averagePositionPricePt: { units: 0, nano: 0 },
    currentPrice: { currency: 'rub', units: 6, nano: 650000000 },
    averagePositionPriceFifo: { currency: 'rub', units: 6, nano: 650000000 },
    quantityLots: { units: 19, nano: 0 },
    blocked: false,
    blockedLots: { units: 0, nano: 0 },
    positionUid: 'ffd48f38-aa9b-491c-8e40-140a3f0bc931',
    instrumentUid: 'f509af83-6e71-462f-901f-bcb073f6773b',
    varMargin: { currency: '', units: 0, nano: 0 },
    expectedYieldFifo: { units: 0, nano: 0 },
    dailyYield: { currency: 'rub', units: 0, nano: 0 }
  }
]
2025-09-04T15:28:05.997Z bot:provider Adding currencies to Wallet
2025-09-04T15:28:05.997Z bot:provider corePosition {
  pair: 'RUB/RUB',
  base: 'RUB',
  quote: 'RUB',
  figi: undefined,
  amount: 477.96,
  lotSize: 1,
  price: { units: 1, nano: 0 },
  priceNumber: 1,
  lotPrice: { units: 1, nano: 0 }
}
2025-09-04T15:28:05.999Z bot:provider Adding positions to Wallet
2025-09-04T15:28:05.999Z bot:provider position {
  figi: 'TCS00A108WX3',
  instrumentType: 'etf',
  quantity: { units: 2, nano: 0 },
  averagePositionPrice: { currency: 'rub', units: 100, nano: 680000000 },
  expectedYield: { units: 0, nano: 0 },
  currentNkd: undefined,
  averagePositionPricePt: { units: 0, nano: 0 },
  currentPrice: { currency: 'rub', units: 100, nano: 680000000 },
  averagePositionPriceFifo: { currency: 'rub', units: 100, nano: 680000000 },
  quantityLots: { units: 2, nano: 0 },
  blocked: false,
  blockedLots: { units: 0, nano: 0 },
  positionUid: '41be4f89-9d19-4eac-9ae4-09276f85956a',
  instrumentUid: '1d0e01e5-148c-40e5-bb8f-1bf2d8e03c1a',
  varMargin: { currency: '', units: 0, nano: 0 },
  expectedYieldFifo: { units: 0, nano: 0 },
  dailyYield: { currency: 'rub', units: 0, nano: 0 }
}
2025-09-04T15:28:06.000Z bot:provider instrument {
  figi: 'TCS00A108WX3',
  ticker: 'TPAY',
  classCode: 'TQTF',
  isin: 'RU000A108WX3',
  lot: 1,
  currency: 'rub',
  klong: { units: 2, nano: 0 },
  kshort: { units: 2, nano: 0 },
  dlong: { units: 0, nano: 166600000 },
  dshort: undefined,
  dlongMin: { units: 0, nano: 153800000 },
  dshortMin: undefined,
  shortEnabledFlag: false,
  name: '–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥',
  exchange: 'moex_etf_evening',
  fixedCommission: { units: 0, nano: 900000000 },
  focusType: 'fixed_income',
  releasedDate: 2024-06-27T00:00:00.000Z,
  numShares: undefined,
  countryOfRisk: 'RU',
  countryOfRiskName: '–†–æ—Å—Å–∏–π—Å–∫–∞—è –§–µ–¥–µ—Ä–∞—Ü–∏—è',
  sector: 'other',
  rebalancingFreq: 'semi_annual',
  tradingStatus: 5,
  otcFlag: false,
  buyAvailableFlag: true,
  sellAvailableFlag: true,
  minPriceIncrement: { units: 0, nano: 10000000 },
  apiTradeAvailableFlag: true,
  uid: '1d0e01e5-148c-40e5-bb8f-1bf2d8e03c1a',
  realExchange: 1,
  positionUid: '41be4f89-9d19-4eac-9ae4-09276f85956a',
  assetUid: 'a9f74b0a-f3dc-4a25-aebe-7fb1732dd510',
  instrumentExchange: 0,
  forIisFlag: true,
  forQualInvestorFlag: false,
  weekendFlag: false,
  blockedTcaFlag: false,
  liquidityFlag: true,
  first1minCandleDate: 2024-08-12T06:59:00.000Z,
  first1dayCandleDate: 2024-08-12T00:00:00.000Z,
  brand: {
    logoName: 'TPAY.png',
    logoBaseColor: '#000000',
    textColor: '#ffffff'
  },
  dlongClient: { units: 0, nano: 153800000 },
  dshortClient: { units: 0, nano: 0 }
}
2025-09-04T15:28:06.001Z bot:provider Getting last price
2025-09-04T15:28:06.151Z bot:provider lastPriceResult {
  lastPrices: [
    {
      figi: 'TCS00A108WX3',
      price: [Object],
      time: 2025-09-04T15:28:33.297Z,
      instrumentUid: '1d0e01e5-148c-40e5-bb8f-1bf2d8e03c1a',
      lastPriceType: 1
    }
  ]
}
2025-09-04T15:28:06.152Z bot:provider lastPrice { units: 100, nano: 680000000 }
2025-09-04T15:28:11.154Z bot:provider priceWhenAddToWallet { units: 100, nano: 680000000 }
2025-09-04T15:28:11.155Z bot:provider corePosition {
  pair: 'TPAY/RUB',
  base: 'TPAY',
  quote: 'RUB',
  figi: 'TCS00A108WX3',
  amount: 2,
  lotSize: 1,
  price: { units: 100, nano: 680000000 },
  priceNumber: 100.68,
  lotPrice: { units: 100, nano: 680000000 },
  totalPrice: { units: 201, nano: 360000000 },
  totalPriceNumber: 201.36,
  averagePositionPriceFifoNumber: 100.68,
  averagePositionPriceNumber: 100.68
}
2025-09-04T15:28:11.155Z bot:provider position {
  figi: 'RUB000UTSTOM',
  instrumentType: 'currency',
  quantity: { units: 477, nano: 960000000 },
  averagePositionPrice: { currency: 'rub', units: 1, nano: 0 },
  expectedYield: { units: 0, nano: 0 },
  currentNkd: undefined,
  averagePositionPricePt: { units: 0, nano: 0 },
  currentPrice: { currency: 'rub', units: 1, nano: 0 },
  averagePositionPriceFifo: { currency: 'rub', units: 1, nano: 0 },
  quantityLots: { units: 477, nano: 960000000 },
  blocked: false,
  blockedLots: { units: 0, nano: 0 },
  positionUid: '33e24a92-aab0-409c-88b8-f2d57415b920',
  instrumentUid: 'a92e2e25-a698-45cc-a781-167cf465257c',
  varMargin: { currency: '', units: 0, nano: 0 },
  expectedYieldFifo: { units: 0, nano: 0 },
  dailyYield: { currency: 'rub', units: 0, nano: 0 }
}
2025-09-04T15:28:11.160Z bot:provider instrument undefined
2025-09-04T15:28:11.160Z bot:provider instrument not found by figi, skip position RUB000UTSTOM
2025-09-04T15:28:11.160Z bot:provider position {
  figi: 'TCS70A10A1L8',
  instrumentType: 'etf',
  quantity: { units: 10, nano: 0 },
  averagePositionPrice: { currency: 'rub', units: 13, nano: 440000000 },
  expectedYield: { units: 0, nano: 100000000 },
  currentNkd: undefined,
  averagePositionPricePt: { units: 0, nano: 0 },
  currentPrice: { currency: 'rub', units: 13, nano: 450000000 },
  averagePositionPriceFifo: { currency: 'rub', units: 13, nano: 440000000 },
  quantityLots: { units: 10, nano: 0 },
  blocked: false,
  blockedLots: { units: 0, nano: 0 },
  positionUid: '83fd264c-28fc-4b6a-b8f2-ae090148050d',
  instrumentUid: 'c5049184-ded4-49d0-8e14-bffefc40a223',
  varMargin: { currency: '', units: 0, nano: 0 },
  expectedYieldFifo: { units: 0, nano: 100000000 },
  dailyYield: { currency: 'rub', units: 0, nano: 100000000 }
}
2025-09-04T15:28:11.161Z bot:provider instrument {
  figi: 'TCS70A10A1L8',
  ticker: 'TOFZ@',
  classCode: 'SPBRU',
  isin: 'RU000A10A1L8',
  lot: 1,
  currency: 'rub',
  klong: { units: 2, nano: 0 },
  kshort: { units: 2, nano: 0 },
  dlong: { units: 0, nano: 250000000 },
  dshort: { units: 0, nano: 300000000 },
  dlongMin: { units: 0, nano: 200000000 },
  dshortMin: { units: 0, nano: 250000000 },
  shortEnabledFlag: true,
  name: '–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±–ª–∏–≥–∞—Ü–∏–∏',
  exchange: 'spb_etf_ru_noweekend',
  fixedCommission: { units: 1, nano: 500000000 },
  focusType: 'fixed_income',
  releasedDate: 2024-11-07T00:00:00.000Z,
  numShares: undefined,
  countryOfRisk: 'RU',
  countryOfRiskName: '–†–æ—Å—Å–∏–π—Å–∫–∞—è –§–µ–¥–µ—Ä–∞—Ü–∏—è',
  sector: 'other',
  rebalancingFreq: 'semi_annual',
  tradingStatus: 5,
  otcFlag: false,
  buyAvailableFlag: true,
  sellAvailableFlag: true,
  minPriceIncrement: { units: 0, nano: 10000000 },
  apiTradeAvailableFlag: true,
  uid: 'c5049184-ded4-49d0-8e14-bffefc40a223',
  realExchange: 2,
  positionUid: '83fd264c-28fc-4b6a-b8f2-ae090148050d',
  assetUid: 'a20a8e51-dd4e-4ba3-beb0-a9bf4dd0a983',
  instrumentExchange: 0,
  forIisFlag: true,
  forQualInvestorFlag: false,
  weekendFlag: false,
  blockedTcaFlag: false,
  liquidityFlag: true,
  first1minCandleDate: 2024-12-09T07:02:00.000Z,
  first1dayCandleDate: 2024-12-09T00:00:00.000Z,
  brand: {
    logoName: 'TOFZ.png',
    logoBaseColor: '#000000',
    textColor: '#ffffff'
  },
  dlongClient: { units: 0, nano: 200000000 },
  dshortClient: { units: 0, nano: 250000000 }
}
2025-09-04T15:28:11.161Z bot:provider Getting last price
2025-09-04T15:28:11.313Z bot:provider lastPriceResult {
  lastPrices: [
    {
      figi: 'TCS70A10A1L8',
      price: [Object],
      time: 2025-09-04T15:28:39.491Z,
      instrumentUid: 'c5049184-ded4-49d0-8e14-bffefc40a223',
      lastPriceType: 1
    }
  ]
}
2025-09-04T15:28:11.313Z bot:provider lastPrice { units: 13, nano: 440000000 }
2025-09-04T15:28:16.316Z bot:provider priceWhenAddToWallet { units: 13, nano: 440000000 }
2025-09-04T15:28:16.316Z bot:provider corePosition {
  pair: 'TOFZ@/RUB',
  base: 'TOFZ@',
  quote: 'RUB',
  figi: 'TCS70A10A1L8',
  amount: 10,
  lotSize: 1,
  price: { units: 13, nano: 440000000 },
  priceNumber: 13.45,
  lotPrice: { units: 13, nano: 440000000 },
  totalPrice: { units: 134, nano: 500000000 },
  totalPriceNumber: 134.5,
  averagePositionPriceFifoNumber: 13.44,
  averagePositionPriceNumber: 13.44
}
2025-09-04T15:28:16.317Z bot:provider position {
  figi: 'TCS60A101X76',
  instrumentType: 'etf',
  quantity: { units: 19, nano: 0 },
  averagePositionPrice: { currency: 'rub', units: 6, nano: 650000000 },
  expectedYield: { units: 0, nano: 0 },
  currentNkd: undefined,
  averagePositionPricePt: { units: 0, nano: 0 },
  currentPrice: { currency: 'rub', units: 6, nano: 650000000 },
  averagePositionPriceFifo: { currency: 'rub', units: 6, nano: 650000000 },
  quantityLots: { units: 19, nano: 0 },
  blocked: false,
  blockedLots: { units: 0, nano: 0 },
  positionUid: 'ffd48f38-aa9b-491c-8e40-140a3f0bc931',
  instrumentUid: 'f509af83-6e71-462f-901f-bcb073f6773b',
  varMargin: { currency: '', units: 0, nano: 0 },
  expectedYieldFifo: { units: 0, nano: 0 },
  dailyYield: { currency: 'rub', units: 0, nano: 0 }
}
2025-09-04T15:28:16.318Z bot:provider instrument {
  figi: 'TCS60A101X76',
  ticker: 'TMOS@',
  classCode: 'SPBRU',
  isin: 'RU000A101X76',
  lot: 1,
  currency: 'rub',
  klong: { units: 2, nano: 0 },
  kshort: { units: 2, nano: 0 },
  dlong: { units: 0, nano: 181800000 },
  dshort: { units: 0, nano: 200000000 },
  dlongMin: { units: 0, nano: 125000000 },
  dshortMin: { units: 0, nano: 142800000 },
  shortEnabledFlag: true,
  name: '–ö—Ä—É–ø–Ω–µ–π—à–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –†–§',
  exchange: 'spb_etf_ru_noweekend',
  fixedCommission: { units: 0, nano: 700000000 },
  focusType: 'equity',
  releasedDate: 2020-07-13T00:00:00.000Z,
  numShares: undefined,
  countryOfRisk: 'RU',
  countryOfRiskName: '–†–æ—Å—Å–∏–π—Å–∫–∞—è –§–µ–¥–µ—Ä–∞—Ü–∏—è',
  sector: 'other',
  rebalancingFreq: 'quarterly',
  tradingStatus: 5,
  otcFlag: false,
  buyAvailableFlag: true,
  sellAvailableFlag: true,
  minPriceIncrement: { units: 0, nano: 10000000 },
  apiTradeAvailableFlag: true,
  uid: 'f509af83-6e71-462f-901f-bcb073f6773b',
  realExchange: 2,
  positionUid: 'ffd48f38-aa9b-491c-8e40-140a3f0bc931',
  assetUid: '41ee95a0-318f-49e1-bfe4-2c3f7c83fe21',
  instrumentExchange: 0,
  forIisFlag: true,
  forQualInvestorFlag: false,
  weekendFlag: false,
  blockedTcaFlag: false,
  liquidityFlag: true,
  first1minCandleDate: 2020-08-26T07:14:00.000Z,
  first1dayCandleDate: 2020-08-26T07:00:00.000Z,
  brand: {
    logoName: 'TMOS.png',
    logoBaseColor: '#000000',
    textColor: '#ffffff'
  },
  dlongClient: { units: 0, nano: 125000000 },
  dshortClient: { units: 0, nano: 142800000 }
}
2025-09-04T15:28:16.319Z bot:provider Getting last price
2025-09-04T15:28:16.469Z bot:provider lastPriceResult {
  lastPrices: [
    {
      figi: 'TCS60A101X76',
      price: [Object],
      time: 2025-09-04T15:28:43.769Z,
      instrumentUid: 'f509af83-6e71-462f-901f-bcb073f6773b',
      lastPriceType: 1
    }
  ]
}
2025-09-04T15:28:16.469Z bot:provider lastPrice { units: 6, nano: 650000000 }
2025-09-04T15:28:21.471Z bot:provider priceWhenAddToWallet { units: 6, nano: 650000000 }
2025-09-04T15:28:21.472Z bot:provider corePosition {
  pair: 'TMOS@/RUB',
  base: 'TMOS@',
  quote: 'RUB',
  figi: 'TCS60A101X76',
  amount: 19,
  lotSize: 1,
  price: { units: 6, nano: 650000000 },
  priceNumber: 6.65,
  lotPrice: { units: 6, nano: 650000000 },
  totalPrice: { units: 126, nano: 350000000 },
  totalPriceNumber: 126.35000000000001,
  averagePositionPriceFifoNumber: 6.65,
  averagePositionPriceNumber: 6.65
}
2025-09-04T15:28:21.473Z bot:provider [
  {
    pair: 'RUB/RUB',
    base: 'RUB',
    quote: 'RUB',
    figi: undefined,
    amount: 477.96,
    lotSize: 1,
    price: { units: 1, nano: 0 },
    priceNumber: 1,
    lotPrice: { units: 1, nano: 0 }
  },
  {
    pair: 'TPAY/RUB',
    base: 'TPAY',
    quote: 'RUB',
    figi: 'TCS00A108WX3',
    amount: 2,
    lotSize: 1,
    price: { units: 100, nano: 680000000 },
    priceNumber: 100.68,
    lotPrice: { units: 100, nano: 680000000 },
    totalPrice: { units: 201, nano: 360000000 },
    totalPriceNumber: 201.36,
    averagePositionPriceFifoNumber: 100.68,
    averagePositionPriceNumber: 100.68
  },
  {
    pair: 'TOFZ@/RUB',
    base: 'TOFZ@',
    quote: 'RUB',
    figi: 'TCS70A10A1L8',
    amount: 10,
    lotSize: 1,
    price: { units: 13, nano: 440000000 },
    priceNumber: 13.45,
    lotPrice: { units: 13, nano: 440000000 },
    totalPrice: { units: 134, nano: 500000000 },
    totalPriceNumber: 134.5,
    averagePositionPriceFifoNumber: 13.44,
    averagePositionPriceNumber: 13.44
  },
  {
    pair: 'TMOS@/RUB',
    base: 'TMOS@',
    quote: 'RUB',
    figi: 'TCS60A101X76',
    amount: 19,
    lotSize: 1,
    price: { units: 6, nano: 650000000 },
    priceNumber: 6.65,
    lotPrice: { units: 6, nano: 650000000 },
    totalPrice: { units: 126, nano: 350000000 },
    totalPriceNumber: 126.35000000000001,
    averagePositionPriceFifoNumber: 6.65,
    averagePositionPriceNumber: 6.65
  }
]
[etfCap] buildAumMapSmart: fetched HTML length=242634
[etfCap] buildAumMapSmart: auto result: {}
[etfCap] [DEBUG] TMON AUM search: FOUND
[etfCap] [DEBUG] TMOS AUM search: FOUND
[etfCap] [DEBUG] TOFZ AUM search: FOUND
[etfCap] buildAumMapSmart: final result: {
  TMON: {
    amount: 212625657935.99,
    currency: "RUB",
  },
  TMOS: {
    amount: 12125435811.93,
    currency: "RUB",
  },
  TOFZ: {
    amount: 4175228269.23,
    currency: "RUB",
  },
}
[pollEtfMetrics] symbol=TMON search sharesCount via Smartfeed API
[pollEtfMetrics] smartfeed brand=–î–µ–Ω–µ–∂–Ω—ã–π —Ä—ã–Ω–æ–∫ news=50 cursorNext=ts:1751478495000‚Ä¶
[pollEtfMetrics] smartfeed hit id=18549220 title=–í —Ñ–æ–Ω–¥ –ø–æ—Å—Ç—É–ø–∏–ª–∏ –Ω–æ–≤—ã–µ –¥–µ–Ω—å–≥–∏ count=1510500000
[pollEtfMetrics] price: lastPriceRUB=142.28 for TMON
[pollEtfMetrics] payload TMON: price=142.28 shares=1510500000 aum=212625657935.99 mcap=214913940000
[pollEtfMetrics] saved /Users/suenot/projects/tinkoff-invest-etf-balancer-bot/etf_metrics/TMON.json
[pollEtfMetrics] symbol=TMOS search sharesCount via Smartfeed API
[pollEtfMetrics] smartfeed brand=–ö—Ä—É–ø–Ω–µ–π—à–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –†–§ news=50 cursorNext=ts:1753274815243‚Ä¶
[pollEtfMetrics] smartfeed hit id=18549215 title=–í —Ñ–æ–Ω–¥ –ø–æ—Å—Ç—É–ø–∏–ª–∏ –Ω–æ–≤—ã–µ –¥–µ–Ω—å–≥–∏ count=1849600000
[pollEtfMetrics] price: lastPriceRUB=6.65 for TMOS
[pollEtfMetrics] payload TMOS: price=6.65 shares=1849600000 aum=12125435811.93 mcap=12299840000
[pollEtfMetrics] saved /Users/suenot/projects/tinkoff-invest-etf-balancer-bot/etf_metrics/TMOS.json
[pollEtfMetrics] symbol=TOFZ search sharesCount via Smartfeed API
[pollEtfMetrics] smartfeed brand=–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±–ª–∏–≥–∞—Ü–∏–∏ news=50 cursorNext=ts:1753448223549‚Ä¶
[pollEtfMetrics] smartfeed hit id=18549219 title=–í —Ñ–æ–Ω–¥ –ø–æ—Å—Ç—É–ø–∏–ª–∏ –Ω–æ–≤—ã–µ –¥–µ–Ω—å–≥–∏ count=315900000
[pollEtfMetrics] price: lastPriceRUB=13.44 for TOFZ
[pollEtfMetrics] payload TOFZ: price=13.44 shares=315900000 aum=4175228269.23 mcap=4245696000
[pollEtfMetrics] saved /Users/suenot/projects/tinkoff-invest-etf-balancer-bot/etf_metrics/TOFZ.json

üìä Successfully applied mode: manual

üîç DIAGNOSIS: Portfolio state BEFORE balancing
üìä Total positions in coreWallet: 4
üí∞ RUB balance before: 477.96
‚è∞ Timestamp before balancing: 2025-09-04T15:28:31.876Z
2025-09-04T15:28:31.881Z bot:balancer Buy requires total marginal sell is enabled, checking for special handling
2025-09-04T15:28:31.882Z bot:balancer Margin strategy: {
  shouldRemoveMargin: false,
  reason: 'Strategy: keep margin (sum 462.21 rub <= max 5000 rub, time to close: 17 min)',
  transferCost: 0,
  timeInfo: { timeToClose: 17, timeToNextBalance: 60, isLastBalance: true },
  marginPositions: [
    {
      pair: 'TPAY/RUB',
      base: 'TPAY',
      quote: 'RUB',
      figi: 'TCS00A108WX3',
      amount: 2,
      lotSize: 1,
      price: [Object],
      priceNumber: 100.68,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 201.36,
      averagePositionPriceFifoNumber: 100.68,
      averagePositionPriceNumber: 100.68,
      isMargin: true,
      marginValue: 134.24,
      leverage: 3,
      marginCall: false
    },
    {
      pair: 'TOFZ@/RUB',
      base: 'TOFZ@',
      quote: 'RUB',
      figi: 'TCS70A10A1L8',
      amount: 10,
      lotSize: 1,
      price: [Object],
      priceNumber: 13.45,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 134.5,
      averagePositionPriceFifoNumber: 13.44,
      averagePositionPriceNumber: 13.44,
      isMargin: true,
      marginValue: 89.66666666666666,
      leverage: 3,
      marginCall: false
    },
    {
      pair: 'TMOS@/RUB',
      base: 'TMOS@',
      quote: 'RUB',
      figi: 'TCS60A101X76',
      amount: 19,
      lotSize: 1,
      price: [Object],
      priceNumber: 6.65,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 126.35000000000001,
      averagePositionPriceFifoNumber: 6.65,
      averagePositionPriceNumber: 6.65,
      isMargin: true,
      marginValue: 84.23333333333335,
      leverage: 3,
      marginCall: false
    }
  ]
}
2025-09-04T15:28:31.884Z bot:balancer Normalizing percentages to make total sum equal 100%, to exclude human factor
2025-09-04T15:28:31.884Z bot:balancer desiredWallet { TMON: 8.33, TMOS: 8.33, TOFZ: 8.33 }
2025-09-04T15:28:31.884Z bot:balancer desiredSum 24.990000000000002
2025-09-04T15:28:31.884Z bot:balancer normalizedDesire {
  TMON: 33.33333333333333,
  TMOS: 33.33333333333333,
  TOFZ: 33.33333333333333
}
2025-09-04T15:28:31.884Z bot:balancer Adding missing instruments from portfolio to DesireWallet with value 0
2025-09-04T15:28:31.884Z bot:balancer RUB not found in desired portfolio, adding with value 0.
2025-09-04T15:28:31.884Z bot:balancer TPAY not found in desired portfolio, adding with value 0.
2025-09-04T15:28:31.884Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:28:31.884Z bot:balancer positionIndex -1
2025-09-04T15:28:31.884Z bot:balancer Ticker from DesireWallet not found in portfolio. Creating.
2025-09-04T15:28:31.886Z bot:balancer {
  figi: 'TCS70A106DL2',
  ticker: 'TMON@',
  classCode: 'SPBRU',
  isin: 'RU000A106DL2',
  lot: 1,
  currency: 'rub',
  klong: { units: 2, nano: 0 },
  kshort: { units: 2, nano: 0 },
  dlong: { units: 0, nano: 66600000 },
  dshort: undefined,
  dlongMin: { units: 0, nano: 50000000 },
  dshortMin: undefined,
  shortEnabledFlag: false,
  name: '–î–µ–Ω–µ–∂–Ω—ã–π —Ä—ã–Ω–æ–∫',
  exchange: 'spb_etf_ru',
  fixedCommission: { units: 1, nano: 0 },
  focusType: 'equity',
  releasedDate: 2022-12-22T00:00:00.000Z,
  numShares: undefined,
  countryOfRisk: 'RU',
  countryOfRiskName: '–†–æ—Å—Å–∏–π—Å–∫–∞—è –§–µ–¥–µ—Ä–∞—Ü–∏—è',
  sector: 'other',
  rebalancingFreq: '',
  tradingStatus: 5,
  otcFlag: false,
  buyAvailableFlag: true,
  sellAvailableFlag: true,
  minPriceIncrement: { units: 0, nano: 10000000 },
  apiTradeAvailableFlag: true,
  uid: '498ec3ff-ef27-4729-9703-a5aac48d5789',
  realExchange: 2,
  positionUid: '96a4604c-79d9-4a30-8a46-95a80dfd9f02',
  assetUid: 'e16bc6c8-63c2-4023-8c95-e0d212aac4b8',
  instrumentExchange: 0,
  forIisFlag: true,
  forQualInvestorFlag: false,
  weekendFlag: false,
  blockedTcaFlag: false,
  liquidityFlag: true,
  first1minCandleDate: 2025-02-25T07:00:00.000Z,
  first1dayCandleDate: 2025-02-25T00:00:00.000Z,
  brand: {
    logoName: 'TMON2.png',
    logoBaseColor: '#000000',
    textColor: '#ffffff'
  },
  dlongClient: { units: 0, nano: 50000000 },
  dshortClient: { units: 0, nano: 0 }
}
2025-09-04T15:28:31.886Z bot:balancer TCS70A106DL2
2025-09-04T15:28:31.886Z bot:balancer 1
2025-09-04T15:28:31.886Z bot:provider Getting last price
2025-09-04T15:28:32.028Z bot:provider lastPriceResult {
  lastPrices: [
    {
      figi: 'TCS70A106DL2',
      price: [Object],
      time: 2025-09-04T15:29:01.189Z,
      instrumentUid: '498ec3ff-ef27-4729-9703-a5aac48d5789',
      lastPriceType: 1
    }
  ]
}
2025-09-04T15:28:32.029Z bot:provider lastPrice { units: 142, nano: 290000000 }
2025-09-04T15:28:37.031Z bot:balancer newPosition {
  pair: 'TMON/RUB',
  base: 'TMON',
  quote: 'RUB',
  figi: 'TCS70A106DL2',
  price: { units: 142, nano: 290000000 },
  priceNumber: 142.29,
  amount: 0,
  lotSize: 1,
  lotPrice: { units: 142, nano: 290000000 }
}
2025-09-04T15:28:37.031Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:28:37.031Z bot:balancer positionIndex 3
2025-09-04T15:28:37.031Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:28:37.032Z bot:balancer positionIndex 2
2025-09-04T15:28:37.032Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:28:37.032Z bot:balancer positionIndex 0
2025-09-04T15:28:37.032Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:28:37.032Z bot:balancer positionIndex 1
2025-09-04T15:28:37.032Z bot:balancer Calculating totalPrice
2025-09-04T15:28:37.032Z bot:balancer walletWithtotalPrice: map start: position {
  pair: 'RUB/RUB',
  base: 'RUB',
  quote: 'RUB',
  figi: undefined,
  amount: 477.96,
  lotSize: 1,
  price: { units: 1, nano: 0 },
  priceNumber: 1,
  lotPrice: { units: 1, nano: 0 }
}
2025-09-04T15:28:37.033Z bot:balancer lotPriceNumber 1
2025-09-04T15:28:37.033Z bot:balancer position.amount, position.priceNumber
2025-09-04T15:28:37.033Z bot:balancer 477.96 1
2025-09-04T15:28:37.033Z bot:balancer totalPriceNumber 477.96
2025-09-04T15:28:37.033Z bot:balancer totalPrice { units: 477, nano: 960000000 }
2025-09-04T15:28:37.033Z bot:balancer walletWithtotalPrice: map end: position {
  pair: 'RUB/RUB',
  base: 'RUB',
  quote: 'RUB',
  figi: undefined,
  amount: 477.96,
  lotSize: 1,
  price: { units: 1, nano: 0 },
  priceNumber: 1,
  lotPrice: { units: 1, nano: 0 },
  totalPrice: { units: 477, nano: 960000000 }
}
2025-09-04T15:28:37.033Z bot:balancer walletWithtotalPrice: map start: position {
  pair: 'TPAY/RUB',
  base: 'TPAY',
  quote: 'RUB',
  figi: 'TCS00A108WX3',
  amount: 2,
  lotSize: 1,
  price: { units: 100, nano: 680000000 },
  priceNumber: 100.68,
  lotPrice: { units: 100, nano: 680000000 },
  totalPrice: { units: 201, nano: 360000000 },
  totalPriceNumber: 201.36,
  averagePositionPriceFifoNumber: 100.68,
  averagePositionPriceNumber: 100.68
}
2025-09-04T15:28:37.033Z bot:balancer lotPriceNumber 100.68
2025-09-04T15:28:37.033Z bot:balancer position.amount, position.priceNumber
2025-09-04T15:28:37.033Z bot:balancer 2 100.68
2025-09-04T15:28:37.033Z bot:balancer totalPriceNumber 201.36
2025-09-04T15:28:37.033Z bot:balancer totalPrice { units: 201, nano: 360000000 }
2025-09-04T15:28:37.033Z bot:balancer walletWithtotalPrice: map end: position {
  pair: 'TPAY/RUB',
  base: 'TPAY',
  quote: 'RUB',
  figi: 'TCS00A108WX3',
  amount: 2,
  lotSize: 1,
  price: { units: 100, nano: 680000000 },
  priceNumber: 100.68,
  lotPrice: { units: 100, nano: 680000000 },
  totalPrice: { units: 201, nano: 360000000 },
  totalPriceNumber: 201.36,
  averagePositionPriceFifoNumber: 100.68,
  averagePositionPriceNumber: 100.68
}
2025-09-04T15:28:37.034Z bot:balancer walletWithtotalPrice: map start: position {
  pair: 'TOFZ@/RUB',
  base: 'TOFZ@',
  quote: 'RUB',
  figi: 'TCS70A10A1L8',
  amount: 10,
  lotSize: 1,
  price: { units: 13, nano: 440000000 },
  priceNumber: 13.45,
  lotPrice: { units: 13, nano: 440000000 },
  totalPrice: { units: 134, nano: 500000000 },
  totalPriceNumber: 134.5,
  averagePositionPriceFifoNumber: 13.44,
  averagePositionPriceNumber: 13.44
}
2025-09-04T15:28:37.034Z bot:balancer lotPriceNumber 13.44
2025-09-04T15:28:37.034Z bot:balancer position.amount, position.priceNumber
2025-09-04T15:28:37.034Z bot:balancer 10 13.45
2025-09-04T15:28:37.034Z bot:balancer totalPriceNumber 134.4
2025-09-04T15:28:37.034Z bot:balancer totalPrice { units: 134, nano: 400000000 }
2025-09-04T15:28:37.034Z bot:balancer walletWithtotalPrice: map end: position {
  pair: 'TOFZ@/RUB',
  base: 'TOFZ@',
  quote: 'RUB',
  figi: 'TCS70A10A1L8',
  amount: 10,
  lotSize: 1,
  price: { units: 13, nano: 440000000 },
  priceNumber: 13.45,
  lotPrice: { units: 13, nano: 440000000 },
  totalPrice: { units: 134, nano: 400000000 },
  totalPriceNumber: 134.5,
  averagePositionPriceFifoNumber: 13.44,
  averagePositionPriceNumber: 13.44
}
2025-09-04T15:28:37.034Z bot:balancer walletWithtotalPrice: map start: position {
  pair: 'TMOS@/RUB',
  base: 'TMOS@',
  quote: 'RUB',
  figi: 'TCS60A101X76',
  amount: 19,
  lotSize: 1,
  price: { units: 6, nano: 650000000 },
  priceNumber: 6.65,
  lotPrice: { units: 6, nano: 650000000 },
  totalPrice: { units: 126, nano: 350000000 },
  totalPriceNumber: 126.35000000000001,
  averagePositionPriceFifoNumber: 6.65,
  averagePositionPriceNumber: 6.65
}
2025-09-04T15:28:37.034Z bot:balancer lotPriceNumber 6.65
2025-09-04T15:28:37.034Z bot:balancer position.amount, position.priceNumber
2025-09-04T15:28:37.034Z bot:balancer 19 6.65
2025-09-04T15:28:37.034Z bot:balancer totalPriceNumber 126.35000000000001
2025-09-04T15:28:37.034Z bot:balancer totalPrice { units: 126, nano: 350000000 }
2025-09-04T15:28:37.034Z bot:balancer walletWithtotalPrice: map end: position {
  pair: 'TMOS@/RUB',
  base: 'TMOS@',
  quote: 'RUB',
  figi: 'TCS60A101X76',
  amount: 19,
  lotSize: 1,
  price: { units: 6, nano: 650000000 },
  priceNumber: 6.65,
  lotPrice: { units: 6, nano: 650000000 },
  totalPrice: { units: 126, nano: 350000000 },
  totalPriceNumber: 126.35000000000001,
  averagePositionPriceFifoNumber: 6.65,
  averagePositionPriceNumber: 6.65
}
2025-09-04T15:28:37.034Z bot:balancer walletWithtotalPrice: map start: position {
  pair: 'TMON/RUB',
  base: 'TMON',
  quote: 'RUB',
  figi: 'TCS70A106DL2',
  price: { units: 142, nano: 290000000 },
  priceNumber: 142.29,
  amount: 0,
  lotSize: 1,
  lotPrice: { units: 142, nano: 290000000 }
}
2025-09-04T15:28:37.035Z bot:balancer lotPriceNumber 142.29
2025-09-04T15:28:37.035Z bot:balancer position.amount, position.priceNumber
2025-09-04T15:28:37.035Z bot:balancer 0 142.29
2025-09-04T15:28:37.035Z bot:balancer walletWithtotalPrice: map end: position {
  pair: 'TMON/RUB',
  base: 'TMON',
  quote: 'RUB',
  figi: 'TCS70A106DL2',
  price: { units: 142, nano: 290000000 },
  priceNumber: 142.29,
  amount: 0,
  lotSize: 1,
  lotPrice: { units: 142, nano: 290000000 }
}
2025-09-04T15:28:37.035Z bot:balancer addNumbersToPosition start
2025-09-04T15:28:37.035Z bot:balancer position.price { units: 1, nano: 0 }
2025-09-04T15:28:37.035Z bot:balancer position.priceNumber 1
2025-09-04T15:28:37.035Z bot:balancer position.lotPrice { units: 1, nano: 0 }
2025-09-04T15:28:37.035Z bot:balancer position.lotPriceNumber 1
2025-09-04T15:28:37.035Z bot:balancer position.totalPrice { units: 477, nano: 960000000 }
2025-09-04T15:28:37.035Z bot:balancer position.totalPriceNumber 477.96
2025-09-04T15:28:37.035Z bot:balancer addNumbersToPosition end {
  pair: 'RUB/RUB',
  base: 'RUB',
  quote: 'RUB',
  figi: undefined,
  amount: 477.96,
  lotSize: 1,
  price: { units: 1, nano: 0 },
  priceNumber: 1,
  lotPrice: { units: 1, nano: 0 },
  totalPrice: { units: 477, nano: 960000000 },
  lotPriceNumber: 1,
  totalPriceNumber: 477.96
}
2025-09-04T15:28:37.035Z bot:balancer addNumbersToPosition start
2025-09-04T15:28:37.035Z bot:balancer position.price { units: 100, nano: 680000000 }
2025-09-04T15:28:37.035Z bot:balancer position.priceNumber 100.68
2025-09-04T15:28:37.035Z bot:balancer position.lotPrice { units: 100, nano: 680000000 }
2025-09-04T15:28:37.035Z bot:balancer position.lotPriceNumber 100.68
2025-09-04T15:28:37.035Z bot:balancer position.totalPrice { units: 201, nano: 360000000 }
2025-09-04T15:28:37.035Z bot:balancer position.totalPriceNumber 201.36
2025-09-04T15:28:37.035Z bot:balancer addNumbersToPosition end {
  pair: 'TPAY/RUB',
  base: 'TPAY',
  quote: 'RUB',
  figi: 'TCS00A108WX3',
  amount: 2,
  lotSize: 1,
  price: { units: 100, nano: 680000000 },
  priceNumber: 100.68,
  lotPrice: { units: 100, nano: 680000000 },
  totalPrice: { units: 201, nano: 360000000 },
  totalPriceNumber: 201.36,
  averagePositionPriceFifoNumber: 100.68,
  averagePositionPriceNumber: 100.68,
  lotPriceNumber: 100.68
}
2025-09-04T15:28:37.035Z bot:balancer addNumbersToPosition start
2025-09-04T15:28:37.035Z bot:balancer position.price { units: 13, nano: 440000000 }
2025-09-04T15:28:37.035Z bot:balancer position.priceNumber 13.44
2025-09-04T15:28:37.035Z bot:balancer position.lotPrice { units: 13, nano: 440000000 }
2025-09-04T15:28:37.036Z bot:balancer position.lotPriceNumber 13.44
2025-09-04T15:28:37.036Z bot:balancer position.totalPrice { units: 134, nano: 400000000 }
2025-09-04T15:28:37.036Z bot:balancer position.totalPriceNumber 134.4
2025-09-04T15:28:37.036Z bot:balancer addNumbersToPosition end {
  pair: 'TOFZ@/RUB',
  base: 'TOFZ@',
  quote: 'RUB',
  figi: 'TCS70A10A1L8',
  amount: 10,
  lotSize: 1,
  price: { units: 13, nano: 440000000 },
  priceNumber: 13.44,
  lotPrice: { units: 13, nano: 440000000 },
  totalPrice: { units: 134, nano: 400000000 },
  totalPriceNumber: 134.4,
  averagePositionPriceFifoNumber: 13.44,
  averagePositionPriceNumber: 13.44,
  lotPriceNumber: 13.44
}
2025-09-04T15:28:37.036Z bot:balancer addNumbersToPosition start
2025-09-04T15:28:37.036Z bot:balancer position.price { units: 6, nano: 650000000 }
2025-09-04T15:28:37.036Z bot:balancer position.priceNumber 6.65
2025-09-04T15:28:37.036Z bot:balancer position.lotPrice { units: 6, nano: 650000000 }
2025-09-04T15:28:37.036Z bot:balancer position.lotPriceNumber 6.65
2025-09-04T15:28:37.036Z bot:balancer position.totalPrice { units: 126, nano: 350000000 }
2025-09-04T15:28:37.036Z bot:balancer position.totalPriceNumber 126.35
2025-09-04T15:28:37.036Z bot:balancer addNumbersToPosition end {
  pair: 'TMOS@/RUB',
  base: 'TMOS@',
  quote: 'RUB',
  figi: 'TCS60A101X76',
  amount: 19,
  lotSize: 1,
  price: { units: 6, nano: 650000000 },
  priceNumber: 6.65,
  lotPrice: { units: 6, nano: 650000000 },
  totalPrice: { units: 126, nano: 350000000 },
  totalPriceNumber: 126.35,
  averagePositionPriceFifoNumber: 6.65,
  averagePositionPriceNumber: 6.65,
  lotPriceNumber: 6.65
}
2025-09-04T15:28:37.036Z bot:balancer addNumbersToPosition start
2025-09-04T15:28:37.036Z bot:balancer position.price { units: 142, nano: 290000000 }
2025-09-04T15:28:37.036Z bot:balancer position.priceNumber 142.29
2025-09-04T15:28:37.036Z bot:balancer position.lotPrice { units: 142, nano: 290000000 }
2025-09-04T15:28:37.036Z bot:balancer position.lotPriceNumber 142.29
2025-09-04T15:28:37.036Z bot:balancer position.totalPrice undefined
2025-09-04T15:28:37.036Z bot:balancer addNumbersToPosition end {
  pair: 'TMON/RUB',
  base: 'TMON',
  quote: 'RUB',
  figi: 'TCS70A106DL2',
  price: { units: 142, nano: 290000000 },
  priceNumber: 142.29,
  amount: 0,
  lotSize: 1,
  lotPrice: { units: 142, nano: 290000000 },
  lotPriceNumber: 142.29
}
2025-09-04T15:28:37.036Z bot:balancer addNumbersToWallet [
  {
    pair: 'RUB/RUB',
    base: 'RUB',
    quote: 'RUB',
    figi: undefined,
    amount: 477.96,
    lotSize: 1,
    price: { units: 1, nano: 0 },
    priceNumber: 1,
    lotPrice: { units: 1, nano: 0 },
    totalPrice: { units: 477, nano: 960000000 },
    lotPriceNumber: 1,
    totalPriceNumber: 477.96
  },
  {
    pair: 'TPAY/RUB',
    base: 'TPAY',
    quote: 'RUB',
    figi: 'TCS00A108WX3',
    amount: 2,
    lotSize: 1,
    price: { units: 100, nano: 680000000 },
    priceNumber: 100.68,
    lotPrice: { units: 100, nano: 680000000 },
    totalPrice: { units: 201, nano: 360000000 },
    totalPriceNumber: 201.36,
    averagePositionPriceFifoNumber: 100.68,
    averagePositionPriceNumber: 100.68,
    lotPriceNumber: 100.68
  },
  {
    pair: 'TOFZ@/RUB',
    base: 'TOFZ@',
    quote: 'RUB',
    figi: 'TCS70A10A1L8',
    amount: 10,
    lotSize: 1,
    price: { units: 13, nano: 440000000 },
    priceNumber: 13.44,
    lotPrice: { units: 13, nano: 440000000 },
    totalPrice: { units: 134, nano: 400000000 },
    totalPriceNumber: 134.4,
    averagePositionPriceFifoNumber: 13.44,
    averagePositionPriceNumber: 13.44,
    lotPriceNumber: 13.44
  },
  {
    pair: 'TMOS@/RUB',
    base: 'TMOS@',
    quote: 'RUB',
    figi: 'TCS60A101X76',
    amount: 19,
    lotSize: 1,
    price: { units: 6, nano: 650000000 },
    priceNumber: 6.65,
    lotPrice: { units: 6, nano: 650000000 },
    totalPrice: { units: 126, nano: 350000000 },
    totalPriceNumber: 126.35,
    averagePositionPriceFifoNumber: 6.65,
    averagePositionPriceNumber: 6.65,
    lotPriceNumber: 6.65
  },
  {
    pair: 'TMON/RUB',
    base: 'TMON',
    quote: 'RUB',
    figi: 'TCS70A106DL2',
    price: { units: 142, nano: 290000000 },
    priceNumber: 142.29,
    amount: 0,
    lotSize: 1,
    lotPrice: { units: 142, nano: 290000000 },
    lotPriceNumber: 142.29
  }
]
2025-09-04T15:28:37.037Z bot:balancer addNumbersToWallet [Function: addNumbersToWallet]
2025-09-04T15:28:37.038Z bot:balancer sortedWallet [
  {
    pair: 'TMON/RUB',
    base: 'TMON',
    quote: 'RUB',
    figi: 'TCS70A106DL2',
    price: { units: 142, nano: 290000000 },
    priceNumber: 142.29,
    amount: 0,
    lotSize: 1,
    lotPrice: { units: 142, nano: 290000000 },
    lotPriceNumber: 142.29
  },
  {
    pair: 'TPAY/RUB',
    base: 'TPAY',
    quote: 'RUB',
    figi: 'TCS00A108WX3',
    amount: 2,
    lotSize: 1,
    price: { units: 100, nano: 680000000 },
    priceNumber: 100.68,
    lotPrice: { units: 100, nano: 680000000 },
    totalPrice: { units: 201, nano: 360000000 },
    totalPriceNumber: 201.36,
    averagePositionPriceFifoNumber: 100.68,
    averagePositionPriceNumber: 100.68,
    lotPriceNumber: 100.68
  },
  {
    pair: 'TOFZ@/RUB',
    base: 'TOFZ@',
    quote: 'RUB',
    figi: 'TCS70A10A1L8',
    amount: 10,
    lotSize: 1,
    price: { units: 13, nano: 440000000 },
    priceNumber: 13.44,
    lotPrice: { units: 13, nano: 440000000 },
    totalPrice: { units: 134, nano: 400000000 },
    totalPriceNumber: 134.4,
    averagePositionPriceFifoNumber: 13.44,
    averagePositionPriceNumber: 13.44,
    lotPriceNumber: 13.44
  },
  {
    pair: 'TMOS@/RUB',
    base: 'TMOS@',
    quote: 'RUB',
    figi: 'TCS60A101X76',
    amount: 19,
    lotSize: 1,
    price: { units: 6, nano: 650000000 },
    priceNumber: 6.65,
    lotPrice: { units: 6, nano: 650000000 },
    totalPrice: { units: 126, nano: 350000000 },
    totalPriceNumber: 126.35,
    averagePositionPriceFifoNumber: 6.65,
    averagePositionPriceNumber: 6.65,
    lotPriceNumber: 6.65
  },
  {
    pair: 'RUB/RUB',
    base: 'RUB',
    quote: 'RUB',
    figi: undefined,
    amount: 477.96,
    lotSize: 1,
    price: { units: 1, nano: 0 },
    priceNumber: 1,
    lotPrice: { units: 1, nano: 0 },
    totalPrice: { units: 477, nano: 960000000 },
    lotPriceNumber: 1,
    totalPriceNumber: 477.96
  }
]
2025-09-04T15:28:37.039Z bot:balancer Summing up all positions in portfolio
2025-09-04T15:28:37.039Z bot:balancer [
  {
    pair: 'TMON/RUB',
    base: 'TMON',
    quote: 'RUB',
    figi: 'TCS70A106DL2',
    price: { units: 142, nano: 290000000 },
    priceNumber: 142.29,
    amount: 0,
    lotSize: 1,
    lotPrice: { units: 142, nano: 290000000 },
    lotPriceNumber: 142.29
  },
  {
    pair: 'TPAY/RUB',
    base: 'TPAY',
    quote: 'RUB',
    figi: 'TCS00A108WX3',
    amount: 2,
    lotSize: 1,
    price: { units: 100, nano: 680000000 },
    priceNumber: 100.68,
    lotPrice: { units: 100, nano: 680000000 },
    totalPrice: { units: 201, nano: 360000000 },
    totalPriceNumber: 201.36,
    averagePositionPriceFifoNumber: 100.68,
    averagePositionPriceNumber: 100.68,
    lotPriceNumber: 100.68
  },
  {
    pair: 'TOFZ@/RUB',
    base: 'TOFZ@',
    quote: 'RUB',
    figi: 'TCS70A10A1L8',
    amount: 10,
    lotSize: 1,
    price: { units: 13, nano: 440000000 },
    priceNumber: 13.44,
    lotPrice: { units: 13, nano: 440000000 },
    totalPrice: { units: 134, nano: 400000000 },
    totalPriceNumber: 134.4,
    averagePositionPriceFifoNumber: 13.44,
    averagePositionPriceNumber: 13.44,
    lotPriceNumber: 13.44
  },
  {
    pair: 'TMOS@/RUB',
    base: 'TMOS@',
    quote: 'RUB',
    figi: 'TCS60A101X76',
    amount: 19,
    lotSize: 1,
    price: { units: 6, nano: 650000000 },
    priceNumber: 6.65,
    lotPrice: { units: 6, nano: 650000000 },
    totalPrice: { units: 126, nano: 350000000 },
    totalPriceNumber: 126.35,
    averagePositionPriceFifoNumber: 6.65,
    averagePositionPriceNumber: 6.65,
    lotPriceNumber: 6.65
  },
  {
    pair: 'RUB/RUB',
    base: 'RUB',
    quote: 'RUB',
    figi: undefined,
    amount: 477.96,
    lotSize: 1,
    price: { units: 1, nano: 0 },
    priceNumber: 1,
    lotPrice: { units: 1, nano: 0 },
    totalPrice: { units: 477, nano: 960000000 },
    lotPriceNumber: 1,
    totalPriceNumber: 477.96
  }
]
2025-09-04T15:28:37.039Z bot:balancer walletSumNumber 940.0699999999999
2025-09-04T15:28:37.040Z bot:balancer Optimal position sizes: {
  TMON: {
    baseSize: 313.3566666666666,
    marginSize: 626.7133333333331,
    totalSize: 940.0699999999997
  },
  TMOS: {
    baseSize: 313.3566666666666,
    marginSize: 626.7133333333331,
    totalSize: 940.0699999999997
  },
  TOFZ: {
    baseSize: 313.3566666666666,
    marginSize: 626.7133333333331,
    totalSize: 940.0699999999997
  },
  RUB: { baseSize: 0, marginSize: 0, totalSize: 0 },
  TPAY: { baseSize: 0, marginSize: 0, totalSize: 0 }
}
2025-09-04T15:28:37.040Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:28:37.040Z bot:balancer positionIndex 0
2025-09-04T15:28:37.040Z bot:balancer position {
  pair: 'TMON/RUB',
  base: 'TMON',
  quote: 'RUB',
  figi: 'TCS70A106DL2',
  price: { units: 142, nano: 290000000 },
  priceNumber: 142.29,
  amount: 0,
  lotSize: 1,
  lotPrice: { units: 142, nano: 290000000 },
  lotPriceNumber: 142.29
}
2025-09-04T15:28:37.040Z bot:balancer Calculating how many rubles the desired share will be with multiplier
2025-09-04T15:28:37.040Z bot:balancer walletSumNumber 940.0699999999999
2025-09-04T15:28:37.040Z bot:balancer desiredPercent 33.33333333333333
2025-09-04T15:28:37.040Z bot:balancer desiredAmountNumber (considering multiplier) 940.0699999999997
2025-09-04T15:28:37.040Z bot:balancer Calculating how many lots can be bought before desired target
2025-09-04T15:28:37.040Z bot:balancer canBuyBeforeTargetLots 6
2025-09-04T15:28:37.040Z bot:balancer Calculating cost of position that can be bought before desired target
2025-09-04T15:28:37.040Z bot:balancer canBuyBeforeTargetNumber 853.74
2025-09-04T15:28:37.040Z bot:balancer Calculating difference between desired value and value before target. Unallocated remainder.
2025-09-04T15:28:37.040Z bot:balancer beforeDiffNumber 86.3299999999997
2025-09-04T15:28:37.040Z bot:balancer Summing up remainders
2025-09-04T15:28:37.040Z bot:balancer How much to buy (can be negative, then need to sell)
2025-09-04T15:28:37.040Z bot:balancer How many lots to buy (can be negative, then need to sell)
2025-09-04T15:28:37.040Z bot:balancer New position with positive target: setting toBuyLots to minimum 1 TMON
2025-09-04T15:28:37.040Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:28:37.040Z bot:balancer positionIndex 3
2025-09-04T15:28:37.040Z bot:balancer position {
  pair: 'TMOS@/RUB',
  base: 'TMOS@',
  quote: 'RUB',
  figi: 'TCS60A101X76',
  amount: 19,
  lotSize: 1,
  price: { units: 6, nano: 650000000 },
  priceNumber: 6.65,
  lotPrice: { units: 6, nano: 650000000 },
  totalPrice: { units: 126, nano: 350000000 },
  totalPriceNumber: 126.35,
  averagePositionPriceFifoNumber: 6.65,
  averagePositionPriceNumber: 6.65,
  lotPriceNumber: 6.65
}
2025-09-04T15:28:37.040Z bot:balancer Calculating how many rubles the desired share will be with multiplier
2025-09-04T15:28:37.040Z bot:balancer walletSumNumber 940.0699999999999
2025-09-04T15:28:37.040Z bot:balancer desiredPercent 33.33333333333333
2025-09-04T15:28:37.040Z bot:balancer desiredAmountNumber (considering multiplier) 940.0699999999997
2025-09-04T15:28:37.041Z bot:balancer Calculating how many lots can be bought before desired target
2025-09-04T15:28:37.041Z bot:balancer canBuyBeforeTargetLots 141
2025-09-04T15:28:37.041Z bot:balancer Calculating cost of position that can be bought before desired target
2025-09-04T15:28:37.041Z bot:balancer canBuyBeforeTargetNumber 937.6500000000001
2025-09-04T15:28:37.041Z bot:balancer Calculating difference between desired value and value before target. Unallocated remainder.
2025-09-04T15:28:37.041Z bot:balancer beforeDiffNumber 2.419999999999618
2025-09-04T15:28:37.041Z bot:balancer Summing up remainders
2025-09-04T15:28:37.041Z bot:balancer How much to buy (can be negative, then need to sell)
2025-09-04T15:28:37.041Z bot:balancer toBuyNumber 811.3000000000001
2025-09-04T15:28:37.041Z bot:balancer How many lots to buy (can be negative, then need to sell)
2025-09-04T15:28:37.041Z bot:balancer toBuyLots 122
2025-09-04T15:28:37.041Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:28:37.041Z bot:balancer positionIndex 2
2025-09-04T15:28:37.041Z bot:balancer position {
  pair: 'TOFZ@/RUB',
  base: 'TOFZ@',
  quote: 'RUB',
  figi: 'TCS70A10A1L8',
  amount: 10,
  lotSize: 1,
  price: { units: 13, nano: 440000000 },
  priceNumber: 13.44,
  lotPrice: { units: 13, nano: 440000000 },
  totalPrice: { units: 134, nano: 400000000 },
  totalPriceNumber: 134.4,
  averagePositionPriceFifoNumber: 13.44,
  averagePositionPriceNumber: 13.44,
  lotPriceNumber: 13.44
}
2025-09-04T15:28:37.041Z bot:balancer Calculating how many rubles the desired share will be with multiplier
2025-09-04T15:28:37.041Z bot:balancer walletSumNumber 940.0699999999999
2025-09-04T15:28:37.041Z bot:balancer desiredPercent 33.33333333333333
2025-09-04T15:28:37.041Z bot:balancer desiredAmountNumber (considering multiplier) 940.0699999999997
2025-09-04T15:28:37.041Z bot:balancer Calculating how many lots can be bought before desired target
2025-09-04T15:28:37.041Z bot:balancer canBuyBeforeTargetLots 69
2025-09-04T15:28:37.041Z bot:balancer Calculating cost of position that can be bought before desired target
2025-09-04T15:28:37.041Z bot:balancer canBuyBeforeTargetNumber 927.36
2025-09-04T15:28:37.041Z bot:balancer Calculating difference between desired value and value before target. Unallocated remainder.
2025-09-04T15:28:37.041Z bot:balancer beforeDiffNumber 12.709999999999695
2025-09-04T15:28:37.041Z bot:balancer Summing up remainders
2025-09-04T15:28:37.041Z bot:balancer How much to buy (can be negative, then need to sell)
2025-09-04T15:28:37.041Z bot:balancer toBuyNumber 792.96
2025-09-04T15:28:37.041Z bot:balancer How many lots to buy (can be negative, then need to sell)
2025-09-04T15:28:37.041Z bot:balancer toBuyLots 59
2025-09-04T15:28:37.041Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:28:37.041Z bot:balancer positionIndex 4
2025-09-04T15:28:37.041Z bot:balancer position {
  pair: 'RUB/RUB',
  base: 'RUB',
  quote: 'RUB',
  figi: undefined,
  amount: 477.96,
  lotSize: 1,
  price: { units: 1, nano: 0 },
  priceNumber: 1,
  lotPrice: { units: 1, nano: 0 },
  totalPrice: { units: 477, nano: 960000000 },
  lotPriceNumber: 1,
  totalPriceNumber: 477.96
}
2025-09-04T15:28:37.041Z bot:balancer Calculating how many rubles the desired share will be with multiplier
2025-09-04T15:28:37.041Z bot:balancer walletSumNumber 940.0699999999999
2025-09-04T15:28:37.041Z bot:balancer desiredPercent 0
2025-09-04T15:28:37.041Z bot:balancer desiredAmountNumber (considering multiplier) 0
2025-09-04T15:28:37.041Z bot:balancer Calculating how many lots can be bought before desired target
2025-09-04T15:28:37.041Z bot:balancer canBuyBeforeTargetLots 0
2025-09-04T15:28:37.041Z bot:balancer Calculating cost of position that can be bought before desired target
2025-09-04T15:28:37.041Z bot:balancer canBuyBeforeTargetNumber 0
2025-09-04T15:28:37.041Z bot:balancer Calculating difference between desired value and value before target. Unallocated remainder.
2025-09-04T15:28:37.041Z bot:balancer beforeDiffNumber 0
2025-09-04T15:28:37.041Z bot:balancer Summing up remainders
2025-09-04T15:28:37.041Z bot:balancer How much to buy (can be negative, then need to sell)
2025-09-04T15:28:37.041Z bot:balancer toBuyNumber -477.96
2025-09-04T15:28:37.041Z bot:balancer How many lots to buy (can be negative, then need to sell)
2025-09-04T15:28:37.041Z bot:balancer toBuyLots -477.96
2025-09-04T15:28:37.042Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:28:37.042Z bot:balancer positionIndex 1
2025-09-04T15:28:37.042Z bot:balancer position {
  pair: 'TPAY/RUB',
  base: 'TPAY',
  quote: 'RUB',
  figi: 'TCS00A108WX3',
  amount: 2,
  lotSize: 1,
  price: { units: 100, nano: 680000000 },
  priceNumber: 100.68,
  lotPrice: { units: 100, nano: 680000000 },
  totalPrice: { units: 201, nano: 360000000 },
  totalPriceNumber: 201.36,
  averagePositionPriceFifoNumber: 100.68,
  averagePositionPriceNumber: 100.68,
  lotPriceNumber: 100.68
}
2025-09-04T15:28:37.042Z bot:balancer Calculating how many rubles the desired share will be with multiplier
2025-09-04T15:28:37.042Z bot:balancer walletSumNumber 940.0699999999999
2025-09-04T15:28:37.042Z bot:balancer desiredPercent 0
2025-09-04T15:28:37.042Z bot:balancer desiredAmountNumber (considering multiplier) 0
2025-09-04T15:28:37.042Z bot:balancer Calculating how many lots can be bought before desired target
2025-09-04T15:28:37.042Z bot:balancer canBuyBeforeTargetLots 0
2025-09-04T15:28:37.042Z bot:balancer Calculating cost of position that can be bought before desired target
2025-09-04T15:28:37.042Z bot:balancer canBuyBeforeTargetNumber 0
2025-09-04T15:28:37.042Z bot:balancer Calculating difference between desired value and value before target. Unallocated remainder.
2025-09-04T15:28:37.042Z bot:balancer beforeDiffNumber 0
2025-09-04T15:28:37.042Z bot:balancer Summing up remainders
2025-09-04T15:28:37.042Z bot:balancer How much to buy (can be negative, then need to sell)
2025-09-04T15:28:37.042Z bot:balancer toBuyNumber -201.36
2025-09-04T15:28:37.042Z bot:balancer How many lots to buy (can be negative, then need to sell)
2025-09-04T15:28:37.042Z bot:balancer toBuyLots -2
2025-09-04T15:28:37.042Z bot:balancer Processing buy_requires_total_marginal_sell configuration
2025-09-04T15:28:37.043Z bot:balancer Identifying positions for selling using mode: equal_in_percents
2025-09-04T15:28:37.043Z bot:balancer Found position for proportional selling: TPAY with value 201.36 RUB
2025-09-04T15:28:37.043Z bot:balancer Found position for proportional selling: TOFZ@ with value 134.40 RUB
2025-09-04T15:28:37.043Z bot:balancer Found position for proportional selling: TMOS@ with value 126.35 RUB
2025-09-04T15:28:37.043Z bot:balancer Found 3 positions available for selling in mode: equal_in_percents
2025-09-04T15:28:37.043Z bot:balancer Calculating required funds for non-margin instrument purchases
2025-09-04T15:28:37.043Z bot:balancer Threshold for TMON: 0.94 RUB (portfolio value: 940.07 RUB, min_percent: 0.1%)
2025-09-04T15:28:37.043Z bot:balancer Need to buy TMON: 853.74 RUB (threshold: 0.94 RUB)
2025-09-04T15:28:37.044Z bot:balancer üîç CALCULATE SELLING DEBUG:
2025-09-04T15:28:37.044Z bot:balancer    Current RUB balance: 477.96 RUB
2025-09-04T15:28:37.044Z bot:balancer    Required funds: { TMON: 853.74 }
2025-09-04T15:28:37.045Z bot:balancer    Sellable positions count: 3
2025-09-04T15:28:37.045Z bot:balancer    Mode: equal_in_percents
2025-09-04T15:28:37.045Z bot:balancer Calculating selling amounts using mode: equal_in_percents
2025-09-04T15:28:37.045Z bot:balancer üîç CALCULATE SELLING AMOUNTS INTERNAL:
2025-09-04T15:28:37.045Z bot:balancer    Current RUB balance: 477.96 RUB
2025-09-04T15:28:37.045Z bot:balancer    Funds needed for purchases: 853.74 RUB
2025-09-04T15:28:37.045Z bot:balancer    Total funds needed to sell: 375.78 RUB
2025-09-04T15:28:37.045Z bot:balancer    Profitable positions available: 3
2025-09-04T15:28:37.045Z bot:balancer      1. TPAY: 201.36 RUB (2 lots √ó 100.68)
2025-09-04T15:28:37.045Z bot:balancer      2. TOFZ@: 134.40 RUB (10 lots √ó 13.44)
2025-09-04T15:28:37.045Z bot:balancer      3. TMOS@: 126.35 RUB (19 lots √ó 6.65)
2025-09-04T15:28:37.045Z bot:balancer    Total funds available from profitable positions: 462.11 RUB
2025-09-04T15:28:37.045Z bot:balancer Planning to sell 1 lots of TPAY for 100.68 RUB (proportional)
2025-09-04T15:28:37.045Z bot:balancer Planning to sell 8 lots of TOFZ@ for 107.52 RUB (proportional)
2025-09-04T15:28:37.045Z bot:balancer Planning to sell 15 lots of TMOS@ for 99.75 RUB (proportional)
2025-09-04T15:28:37.045Z bot:balancer Funds still needed after selling: 67.83 RUB
2025-09-04T15:28:37.045Z bot:balancer ‚úÖ Special selling plan calculated: {
  TPAY: {
    position: {
      pair: 'TPAY/RUB',
      base: 'TPAY',
      quote: 'RUB',
      figi: 'TCS00A108WX3',
      amount: 2,
      lotSize: 1,
      price: [Object],
      priceNumber: 100.68,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 201.36,
      averagePositionPriceFifoNumber: 100.68,
      averagePositionPriceNumber: 100.68,
      lotPriceNumber: 100.68,
      desiredAmountNumber: 0,
      canBuyBeforeTargetLots: 0,
      canBuyBeforeTargetNumber: 0,
      beforeDiffNumber: 0,
      toBuyNumber: -201.36,
      toBuyLots: -2
    },
    sellAmount: 100.68,
    sellLots: 1
  },
  'TOFZ@': {
    position: {
      pair: 'TOFZ@/RUB',
      base: 'TOFZ@',
      quote: 'RUB',
      figi: 'TCS70A10A1L8',
      amount: 10,
      lotSize: 1,
      price: [Object],
      priceNumber: 13.44,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 134.4,
      averagePositionPriceFifoNumber: 13.44,
      averagePositionPriceNumber: 13.44,
      lotPriceNumber: 13.44,
      desiredAmountNumber: 940.0699999999997,
      canBuyBeforeTargetLots: 69,
      canBuyBeforeTargetNumber: 927.36,
      beforeDiffNumber: 12.709999999999695,
      toBuyNumber: 792.96,
      toBuyLots: 59
    },
    sellAmount: 107.52,
    sellLots: 8
  },
  'TMOS@': {
    position: {
      pair: 'TMOS@/RUB',
      base: 'TMOS@',
      quote: 'RUB',
      figi: 'TCS60A101X76',
      amount: 19,
      lotSize: 1,
      price: [Object],
      priceNumber: 6.65,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 126.35,
      averagePositionPriceFifoNumber: 6.65,
      averagePositionPriceNumber: 6.65,
      lotPriceNumber: 6.65,
      desiredAmountNumber: 940.0699999999997,
      canBuyBeforeTargetLots: 141,
      canBuyBeforeTargetNumber: 937.6500000000001,
      beforeDiffNumber: 2.419999999999618,
      toBuyNumber: 811.3000000000001,
      toBuyLots: 122
    },
    sellAmount: 99.75,
    sellLots: 15
  }
}
2025-09-04T15:28:37.045Z bot:balancer ‚ö†Ô∏è  PARTIAL FUNDS WARNING:
2025-09-04T15:28:37.045Z bot:balancer    Funds needed: 375.78 RUB
2025-09-04T15:28:37.045Z bot:balancer    Funds from selling: 307.95 RUB
2025-09-04T15:28:37.045Z bot:balancer    Shortfall: 67.83 RUB (18.1%)
2025-09-04T15:28:37.045Z bot:balancer üìà PROCEEDING: Shortfall acceptable (<50%), executing partial funding strategy
2025-09-04T15:28:37.045Z bot:balancer Adjusted selling plan for TPAY: 1 lots, 100.68 RUB
2025-09-04T15:28:37.046Z bot:balancer Adjusted selling plan for TOFZ@: 8 lots, 107.52 RUB
2025-09-04T15:28:37.046Z bot:balancer Adjusted selling plan for TMOS@: 15 lots, 99.75 RUB
2025-09-04T15:28:37.046Z bot:balancer sortedWallet [
  {
    pair: 'TMON/RUB',
    base: 'TMON',
    quote: 'RUB',
    figi: 'TCS70A106DL2',
    price: { units: 142, nano: 290000000 },
    priceNumber: 142.29,
    amount: 0,
    lotSize: 1,
    lotPrice: { units: 142, nano: 290000000 },
    lotPriceNumber: 142.29,
    desiredAmountNumber: 940.0699999999997,
    canBuyBeforeTargetLots: 6,
    canBuyBeforeTargetNumber: 853.74,
    beforeDiffNumber: 86.3299999999997,
    toBuyLots: 6,
    toBuyNumber: 853.74
  },
  {
    pair: 'TPAY/RUB',
    base: 'TPAY',
    quote: 'RUB',
    figi: 'TCS00A108WX3',
    amount: 2,
    lotSize: 1,
    price: { units: 100, nano: 680000000 },
    priceNumber: 100.68,
    lotPrice: { units: 100, nano: 680000000 },
    totalPrice: { units: 201, nano: 360000000 },
    totalPriceNumber: 201.36,
    averagePositionPriceFifoNumber: 100.68,
    averagePositionPriceNumber: 100.68,
    lotPriceNumber: 100.68,
    desiredAmountNumber: 0,
    canBuyBeforeTargetLots: 0,
    canBuyBeforeTargetNumber: 0,
    beforeDiffNumber: 0,
    toBuyNumber: -302.04,
    toBuyLots: -3
  },
  {
    pair: 'TOFZ@/RUB',
    base: 'TOFZ@',
    quote: 'RUB',
    figi: 'TCS70A10A1L8',
    amount: 10,
    lotSize: 1,
    price: { units: 13, nano: 440000000 },
    priceNumber: 13.44,
    lotPrice: { units: 13, nano: 440000000 },
    totalPrice: { units: 134, nano: 400000000 },
    totalPriceNumber: 134.4,
    averagePositionPriceFifoNumber: 13.44,
    averagePositionPriceNumber: 13.44,
    lotPriceNumber: 13.44,
    desiredAmountNumber: 940.0699999999997,
    canBuyBeforeTargetLots: 69,
    canBuyBeforeTargetNumber: 927.36,
    beforeDiffNumber: 12.709999999999695,
    toBuyNumber: 685.44,
    toBuyLots: 51
  },
  {
    pair: 'TMOS@/RUB',
    base: 'TMOS@',
    quote: 'RUB',
    figi: 'TCS60A101X76',
    amount: 19,
    lotSize: 1,
    price: { units: 6, nano: 650000000 },
    priceNumber: 6.65,
    lotPrice: { units: 6, nano: 650000000 },
    totalPrice: { units: 126, nano: 350000000 },
    totalPriceNumber: 126.35,
    averagePositionPriceFifoNumber: 6.65,
    averagePositionPriceNumber: 6.65,
    lotPriceNumber: 6.65,
    desiredAmountNumber: 940.0699999999997,
    canBuyBeforeTargetLots: 141,
    canBuyBeforeTargetNumber: 937.6500000000001,
    beforeDiffNumber: 2.419999999999618,
    toBuyNumber: 711.5500000000001,
    toBuyLots: 107
  },
  {
    pair: 'RUB/RUB',
    base: 'RUB',
    quote: 'RUB',
    figi: undefined,
    amount: 477.96,
    lotSize: 1,
    price: { units: 1, nano: 0 },
    priceNumber: 1,
    lotPrice: { units: 1, nano: 0 },
    totalPrice: { units: 477, nano: 960000000 },
    lotPriceNumber: 1,
    totalPriceNumber: 477.96,
    desiredAmountNumber: 0,
    canBuyBeforeTargetLots: 0,
    canBuyBeforeTargetNumber: 0,
    beforeDiffNumber: 0,
    toBuyNumber: -477.96,
    toBuyLots: -477.96
  }
]
2025-09-04T15:28:37.046Z bot:balancer specialSellingPlan {
  TPAY: {
    position: {
      pair: 'TPAY/RUB',
      base: 'TPAY',
      quote: 'RUB',
      figi: 'TCS00A108WX3',
      amount: 2,
      lotSize: 1,
      price: [Object],
      priceNumber: 100.68,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 201.36,
      averagePositionPriceFifoNumber: 100.68,
      averagePositionPriceNumber: 100.68,
      lotPriceNumber: 100.68,
      desiredAmountNumber: 0,
      canBuyBeforeTargetLots: 0,
      canBuyBeforeTargetNumber: 0,
      beforeDiffNumber: 0,
      toBuyNumber: -302.04,
      toBuyLots: -3
    },
    sellAmount: 100.68,
    sellLots: 1
  },
  'TOFZ@': {
    position: {
      pair: 'TOFZ@/RUB',
      base: 'TOFZ@',
      quote: 'RUB',
      figi: 'TCS70A10A1L8',
      amount: 10,
      lotSize: 1,
      price: [Object],
      priceNumber: 13.44,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 134.4,
      averagePositionPriceFifoNumber: 13.44,
      averagePositionPriceNumber: 13.44,
      lotPriceNumber: 13.44,
      desiredAmountNumber: 940.0699999999997,
      canBuyBeforeTargetLots: 69,
      canBuyBeforeTargetNumber: 927.36,
      beforeDiffNumber: 12.709999999999695,
      toBuyNumber: 685.44,
      toBuyLots: 51
    },
    sellAmount: 107.52,
    sellLots: 8
  },
  'TMOS@': {
    position: {
      pair: 'TMOS@/RUB',
      base: 'TMOS@',
      quote: 'RUB',
      figi: 'TCS60A101X76',
      amount: 19,
      lotSize: 1,
      price: [Object],
      priceNumber: 6.65,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 126.35,
      averagePositionPriceFifoNumber: 6.65,
      averagePositionPriceNumber: 6.65,
      lotPriceNumber: 6.65,
      desiredAmountNumber: 940.0699999999997,
      canBuyBeforeTargetLots: 141,
      canBuyBeforeTargetNumber: 937.6500000000001,
      beforeDiffNumber: 2.419999999999618,
      toBuyNumber: 711.5500000000001,
      toBuyLots: 107
    },
    sellAmount: 99.75,
    sellLots: 15
  }
}
2025-09-04T15:28:37.047Z bot:balancer ordersPlanned [
  {
    pair: 'TPAY/RUB',
    base: 'TPAY',
    quote: 'RUB',
    figi: 'TCS00A108WX3',
    amount: 2,
    lotSize: 1,
    price: { units: 100, nano: 680000000 },
    priceNumber: 100.68,
    lotPrice: { units: 100, nano: 680000000 },
    totalPrice: { units: 201, nano: 360000000 },
    totalPriceNumber: 201.36,
    averagePositionPriceFifoNumber: 100.68,
    averagePositionPriceNumber: 100.68,
    lotPriceNumber: 100.68,
    desiredAmountNumber: 0,
    canBuyBeforeTargetLots: 0,
    canBuyBeforeTargetNumber: 0,
    beforeDiffNumber: 0,
    toBuyNumber: -302.04,
    toBuyLots: -3
  },
  {
    pair: 'TMON/RUB',
    base: 'TMON',
    quote: 'RUB',
    figi: 'TCS70A106DL2',
    price: { units: 142, nano: 290000000 },
    priceNumber: 142.29,
    amount: 0,
    lotSize: 1,
    lotPrice: { units: 142, nano: 290000000 },
    lotPriceNumber: 142.29,
    desiredAmountNumber: 940.0699999999997,
    canBuyBeforeTargetLots: 6,
    canBuyBeforeTargetNumber: 853.74,
    beforeDiffNumber: 86.3299999999997,
    toBuyLots: 6,
    toBuyNumber: 853.74
  },
  {
    pair: 'RUB/RUB',
    base: 'RUB',
    quote: 'RUB',
    figi: undefined,
    amount: 477.96,
    lotSize: 1,
    price: { units: 1, nano: 0 },
    priceNumber: 1,
    lotPrice: { units: 1, nano: 0 },
    totalPrice: { units: 477, nano: 960000000 },
    lotPriceNumber: 1,
    totalPriceNumber: 477.96,
    desiredAmountNumber: 0,
    canBuyBeforeTargetLots: 0,
    canBuyBeforeTargetNumber: 0,
    beforeDiffNumber: 0,
    toBuyNumber: -477.96,
    toBuyLots: -477.96
  },
  {
    pair: 'TOFZ@/RUB',
    base: 'TOFZ@',
    quote: 'RUB',
    figi: 'TCS70A10A1L8',
    amount: 10,
    lotSize: 1,
    price: { units: 13, nano: 440000000 },
    priceNumber: 13.44,
    lotPrice: { units: 13, nano: 440000000 },
    totalPrice: { units: 134, nano: 400000000 },
    totalPriceNumber: 134.4,
    averagePositionPriceFifoNumber: 13.44,
    averagePositionPriceNumber: 13.44,
    lotPriceNumber: 13.44,
    desiredAmountNumber: 940.0699999999997,
    canBuyBeforeTargetLots: 69,
    canBuyBeforeTargetNumber: 927.36,
    beforeDiffNumber: 12.709999999999695,
    toBuyNumber: 685.44,
    toBuyLots: 51
  },
  {
    pair: 'TMOS@/RUB',
    base: 'TMOS@',
    quote: 'RUB',
    figi: 'TCS60A101X76',
    amount: 19,
    lotSize: 1,
    price: { units: 6, nano: 650000000 },
    priceNumber: 6.65,
    lotPrice: { units: 6, nano: 650000000 },
    totalPrice: { units: 126, nano: 350000000 },
    totalPriceNumber: 126.35,
    averagePositionPriceFifoNumber: 6.65,
    averagePositionPriceNumber: 6.65,
    lotPriceNumber: 6.65,
    desiredAmountNumber: 940.0699999999997,
    canBuyBeforeTargetLots: 141,
    canBuyBeforeTargetNumber: 937.6500000000001,
    beforeDiffNumber: 2.419999999999618,
    toBuyNumber: 711.5500000000001,
    toBuyLots: 107
  }
]
2025-09-04T15:28:37.048Z bot:balancer walletInfo { remains: 101.45999999999901 }
2025-09-04T15:28:37.048Z bot:balancer Creating necessary orders for all positions
2025-09-04T15:28:37.048Z bot:provider generateOrders
2025-09-04T15:28:37.049Z bot:provider generateOrder
2025-09-04T15:28:37.049Z bot:provider position {
  pair: 'TPAY/RUB',
  base: 'TPAY',
  quote: 'RUB',
  figi: 'TCS00A108WX3',
  amount: 2,
  lotSize: 1,
  price: { units: 100, nano: 680000000 },
  priceNumber: 100.68,
  lotPrice: { units: 100, nano: 680000000 },
  totalPrice: { units: 201, nano: 360000000 },
  totalPriceNumber: 201.36,
  averagePositionPriceFifoNumber: 100.68,
  averagePositionPriceNumber: 100.68,
  lotPriceNumber: 100.68,
  desiredAmountNumber: 0,
  canBuyBeforeTargetLots: 0,
  canBuyBeforeTargetNumber: 0,
  beforeDiffNumber: 0,
  toBuyNumber: -302.04,
  toBuyLots: -3
}
2025-09-04T15:28:37.049Z bot:provider üí∞ About to place SELL order: 3 lots √ó 100.68 = 302.04 RUB for TPAY
2025-09-04T15:28:37.049Z bot:provider Position is not currency
2025-09-04T15:28:37.049Z bot:provider position.toBuyLots -3
2025-09-04T15:28:37.049Z bot:provider Position is greater than or equal to 1 lot
2025-09-04T15:28:37.049Z bot:provider direction 2
2025-09-04T15:28:37.049Z bot:provider position {
  pair: 'TPAY/RUB',
  base: 'TPAY',
  quote: 'RUB',
  figi: 'TCS00A108WX3',
  amount: 2,
  lotSize: 1,
  price: { units: 100, nano: 680000000 },
  priceNumber: 100.68,
  lotPrice: { units: 100, nano: 680000000 },
  totalPrice: { units: 201, nano: 360000000 },
  totalPriceNumber: 201.36,
  averagePositionPriceFifoNumber: 100.68,
  averagePositionPriceNumber: 100.68,
  lotPriceNumber: 100.68,
  desiredAmountNumber: 0,
  canBuyBeforeTargetLots: 0,
  canBuyBeforeTargetNumber: 0,
  beforeDiffNumber: 0,
  toBuyNumber: -302.04,
  toBuyLots: -3
}
2025-09-04T15:28:37.049Z bot:provider Creating market order
2025-09-04T15:28:37.049Z bot:provider Sending market order {
  accountId: '2272547076',
  figi: 'TCS00A108WX3',
  quantity: 3,
  direction: 2,
  orderType: 2,
  orderId: '1q6g2pcmf5k9m7u'
}
{
  trackId: "e9302eb81b5444603c732fb440793efe",
  message: "Not enough assets for a margin trade",
  rateLimit: "300, 300;w=60",
  rateLimitRemaining: "299",
  rateLimitReset: "53",
}
Client error: INVALID_ARGUMENT(30042) 
–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–∫—Ç–∏–≤–æ–≤ –¥–ª—è –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ–π —Å–¥–µ–ª–∫–∏.<br/>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å—á—ë—Ç–∞ ‚Äî —ç—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ [GetMarginAttributes](./users#getmarginattributes). 
/tinkoff.public.invest.api.contract.v1.OrdersService/PostOrder
2025-09-04T15:28:37.309Z bot:provider Error placing order
2025-09-04T15:28:37.310Z bot:provider ClientError: /tinkoff.public.invest.api.contract.v1.OrdersService/PostOrder INVALID_ARGUMENT: 30042
    at wrapClientError (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/nice-grpc/lib/client/wrapClientError.js:9:39)
    at <anonymous> (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/nice-grpc/lib/client/createUnaryMethod.js:27:50)
    at onReceiveStatus (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/@grpc/grpc-js/build/src/client.js:195:36)
    at onReceiveStatus (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:365:141)
    at onReceiveStatus (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:328:181)
    at <anonymous> (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/@grpc/grpc-js/build/src/call-stream.js:188:78)
    at processTicksAndRejections (native:7:39)
2025-09-04T15:28:42.313Z bot:provider generateOrder
2025-09-04T15:28:42.313Z bot:provider position {
  pair: 'TMON/RUB',
  base: 'TMON',
  quote: 'RUB',
  figi: 'TCS70A106DL2',
  price: { units: 142, nano: 290000000 },
  priceNumber: 142.29,
  amount: 0,
  lotSize: 1,
  lotPrice: { units: 142, nano: 290000000 },
  lotPriceNumber: 142.29,
  desiredAmountNumber: 940.0699999999997,
  canBuyBeforeTargetLots: 6,
  canBuyBeforeTargetNumber: 853.74,
  beforeDiffNumber: 86.3299999999997,
  toBuyLots: 6,
  toBuyNumber: 853.74
}
2025-09-04T15:28:42.315Z bot:provider üí∞ About to place BUY order: 6 lots √ó 142.29 = 853.74 RUB for TMON
2025-09-04T15:28:42.315Z bot:provider Position is not currency
2025-09-04T15:28:42.315Z bot:provider position.toBuyLots 6
2025-09-04T15:28:42.315Z bot:provider Position is greater than or equal to 1 lot
2025-09-04T15:28:42.315Z bot:provider direction 1
2025-09-04T15:28:42.315Z bot:provider position {
  pair: 'TMON/RUB',
  base: 'TMON',
  quote: 'RUB',
  figi: 'TCS70A106DL2',
  price: { units: 142, nano: 290000000 },
  priceNumber: 142.29,
  amount: 0,
  lotSize: 1,
  lotPrice: { units: 142, nano: 290000000 },
  lotPriceNumber: 142.29,
  desiredAmountNumber: 940.0699999999997,
  canBuyBeforeTargetLots: 6,
  canBuyBeforeTargetNumber: 853.74,
  beforeDiffNumber: 86.3299999999997,
  toBuyLots: 6,
  toBuyNumber: 853.74
}
2025-09-04T15:28:42.315Z bot:provider Creating market order
2025-09-04T15:28:42.315Z bot:provider Sending market order {
  accountId: '2272547076',
  figi: 'TCS70A106DL2',
  quantity: 6,
  direction: 1,
  orderType: 2,
  orderId: '1q6g2pcmf5k9qa3'
}
{
  trackId: "deeb2a0e7e588f799702cf866a779fe4",
  message: "Post order error: Vozniknovenie ili uvelichenie nepokry`toj poziczii pri sovershenii sdelok s aktivom nedostupno",
  rateLimit: "300, 300;w=60",
  rateLimitRemaining: "298",
  rateLimitReset: "48",
}
Client error: INVALID_ARGUMENT(30049) 
–û—à–∏–±–∫–∞ –º–µ—Ç–æ–¥–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –ø–æ—Ä—É—á–µ–Ω–∏—è.<br/>–°–º–æ—Ç—Ä–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤ —Ç–µ–∫—Å—Ç–µ –æ—à–∏–±–∫–∏. 
/tinkoff.public.invest.api.contract.v1.OrdersService/PostOrder
2025-09-04T15:28:42.541Z bot:provider Error placing order
2025-09-04T15:28:42.541Z bot:provider ClientError: /tinkoff.public.invest.api.contract.v1.OrdersService/PostOrder INVALID_ARGUMENT: 30049
    at wrapClientError (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/nice-grpc/lib/client/wrapClientError.js:9:39)
    at <anonymous> (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/nice-grpc/lib/client/createUnaryMethod.js:27:50)
    at onReceiveStatus (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/@grpc/grpc-js/build/src/client.js:195:36)
    at onReceiveStatus (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:365:141)
    at onReceiveStatus (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:328:181)
    at <anonymous> (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/@grpc/grpc-js/build/src/call-stream.js:188:78)
    at processTicksAndRejections (native:7:39)
2025-09-04T15:28:47.544Z bot:provider generateOrder
2025-09-04T15:28:47.544Z bot:provider position {
  pair: 'RUB/RUB',
  base: 'RUB',
  quote: 'RUB',
  figi: undefined,
  amount: 477.96,
  lotSize: 1,
  price: { units: 1, nano: 0 },
  priceNumber: 1,
  lotPrice: { units: 1, nano: 0 },
  totalPrice: { units: 477, nano: 960000000 },
  lotPriceNumber: 1,
  totalPriceNumber: 477.96,
  desiredAmountNumber: 0,
  canBuyBeforeTargetLots: 0,
  canBuyBeforeTargetNumber: 0,
  beforeDiffNumber: 0,
  toBuyNumber: -477.96,
  toBuyLots: -477.96
}
2025-09-04T15:28:47.544Z bot:provider If position is RUB, do nothing
2025-09-04T15:28:47.544Z bot:provider generateOrder
2025-09-04T15:28:47.544Z bot:provider position {
  pair: 'TOFZ@/RUB',
  base: 'TOFZ@',
  quote: 'RUB',
  figi: 'TCS70A10A1L8',
  amount: 10,
  lotSize: 1,
  price: { units: 13, nano: 440000000 },
  priceNumber: 13.44,
  lotPrice: { units: 13, nano: 440000000 },
  totalPrice: { units: 134, nano: 400000000 },
  totalPriceNumber: 134.4,
  averagePositionPriceFifoNumber: 13.44,
  averagePositionPriceNumber: 13.44,
  lotPriceNumber: 13.44,
  desiredAmountNumber: 940.0699999999997,
  canBuyBeforeTargetLots: 69,
  canBuyBeforeTargetNumber: 927.36,
  beforeDiffNumber: 12.709999999999695,
  toBuyNumber: 685.44,
  toBuyLots: 51
}
2025-09-04T15:28:47.544Z bot:provider üí∞ About to place BUY order: 51 lots √ó 13.44 = 685.44 RUB for TOFZ@
2025-09-04T15:28:47.544Z bot:provider Position is not currency
2025-09-04T15:28:47.544Z bot:provider position.toBuyLots 51
2025-09-04T15:28:47.544Z bot:provider Position is greater than or equal to 1 lot
2025-09-04T15:28:47.544Z bot:provider direction 1
2025-09-04T15:28:47.544Z bot:provider position {
  pair: 'TOFZ@/RUB',
  base: 'TOFZ@',
  quote: 'RUB',
  figi: 'TCS70A10A1L8',
  amount: 10,
  lotSize: 1,
  price: { units: 13, nano: 440000000 },
  priceNumber: 13.44,
  lotPrice: { units: 13, nano: 440000000 },
  totalPrice: { units: 134, nano: 400000000 },
  totalPriceNumber: 134.4,
  averagePositionPriceFifoNumber: 13.44,
  averagePositionPriceNumber: 13.44,
  lotPriceNumber: 13.44,
  desiredAmountNumber: 940.0699999999997,
  canBuyBeforeTargetLots: 69,
  canBuyBeforeTargetNumber: 927.36,
  beforeDiffNumber: 12.709999999999695,
  toBuyNumber: 685.44,
  toBuyLots: 51
}
2025-09-04T15:28:47.545Z bot:provider Creating market order
2025-09-04T15:28:47.545Z bot:provider Sending market order {
  accountId: '2272547076',
  figi: 'TCS70A10A1L8',
  quantity: 51,
  direction: 1,
  orderType: 2,
  orderId: '1q6g2pcmf5k9ubd'
}
2025-09-04T15:28:47.916Z bot:provider Successfully placed order {
  orderId: '620087793350',
  executionReportStatus: 1,
  lotsRequested: 51,
  lotsExecuted: 51,
  initialOrderPrice: { currency: 'rub', units: 687, nano: 990000000 },
  executedOrderPrice: { currency: 'rub', units: 13, nano: 440000000 },
  totalOrderAmount: { currency: 'rub', units: 685, nano: 440000000 },
  initialCommission: { currency: 'rub', units: 0, nano: 0 },
  executedCommission: { currency: 'rub', units: 0, nano: 0 },
  aciValue: undefined,
  figi: 'TCS70A10A1L8',
  direction: 1,
  initialSecurityPrice: { currency: 'rub', units: 13, nano: 490000000 },
  orderType: 2,
  message: '',
  initialOrderPricePt: undefined,
  instrumentUid: 'c5049184-ded4-49d0-8e14-bffefc40a223',
  orderRequestId: '1q6g2pcmf5k9ubd',
  responseMetadata: {
    trackingId: '5b6509d8f0d49bc7664b6122ed79a80e',
    serverTime: 2025-09-04T15:29:17.913Z
  }
}
2025-09-04T15:28:52.917Z bot:provider generateOrder
2025-09-04T15:28:52.917Z bot:provider position {
  pair: 'TMOS@/RUB',
  base: 'TMOS@',
  quote: 'RUB',
  figi: 'TCS60A101X76',
  amount: 19,
  lotSize: 1,
  price: { units: 6, nano: 650000000 },
  priceNumber: 6.65,
  lotPrice: { units: 6, nano: 650000000 },
  totalPrice: { units: 126, nano: 350000000 },
  totalPriceNumber: 126.35,
  averagePositionPriceFifoNumber: 6.65,
  averagePositionPriceNumber: 6.65,
  lotPriceNumber: 6.65,
  desiredAmountNumber: 940.0699999999997,
  canBuyBeforeTargetLots: 141,
  canBuyBeforeTargetNumber: 937.6500000000001,
  beforeDiffNumber: 2.419999999999618,
  toBuyNumber: 711.5500000000001,
  toBuyLots: 107
}
2025-09-04T15:28:52.917Z bot:provider üí∞ About to place BUY order: 107 lots √ó 6.65 = 711.55 RUB for TMOS@
2025-09-04T15:28:52.917Z bot:provider Position is not currency
2025-09-04T15:28:52.917Z bot:provider position.toBuyLots 107
2025-09-04T15:28:52.917Z bot:provider Position is greater than or equal to 1 lot
2025-09-04T15:28:52.917Z bot:provider direction 1
2025-09-04T15:28:52.917Z bot:provider position {
  pair: 'TMOS@/RUB',
  base: 'TMOS@',
  quote: 'RUB',
  figi: 'TCS60A101X76',
  amount: 19,
  lotSize: 1,
  price: { units: 6, nano: 650000000 },
  priceNumber: 6.65,
  lotPrice: { units: 6, nano: 650000000 },
  totalPrice: { units: 126, nano: 350000000 },
  totalPriceNumber: 126.35,
  averagePositionPriceFifoNumber: 6.65,
  averagePositionPriceNumber: 6.65,
  lotPriceNumber: 6.65,
  desiredAmountNumber: 940.0699999999997,
  canBuyBeforeTargetLots: 141,
  canBuyBeforeTargetNumber: 937.6500000000001,
  beforeDiffNumber: 2.419999999999618,
  toBuyNumber: 711.5500000000001,
  toBuyLots: 107
}
2025-09-04T15:28:52.918Z bot:provider Creating market order
2025-09-04T15:28:52.918Z bot:provider Sending market order {
  accountId: '2272547076',
  figi: 'TCS60A101X76',
  quantity: 107,
  direction: 1,
  orderType: 2,
  orderId: '1q6g2pcmf5k9ygm'
}
2025-09-04T15:28:53.366Z bot:provider Successfully placed order {
  orderId: '620087794180',
  executionReportStatus: 1,
  lotsRequested: 107,
  lotsExecuted: 107,
  initialOrderPrice: { currency: 'rub', units: 711, nano: 550000000 },
  executedOrderPrice: { currency: 'rub', units: 6, nano: 650000000 },
  totalOrderAmount: { currency: 'rub', units: 711, nano: 550000000 },
  initialCommission: { currency: 'rub', units: 0, nano: 0 },
  executedCommission: { currency: 'rub', units: 0, nano: 0 },
  aciValue: undefined,
  figi: 'TCS60A101X76',
  direction: 1,
  initialSecurityPrice: { currency: 'rub', units: 6, nano: 650000000 },
  orderType: 2,
  message: '',
  initialOrderPricePt: undefined,
  instrumentUid: 'f509af83-6e71-462f-901f-bcb073f6773b',
  orderRequestId: '1q6g2pcmf5k9ygm',
  responseMetadata: {
    trackingId: 'd5c279fdbce3b53d6fcc78568b9ce791',
    serverTime: 2025-09-04T15:29:23.357Z
  }
}
2025-09-04T15:28:58.374Z bot:balancer Final calculation for TMON: currentLots=0, plannedLots=6, finalLots=6, finalValue=853.74
2025-09-04T15:28:58.374Z bot:balancer Final calculation for TPAY: currentLots=2, plannedLots=-3, finalLots=-1, finalValue=0
2025-09-04T15:28:58.374Z bot:balancer Final calculation for TOFZ@: currentLots=10, plannedLots=51, finalLots=61, finalValue=819.8399999999999
2025-09-04T15:28:58.374Z bot:balancer Final calculation for TMOS@: currentLots=19, plannedLots=107, finalLots=126, finalValue=837.9000000000001

‚ö° DIAGNOSIS: Orders executed, BUT coreWallet NOT updated!
‚è∞ Timestamp after balancing: 2025-09-04T15:28:58.375Z
üí∞ RUB balance in OLD coreWallet: 477.96 (should be same as before)
‚ùå This is the problem: afterShares will be calculated using OLD data!

üìä Margin Information:
  Total margin used: 626.71 RUB
  Within limits: ‚úÖ Yes
  Margin positions: 4

üîÑ DIAGNOSIS: Fetching FRESH portfolio data after order execution...
üí∞ RUB balance in FRESH wallet: -918.97
üìä Difference in RUB: -1396.93
üéØ FOUND IT! Portfolio changed after balancing - dividends or order execution detected!

üéØ DIAGNOSIS: beforeShares vs afterShares comparison
üìà TPAY: 43.56% -> 10.83% (-32.73%)
üìà TOFZ: 29.10% -> 44.10% (+15.00%)
üìà TMOS: 27.34% -> 45.07% (+17.73%)

üéØ BALANCING RESULT:
Mode used: manual
Format: TICKER: diff: before% -> after% (target%)
Where: before% = current share, after% = actual share after balancing, (target%) = target from balancer, diff = change in percentage points

TMOS: +17.73%: 27.34% -> 45.07% (33.36%)
TOFZ: +15.00%: 29.10% -> 44.10% (32.64%)
TPAY: -32.73%: 43.56% -> 10.83% (0.00%)
TMON: 0%: 0.00% -> 0.00% (33.99%)
RUR: 477.96 RUB
2025-09-04T15:28:58.757Z bot:provider ITERATION #1 FINISHED. TIME: Thu Sep 04 2025 18:28:58 GMT+0300 (Moscow Standard Time)
