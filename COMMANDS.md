# –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞

### –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
```bash
# –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –¥–ª—è —Ç–æ–∫–µ–Ω–∞
bun run ./src/index.ts --list-accounts

# –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–µ—Ä–µ—Ç —Ç–æ–∫–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ:
# 1. –¢–æ–∫–µ–Ω –ø–µ—Ä–≤–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –∏–∑ CONFIG.json (–Ω–∞–ø—Ä–∏–º–µ—Ä, T_INVEST_TOKEN_5)
# 2. –û—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–∫–µ–Ω T_INVEST_TOKEN –∏–∑ .env
# 3. –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã - –≤—ã–¥–∞—Å—Ç –æ—à–∏–±–∫—É
```

### –ó–∞–ø—É—Å–∫ —Å –æ—Ç–ª–∞–¥–∫–æ–π
```bash
DEBUG=bot:main,bot:provider,bot:balancer bun run ./src/index.ts
```

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
# –í—Å–µ —Ç–µ—Å—Ç—ã
bun test

# –¢–µ—Å—Ç—ã buy_requires_total_marginal_sell
bun test src/__tests__/buyRequires*.test.ts

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤
bun test src/__tests__/buyRequiresTotalMarginalSell.test.ts
bun test src/__tests__/buyRequiresConfigValidation.test.ts
bun test src/__tests__/buyRequiresIntegration.test.ts
bun test src/__tests__/buyRequiresEdgeCases.test.ts
bun test src/__tests__/buyRequiresDocumentationExamples.test.ts
```

## –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π RUB –±–∞–ª–∞–Ω—Å –≤ BALANCING RESULT (2025-09-05)

**–ü—Ä–æ–±–ª–µ–º–∞**: –í —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –æ—Ç—á–µ—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª—Å—è —Å—Ç–∞—Ä—ã–π RUB –±–∞–ª–∞–Ω—Å (650.67) –≤–º–µ—Å—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ (-870.26)

**–ü—Ä–∏—á–∏–Ω–∞**: –í `src/provider/index.ts` —Å—Ç—Ä–æ–∫–∏ 657-663 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ `coreWallet` –≤–º–µ—Å—Ç–æ `freshCoreWallet`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**:
```typescript
// –ë—ã–ª–æ:
const rubPosition = coreWallet.find(p => p.base === 'RUB' && p.quote === 'RUB');

// –°—Ç–∞–ª–æ:
const rubPosition = freshCoreWallet.find(p => p.base === 'RUB' && p.quote === 'RUB');
```

### 2. –ê–Ω–∞–ª–∏–∑ –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ–≥–æ –º–Ω–æ–∂–∏—Ç–µ–ª—è x2

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥—É–º–∞–ª, —á—Ç–æ —Ä—É–±–ª–µ–≤—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–µ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω—ã –ø—Ä–∏ multiplier=2

**–ê–Ω–∞–ª–∏–∑**: –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
- –ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: 650.67 RUB
- –§–∏–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: -870.26 RUB (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∞—Ä–∂—É)
- –í—Å–µ ETF –¥–æ—Å—Ç–∏–≥–ª–∏ —Ü–µ–ª–µ–≤—ã—Ö –¥–æ–ª–µ–π ~33%
- –ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ–µ –ø–ª–µ—á–æ x2 –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è —Å –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω—ã–º –º–Ω–æ–∂–∏—Ç–µ–ª–µ–º (2025-09-05)

**–ü—Ä–æ–±–ª–µ–º–∞**: –°–∏—Å—Ç–µ–º–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å x2 –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è

**–ü—Ä–∏—á–∏–Ω–∞**: –í `src/utils/marginCalculator.ts` –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–ª–µ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞—Å—á–µ—Ç `targetPortfolioSize = totalPortfolioValue * multiplier`

### 4. üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ target –ø—Ä–æ—Ü–µ–Ω—Ç—ã –≤ –≤—ã–≤–æ–¥–µ (2025-09-05)

**–ü—Ä–æ–±–ª–µ–º–∞**: –í —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –æ—Ç—á–µ—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏—Å—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ target –ø—Ä–æ—Ü–µ–Ω—Ç—ã (20.22% –≤–º–µ—Å—Ç–æ 8.33%)

**–ü—Ä–∏—á–∏–Ω–∞**: –í `src/provider/index.ts` —Å—Ç—Ä–æ–∫–∞ 631 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ `finalPercents` (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–æ–ª–∏ –ø–æ—Å–ª–µ —Ç–æ—Ä–≥–æ–≤–ª–∏) –≤–º–µ—Å—Ç–æ —Ü–µ–ª–µ–≤—ã—Ö –¥–æ–ª–µ–π –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**:
```typescript
// –ë—ã–ª–æ:
const targetPercent = finalPercents[ticker] || 0;

// –°—Ç–∞–ª–æ:
const normalizedDesired = normalizeDesire(desiredForRun);
const targetPercent = normalizedDesired[ticker] || 0;
```

### 5. üö® –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–≤–æ–π–Ω–æ–π —Å—á–µ—Ç –ø—Ä–æ–¥–∞–∂ - –∫–æ—Ä–æ—Ç–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏ (2025-09-05)

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ 12 ETF —Å–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞–ª–∞ –∫–æ—Ä–æ—Ç–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏ (TOFZ: -30.24%, TMOS: -30.10%)

**–ü—Ä–∏—á–∏–Ω–∞**: –î–≤–æ–π–Ω–æ–π —Å—á–µ—Ç –ø—Ä–æ–¥–∞–∂ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `buyRequiresTotalMarginalSell`:
1. –û—Å–Ω–æ–≤–Ω–∞—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞: TOFZ `toBuyLots = -35` (–ø—Ä–æ–¥–∞—Ç—å 35 –ª–æ—Ç–æ–≤)
2. –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –ø—Ä–æ–¥–∞–∂: `sellLots = 32` (–ø—Ä–æ–¥–∞—Ç—å –µ—â–µ 32 –ª–æ—Ç–∞)
3. –†–µ–∑—É–ª—å—Ç–∞—Ç: `toBuyLots = -35 - 32 = -67` ‚Üí –ø—Ä–æ–¥–∞–∂–∞ 67 –ª–æ—Ç–æ–≤ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ 46

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –í `src/balancer/index.ts` —Å—Ç—Ä–æ–∫–∏ 555-601 –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞:
- –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è —É–∂–µ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∫ –ø—Ä–æ–¥–∞–∂–µ (`toBuyLots < 0`), –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏
- –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ø—Ä–æ–¥–∞–∂–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ª–æ—Ç–æ–≤
- –ò–∑–±–µ–∂–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø–æ–∑–∏—Ü–∏–π

### 6. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª buy_requires_total_marginal_sell

**–°—Ç–∞—Ç—É—Å**: –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó configuration-update.md
- ‚úÖ TMON (–Ω–µ–º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω—ã–π) —É—Å–ø–µ—à–Ω–æ –ø–æ–∫—É–ø–∞–µ—Ç—Å—è
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞
- ‚úÖ –ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ–µ –ø–ª–µ—á–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–º–º—ã –≤–µ—Å–æ–≤ –ø–æ—Ä—Ç—Ñ–µ–ª—è
```bash
# –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 100% –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã
node -e "
const config = require('./CONFIG.json');
const wallet = config.accounts[0].desired_wallet;
const sum = Object.values(wallet).reduce((a,b) => a+b, 0);
console.log('–°—É–º–º–∞ –≤–µ—Å–æ–≤:', sum, '%');
"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–∞—Ä–∂–∏
node -e "
const config = require('./CONFIG.json');
const margin = config.accounts[0].margin_trading;
console.log('–ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è:', margin);
"
```

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤

### –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö
```bash
grep -n "Error\|error\|ERROR" *.log
```

### –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–∞–ª–∞–Ω—Å–∞—Ö
```bash
grep -n "RUB balance\|BALANCING RESULT" *.log
```

### –ü–æ–∏—Å–∫ –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
```bash
grep -n "Margin Information\|margin" *.log
```
