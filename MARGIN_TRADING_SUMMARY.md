# –†–µ–∑—é–º–µ: –ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –≤ ETF Balancer Bot

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. –°–∏—Å—Ç–µ–º–∞ –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏
- **–ú–Ω–æ–∂–∏—Ç–µ–ª—å –ø–æ—Ä—Ç—Ñ–µ–ª—è**: –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –æ—Ç 1 –¥–æ 4 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é x2)
- **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–µ—Ä–µ–Ω–æ—Å**: –¥–æ 5,000 —Ä—É–± (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- **–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: remove/keep/keep_if_small

### 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- `MarginCalculator` - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ `src/config.ts`

### 3. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π –º–∞—Ä–∂–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –∏ —É—Ä–æ–≤–Ω—è —Ä–∏—Å–∫–∞
- –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞ –ø–æ–∑–∏—Ü–∏–π
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –ø–æ–∑–∏—Ü–∏–π —Å —É—á–µ—Ç–æ–º –º–Ω–æ–∂–∏—Ç–µ–ª—è
- **–£–º–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ:
  - –í—Ä–µ–º–µ–Ω–∏ –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —Ä—ã–Ω–∫–∞
  - –ò–Ω—Ç–µ—Ä–≤–∞–ª–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
  - –õ–æ–≥–∏–∫–∏ "–ø–æ—Å–ª–µ–¥–Ω–µ–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –¥–Ω—è"

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª `src/balancer/testMargin.ts`
- –î–æ–±–∞–≤–ª–µ–Ω npm —Å–∫—Ä–∏–ø—Ç `test:margin`
- –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ/–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`src/config.ts`** - –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏
2. **`src/types.d.ts`** - —Ä–∞—Å—à–∏—Ä–µ–Ω—ã —Ç–∏–ø—ã –¥–ª—è –º–∞—Ä–∂–∏
3. **`src/utils/marginCalculator.ts`** - –Ω–æ–≤—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–∞—Ä–∂–∏
4. **`src/balancer/index.ts`** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫
5. **`src/balancer/testMargin.ts`** - —Ç–µ—Å—Ç—ã —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
6. **`package.json`** - –¥–æ–±–∞–≤–ª–µ–Ω —Å–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
7. **`tasks/margin_trading.md`** - –∑–∞–¥–∞—á–∞ —Å –¥–µ—Ç–∞–ª—è–º–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
8. **`README.margin_trading.md`** - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
npm run test:margin
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞
```typescript
// src/config.ts
export const MARGIN_MULTIPLIER: number = 2; // x2
export const FREE_MARGIN_THRESHOLD: number = 5000; // 5,000 —Ä—É–±
export const MARGIN_BALANCING_STRATEGY: 'remove' | 'keep' | 'keep_if_small' = 'keep_if_small';
export const LAST_BALANCE_TIME: string = '18:45';
```

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
```typescript
import { MarginCalculator } from './src/utils/marginCalculator';

const calculator = new MarginCalculator(config);
const availableMargin = calculator.calculateAvailableMargin(portfolio);
const strategy = calculator.applyMarginStrategy(marginPositions, 'keep_if_small');
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –†–∞—Å—á–µ—Ç –º–∞—Ä–∂–∏
- –î–æ—Å—Ç—É–ø–Ω–∞—è –º–∞—Ä–∂–∞ = –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å √ó (–ú–Ω–æ–∂–∏—Ç–µ–ª—å - 1)
- –ü—Ä–∏ –º–Ω–æ–∂–∏—Ç–µ–ª–µ x2: 1,000,000 —Ä—É–± ‚Üí –¥–æ—Å—Ç—É–ø–Ω–∞—è –º–∞—Ä–∂–∞ 1,000,000 —Ä—É–±

### –°—Ç—Ä–∞—Ç–µ–≥–∏–∏
- **remove**: —É–±–∏—Ä–∞—Ç—å –º–∞—Ä–∂—É –≤ –∫–æ–Ω—Ü–µ –¥–Ω—è
- **keep**: –æ—Å—Ç–∞–≤–ª—è—Ç—å –º–∞—Ä–∂—É –≤—Å–µ–≥–¥–∞  
- **keep_if_small**: –æ—Å—Ç–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ < –ø–æ—Ä–æ–≥–∞
- **–£–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é:
  - –ï—Å–ª–∏ –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —Ä—ã–Ω–∫–∞ –º–µ–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
  - –ò–ª–∏ –µ—Å–ª–∏ –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—å—à–µ 15 –º–∏–Ω—É—Ç (–ø–æ—Å–ª–µ–¥–Ω—è—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –¥–Ω—è)

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —Ä–∏—Å–∫–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –º–∞—Ä–∂–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```
=== –¢–µ—Å—Ç –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏ ===

1. –î–æ—Å—Ç—É–ø–Ω–∞—è –º–∞—Ä–∂–∞: 900,000.00 —Ä—É–± (–º–Ω–æ–∂–∏—Ç–µ–ª—å x4)
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤: ‚úÖ –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å true, –†–∏—Å–∫ low
3. –°—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–Ω–æ—Å–∞: 900.00 —Ä—É–±
4. –°—Ç—Ä–∞—Ç–µ–≥–∏—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏: ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
5. –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã: ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è
6. –¢–µ—Å—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–π: ‚úÖ –í—Å–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:
‚úÖ –£—Ç—Ä–æ (9:00): —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
‚úÖ –î–µ–Ω—å (14:00): —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è  
‚úÖ –ü–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º (18:30): —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
‚úÖ –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è (19:00): —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
```

## üéØ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ. –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª, –∞ –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è.

### üß† –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏

1. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –Ω–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –≤—Ä–µ–º—è
2. **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ –∏–Ω—Ç–µ—Ä–≤–∞–ª –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
3. **–£–º–Ω–æ—Å—Ç—å**: –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ–≥–¥–∞ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –¥–Ω—è
4. **–ì–∏–±–∫–æ—Å—Ç—å**: —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –∑–∞–∫—Ä—ã—Ç–∏—è —Ä—ã–Ω–∫–∞
5. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –Ω–µ—Ç —Ä–∏—Å–∫–∞ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

## üîÆ –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º API Tinkoff –¥–ª—è –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
2. –î–∞—à–±–æ—Ä–¥ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –º–∞—Ä–∂–∏
3. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –º–Ω–æ–∂–∏—Ç–µ–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—Ä–æ–≤–Ω—è—Ö —Ä–∏—Å–∫–∞
