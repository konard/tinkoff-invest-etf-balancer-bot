$ DEBUG=bot:main,bot:provider,bot:balancer bun run ./src/index.ts
Warning: sum of weights for account 0 equals 33.32%, not 100%
2025-09-04T15:22:37.207Z bot:main main start
2025-09-04T15:22:37.207Z bot:provider Getting accounts list
2025-09-04T15:22:37.682Z bot:provider accountsResponse {
  accounts: [
    {
      id: '2272547076',
      type: 1,
      name: '–ë—Ä–æ–∫–µ—Ä—Å–∫–∏–π —Å—á–µ—Ç 4',
      status: 2,
      openedDate: 2025-08-08T00:00:00.000Z,
      closedDate: 1970-01-01T00:00:00.000Z,
      accessLevel: 1
    }
  ]
}
2025-09-04T15:22:37.685Z bot:provider Selected account by index {
  id: '2272547076',
  type: 1,
  name: '–ë—Ä–æ–∫–µ—Ä—Å–∫–∏–π —Å—á–µ—Ç 4',
  status: 2,
  openedDate: 2025-08-08T00:00:00.000Z,
  closedDate: 1970-01-01T00:00:00.000Z,
  accessLevel: 1
}
2025-09-04T15:22:37.685Z bot:provider Getting shares list
2025-09-04T15:22:42.815Z bot:provider shares count 1937
2025-09-04T15:22:47.818Z bot:provider Getting ETFs list
2025-09-04T15:22:48.769Z bot:provider etfs count 276
2025-09-04T15:22:53.772Z bot:provider Getting bonds list
2025-09-04T15:22:58.298Z bot:provider bonds count 1406
2025-09-04T15:23:03.300Z bot:provider Getting currencies list
2025-09-04T15:23:03.459Z bot:provider currencies count 16
2025-09-04T15:23:08.464Z bot:provider Getting futures list
2025-09-04T15:23:10.204Z bot:provider futures count 365
2025-09-04T15:23:15.207Z bot:provider =========================
2025-09-04T15:23:15.213Z bot:provider Checking trading schedule for MOEX. Current time: 2025-09-04T15:23:15.213Z
2025-09-04T15:23:15.213Z bot:provider Request params: from=2025-09-04T15:23:15.213Z, to=2025-09-05T15:23:15.213Z
2025-09-04T15:23:15.496Z bot:provider Trading schedules response: {
  "exchanges": [
    {
      "exchange": "MOEX",
      "days": [
        {
          "date": "2025-09-04T00:00:00.000Z",
          "isTradingDay": true,
          "startTime": "2025-09-04T07:00:00.000Z",
          "endTime": "2025-09-04T15:39:59.000Z",
          "openingAuctionStartTime": "2025-09-04T06:50:00.000Z",
          "closingAuctionEndTime": "2025-09-04T15:50:00.000Z",
          "closingAuctionStartTime": "2025-09-04T15:40:01.000Z",
          "openingAuctionEndTime": "2025-09-04T06:59:59.000Z",
          "intervals": [
            {
              "type": "regular_trading_session",
              "interval": {
                "startTs": "2025-09-04T07:00:00.000Z",
                "endTs": "2025-09-04T15:39:59.000Z"
              }
            },
            {
              "type": "regular_trading_session_main",
              "interval": {
                "startTs": "2025-09-04T07:00:00.000Z",
                "endTs": "2025-09-04T15:39:59.000Z"
              }
            },
            {
              "type": "opening_auction",
              "interval": {
                "startTs": "2025-09-04T06:50:00.000Z",
                "endTs": "2025-09-04T06:59:59.000Z"
              }
            },
            {
              "type": "opening_auction_main",
              "interval": {
                "startTs": "2025-09-04T06:50:00.000Z",
                "endTs": "2025-09-04T06:59:59.000Z"
              }
            },
            {
              "type": "closing_auction",
              "interval": {
                "startTs": "2025-09-04T15:40:01.000Z",
                "endTs": "2025-09-04T15:50:00.000Z"
              }
            },
            {
              "type": "closing_auction_main",
              "interval": {
                "startTs": "2025-09-04T15:40:01.000Z",
                "endTs": "2025-09-04T15:50:00.000Z"
              }
            }
          ]
        },
        {
          "date": "2025-09-05T00:00:00.000Z",
          "isTradingDay": true,
          "startTime": "2025-09-05T07:00:00.000Z",
          "endTime": "2025-09-05T15:39:59.000Z",
          "openingAuctionStartTime": "2025-09-05T06:50:00.000Z",
          "closingAuctionEndTime": "2025-09-05T15:50:00.000Z",
          "closingAuctionStartTime": "2025-09-05T15:40:01.000Z",
          "openingAuctionEndTime": "2025-09-05T06:59:59.000Z",
          "intervals": [
            {
              "type": "regular_trading_session",
              "interval": {
                "startTs": "2025-09-05T07:00:00.000Z",
                "endTs": "2025-09-05T15:39:59.000Z"
              }
            },
            {
              "type": "regular_trading_session_main",
              "interval": {
                "startTs": "2025-09-05T07:00:00.000Z",
                "endTs": "2025-09-05T15:39:59.000Z"
              }
            },
            {
              "type": "opening_auction",
              "interval": {
                "startTs": "2025-09-05T06:50:00.000Z",
                "endTs": "2025-09-05T06:59:59.000Z"
              }
            },
            {
              "type": "opening_auction_main",
              "interval": {
                "startTs": "2025-09-05T06:50:00.000Z",
                "endTs": "2025-09-05T06:59:59.000Z"
              }
            },
            {
              "type": "closing_auction",
              "interval": {
                "startTs": "2025-09-05T15:40:01.000Z",
                "endTs": "2025-09-05T15:50:00.000Z"
              }
            },
            {
              "type": "closing_auction_main",
              "interval": {
                "startTs": "2025-09-05T15:40:01.000Z",
                "endTs": "2025-09-05T15:50:00.000Z"
              }
            }
          ]
        }
      ]
    }
  ]
}
2025-09-04T15:23:15.496Z bot:provider Found 2 trading days in schedule
2025-09-04T15:23:15.496Z bot:provider Processing day: {
  "date": "2025-09-04T00:00:00.000Z",
  "isTradingDay": true,
  "startTime": "2025-09-04T07:00:00.000Z",
  "endTime": "2025-09-04T15:39:59.000Z",
  "openingAuctionStartTime": "2025-09-04T06:50:00.000Z",
  "closingAuctionEndTime": "2025-09-04T15:50:00.000Z",
  "closingAuctionStartTime": "2025-09-04T15:40:01.000Z",
  "openingAuctionEndTime": "2025-09-04T06:59:59.000Z",
  "intervals": [
    {
      "type": "regular_trading_session",
      "interval": {
        "startTs": "2025-09-04T07:00:00.000Z",
        "endTs": "2025-09-04T15:39:59.000Z"
      }
    },
    {
      "type": "regular_trading_session_main",
      "interval": {
        "startTs": "2025-09-04T07:00:00.000Z",
        "endTs": "2025-09-04T15:39:59.000Z"
      }
    },
    {
      "type": "opening_auction",
      "interval": {
        "startTs": "2025-09-04T06:50:00.000Z",
        "endTs": "2025-09-04T06:59:59.000Z"
      }
    },
    {
      "type": "opening_auction_main",
      "interval": {
        "startTs": "2025-09-04T06:50:00.000Z",
        "endTs": "2025-09-04T06:59:59.000Z"
      }
    },
    {
      "type": "closing_auction",
      "interval": {
        "startTs": "2025-09-04T15:40:01.000Z",
        "endTs": "2025-09-04T15:50:00.000Z"
      }
    },
    {
      "type": "closing_auction_main",
      "interval": {
        "startTs": "2025-09-04T15:40:01.000Z",
        "endTs": "2025-09-04T15:50:00.000Z"
      }
    }
  ]
}
2025-09-04T15:23:15.496Z bot:provider Session times: start=2025-09-04T07:00:00.000Z, end=2025-09-04T15:39:59.000Z
2025-09-04T15:23:15.496Z bot:provider Evening session: start=undefined, end=undefined
2025-09-04T15:23:15.496Z bot:provider Current time is within main trading session
2025-09-04T15:23:15.496Z bot:provider Getting portfolio and positions simultaneously
2025-09-04T15:23:15.686Z bot:provider portfolio {
  totalAmountShares: { currency: 'rub', units: 0, nano: 0 },
  totalAmountBonds: { currency: 'rub', units: 0, nano: 0 },
  totalAmountEtf: { currency: 'rub', units: 2108, nano: 540000000 },
  totalAmountCurrencies: { currency: 'rub', units: -1165, nano: -680000000 },
  totalAmountFutures: { currency: 'rub', units: 0, nano: 0 },
  expectedYield: { units: 0, nano: 30000000 },
  positions: [
    {
      figi: 'TCS00A108WX3',
      instrumentType: 'etf',
      quantity: [Object],
      averagePositionPrice: [Object],
      expectedYield: [Object],
      currentNkd: undefined,
      averagePositionPricePt: [Object],
      currentPrice: [Object],
      averagePositionPriceFifo: [Object],
      quantityLots: [Object],
      blocked: false,
      blockedLots: [Object],
      positionUid: '41be4f89-9d19-4eac-9ae4-09276f85956a',
      instrumentUid: '1d0e01e5-148c-40e5-bb8f-1bf2d8e03c1a',
      varMargin: [Object],
      expectedYieldFifo: [Object],
      dailyYield: [Object]
    },
    {
      figi: 'RUB000UTSTOM',
      instrumentType: 'currency',
      quantity: [Object],
      averagePositionPrice: [Object],
      expectedYield: [Object],
      currentNkd: undefined,
      averagePositionPricePt: [Object],
      currentPrice: [Object],
      averagePositionPriceFifo: [Object],
      quantityLots: [Object],
      blocked: false,
      blockedLots: [Object],
      positionUid: '33e24a92-aab0-409c-88b8-f2d57415b920',
      instrumentUid: 'a92e2e25-a698-45cc-a781-167cf465257c',
      varMargin: [Object],
      expectedYieldFifo: [Object],
      dailyYield: [Object]
    },
    {
      figi: 'TCS70A10A1L8',
      instrumentType: 'etf',
      quantity: [Object],
      averagePositionPrice: [Object],
      expectedYield: [Object],
      currentNkd: undefined,
      averagePositionPricePt: [Object],
      currentPrice: [Object],
      averagePositionPriceFifo: [Object],
      quantityLots: [Object],
      blocked: false,
      blockedLots: [Object],
      positionUid: '83fd264c-28fc-4b6a-b8f2-ae090148050d',
      instrumentUid: 'c5049184-ded4-49d0-8e14-bffefc40a223',
      varMargin: [Object],
      expectedYieldFifo: [Object],
      dailyYield: [Object]
    },
    {
      figi: 'TCS60A101X76',
      instrumentType: 'etf',
      quantity: [Object],
      averagePositionPrice: [Object],
      expectedYield: [Object],
      currentNkd: undefined,
      averagePositionPricePt: [Object],
      currentPrice: [Object],
      averagePositionPriceFifo: [Object],
      quantityLots: [Object],
      blocked: false,
      blockedLots: [Object],
      positionUid: 'ffd48f38-aa9b-491c-8e40-140a3f0bc931',
      instrumentUid: 'f509af83-6e71-462f-901f-bcb073f6773b',
      varMargin: [Object],
      expectedYieldFifo: [Object],
      dailyYield: [Object]
    }
  ],
  accountId: '2272547076',
  totalAmountOptions: { currency: 'rub', units: 0, nano: 0 },
  totalAmountSp: { currency: 'rub', units: 0, nano: 0 },
  totalAmountPortfolio: { currency: 'rub', units: 942, nano: 860000000 },
  virtualPositions: [],
  dailyYield: { currency: 'rub', units: 0, nano: 290000000 },
  dailyYieldRelative: { units: 0, nano: 30000000 }
}
2025-09-04T15:23:15.687Z bot:provider positions {
  money: [ { currency: 'rub', units: -1165, nano: -680000000 } ],
  blocked: [],
  securities: [
    {
      figi: 'TCS00A108WX3',
      blocked: 0,
      balance: 7,
      positionUid: '41be4f89-9d19-4eac-9ae4-09276f85956a',
      instrumentUid: '1d0e01e5-148c-40e5-bb8f-1bf2d8e03c1a',
      exchangeBlocked: false,
      instrumentType: 'etf'
    },
    {
      figi: 'TCS60A101X76',
      blocked: 0,
      balance: 106,
      positionUid: 'ffd48f38-aa9b-491c-8e40-140a3f0bc931',
      instrumentUid: 'f509af83-6e71-462f-901f-bcb073f6773b',
      exchangeBlocked: false,
      instrumentType: 'etf'
    },
    {
      figi: 'TCS70A10A1L8',
      blocked: 0,
      balance: 52,
      positionUid: '83fd264c-28fc-4b6a-b8f2-ae090148050d',
      instrumentUid: 'c5049184-ded4-49d0-8e14-bffefc40a223',
      exchangeBlocked: false,
      instrumentType: 'etf'
    }
  ],
  limitsLoadingInProgress: false,
  futures: [],
  options: [],
  accountId: '2272547076'
}
2025-09-04T15:23:15.688Z bot:provider portfolioPositions [
  {
    figi: 'TCS00A108WX3',
    instrumentType: 'etf',
    quantity: { units: 7, nano: 0 },
    averagePositionPrice: { currency: 'rub', units: 100, nano: 680000000 },
    expectedYield: { units: 0, nano: 10000000 },
    currentNkd: undefined,
    averagePositionPricePt: { units: 0, nano: 0 },
    currentPrice: { currency: 'rub', units: 100, nano: 680000000 },
    averagePositionPriceFifo: { currency: 'rub', units: 100, nano: 680000000 },
    quantityLots: { units: 7, nano: 0 },
    blocked: false,
    blockedLots: { units: 0, nano: 0 },
    positionUid: '41be4f89-9d19-4eac-9ae4-09276f85956a',
    instrumentUid: '1d0e01e5-148c-40e5-bb8f-1bf2d8e03c1a',
    varMargin: { currency: '', units: 0, nano: 0 },
    expectedYieldFifo: { units: 0, nano: 10000000 },
    dailyYield: { currency: 'rub', units: 0, nano: 10000000 }
  },
  {
    figi: 'RUB000UTSTOM',
    instrumentType: 'currency',
    quantity: { units: -1165, nano: -680000000 },
    averagePositionPrice: { currency: 'rub', units: 1, nano: 0 },
    expectedYield: { units: 0, nano: 0 },
    currentNkd: undefined,
    averagePositionPricePt: { units: 0, nano: 0 },
    currentPrice: { currency: 'rub', units: 1, nano: 0 },
    averagePositionPriceFifo: { currency: 'rub', units: 1, nano: 0 },
    quantityLots: { units: -1165, nano: -680000000 },
    blocked: false,
    blockedLots: { units: 0, nano: 0 },
    positionUid: '33e24a92-aab0-409c-88b8-f2d57415b920',
    instrumentUid: 'a92e2e25-a698-45cc-a781-167cf465257c',
    varMargin: { currency: '', units: 0, nano: 0 },
    expectedYieldFifo: { units: 0, nano: 0 },
    dailyYield: { currency: 'rub', units: 0, nano: 0 }
  },
  {
    figi: 'TCS70A10A1L8',
    instrumentType: 'etf',
    quantity: { units: 52, nano: 0 },
    averagePositionPrice: { currency: 'rub', units: 13, nano: 440000000 },
    expectedYield: { units: 0, nano: 140000000 },
    currentNkd: undefined,
    averagePositionPricePt: { units: 0, nano: 0 },
    currentPrice: { currency: 'rub', units: 13, nano: 440000000 },
    averagePositionPriceFifo: { currency: 'rub', units: 13, nano: 440000000 },
    quantityLots: { units: 52, nano: 0 },
    blocked: false,
    blockedLots: { units: 0, nano: 0 },
    positionUid: '83fd264c-28fc-4b6a-b8f2-ae090148050d',
    instrumentUid: 'c5049184-ded4-49d0-8e14-bffefc40a223',
    varMargin: { currency: '', units: 0, nano: 0 },
    expectedYieldFifo: { units: 0, nano: 140000000 },
    dailyYield: { currency: 'rub', units: 0, nano: 140000000 }
  },
  {
    figi: 'TCS60A101X76',
    instrumentType: 'etf',
    quantity: { units: 106, nano: 0 },
    averagePositionPrice: { currency: 'rub', units: 6, nano: 650000000 },
    expectedYield: { units: 0, nano: 140000000 },
    currentNkd: undefined,
    averagePositionPricePt: { units: 0, nano: 0 },
    currentPrice: { currency: 'rub', units: 6, nano: 650000000 },
    averagePositionPriceFifo: { currency: 'rub', units: 6, nano: 650000000 },
    quantityLots: { units: 106, nano: 0 },
    blocked: false,
    blockedLots: { units: 0, nano: 0 },
    positionUid: 'ffd48f38-aa9b-491c-8e40-140a3f0bc931',
    instrumentUid: 'f509af83-6e71-462f-901f-bcb073f6773b',
    varMargin: { currency: '', units: 0, nano: 0 },
    expectedYieldFifo: { units: 0, nano: 140000000 },
    dailyYield: { currency: 'rub', units: 0, nano: 140000000 }
  }
]
2025-09-04T15:23:15.689Z bot:provider Adding currencies to Wallet
2025-09-04T15:23:15.689Z bot:provider corePosition {
  pair: 'RUB/RUB',
  base: 'RUB',
  quote: 'RUB',
  figi: undefined,
  amount: -1164.32,
  lotSize: 1,
  price: { units: 1, nano: 0 },
  priceNumber: 1,
  lotPrice: { units: 1, nano: 0 }
}
2025-09-04T15:23:15.689Z bot:provider Adding positions to Wallet
2025-09-04T15:23:15.689Z bot:provider position {
  figi: 'TCS00A108WX3',
  instrumentType: 'etf',
  quantity: { units: 7, nano: 0 },
  averagePositionPrice: { currency: 'rub', units: 100, nano: 680000000 },
  expectedYield: { units: 0, nano: 10000000 },
  currentNkd: undefined,
  averagePositionPricePt: { units: 0, nano: 0 },
  currentPrice: { currency: 'rub', units: 100, nano: 680000000 },
  averagePositionPriceFifo: { currency: 'rub', units: 100, nano: 680000000 },
  quantityLots: { units: 7, nano: 0 },
  blocked: false,
  blockedLots: { units: 0, nano: 0 },
  positionUid: '41be4f89-9d19-4eac-9ae4-09276f85956a',
  instrumentUid: '1d0e01e5-148c-40e5-bb8f-1bf2d8e03c1a',
  varMargin: { currency: '', units: 0, nano: 0 },
  expectedYieldFifo: { units: 0, nano: 10000000 },
  dailyYield: { currency: 'rub', units: 0, nano: 10000000 }
}
2025-09-04T15:23:15.692Z bot:provider instrument {
  figi: 'TCS00A108WX3',
  ticker: 'TPAY',
  classCode: 'TQTF',
  isin: 'RU000A108WX3',
  lot: 1,
  currency: 'rub',
  klong: { units: 2, nano: 0 },
  kshort: { units: 2, nano: 0 },
  dlong: { units: 0, nano: 166600000 },
  dshort: undefined,
  dlongMin: { units: 0, nano: 153800000 },
  dshortMin: undefined,
  shortEnabledFlag: false,
  name: '–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥',
  exchange: 'moex_etf_evening',
  fixedCommission: { units: 0, nano: 900000000 },
  focusType: 'fixed_income',
  releasedDate: 2024-06-27T00:00:00.000Z,
  numShares: undefined,
  countryOfRisk: 'RU',
  countryOfRiskName: '–†–æ—Å—Å–∏–π—Å–∫–∞—è –§–µ–¥–µ—Ä–∞—Ü–∏—è',
  sector: 'other',
  rebalancingFreq: 'semi_annual',
  tradingStatus: 5,
  otcFlag: false,
  buyAvailableFlag: true,
  sellAvailableFlag: true,
  minPriceIncrement: { units: 0, nano: 10000000 },
  apiTradeAvailableFlag: true,
  uid: '1d0e01e5-148c-40e5-bb8f-1bf2d8e03c1a',
  realExchange: 1,
  positionUid: '41be4f89-9d19-4eac-9ae4-09276f85956a',
  assetUid: 'a9f74b0a-f3dc-4a25-aebe-7fb1732dd510',
  instrumentExchange: 0,
  forIisFlag: true,
  forQualInvestorFlag: false,
  weekendFlag: false,
  blockedTcaFlag: false,
  liquidityFlag: true,
  first1minCandleDate: 2024-08-12T06:59:00.000Z,
  first1dayCandleDate: 2024-08-12T00:00:00.000Z,
  brand: {
    logoName: 'TPAY.png',
    logoBaseColor: '#000000',
    textColor: '#ffffff'
  },
  dlongClient: { units: 0, nano: 153800000 },
  dshortClient: { units: 0, nano: 0 }
}
2025-09-04T15:23:15.693Z bot:provider Getting last price
2025-09-04T15:23:15.875Z bot:provider lastPriceResult {
  lastPrices: [
    {
      figi: 'TCS00A108WX3',
      price: [Object],
      time: 2025-09-04T15:23:44.786Z,
      instrumentUid: '1d0e01e5-148c-40e5-bb8f-1bf2d8e03c1a',
      lastPriceType: 1
    }
  ]
}
2025-09-04T15:23:15.875Z bot:provider lastPrice { units: 100, nano: 680000000 }
2025-09-04T15:23:20.876Z bot:provider priceWhenAddToWallet { units: 100, nano: 680000000 }
2025-09-04T15:23:20.876Z bot:provider corePosition {
  pair: 'TPAY/RUB',
  base: 'TPAY',
  quote: 'RUB',
  figi: 'TCS00A108WX3',
  amount: 7,
  lotSize: 1,
  price: { units: 100, nano: 680000000 },
  priceNumber: 100.68,
  lotPrice: { units: 100, nano: 680000000 },
  totalPrice: { units: 704, nano: 760000000 },
  totalPriceNumber: 704.76,
  averagePositionPriceFifoNumber: 100.68,
  averagePositionPriceNumber: 100.68
}
2025-09-04T15:23:20.876Z bot:provider position {
  figi: 'RUB000UTSTOM',
  instrumentType: 'currency',
  quantity: { units: -1165, nano: -680000000 },
  averagePositionPrice: { currency: 'rub', units: 1, nano: 0 },
  expectedYield: { units: 0, nano: 0 },
  currentNkd: undefined,
  averagePositionPricePt: { units: 0, nano: 0 },
  currentPrice: { currency: 'rub', units: 1, nano: 0 },
  averagePositionPriceFifo: { currency: 'rub', units: 1, nano: 0 },
  quantityLots: { units: -1165, nano: -680000000 },
  blocked: false,
  blockedLots: { units: 0, nano: 0 },
  positionUid: '33e24a92-aab0-409c-88b8-f2d57415b920',
  instrumentUid: 'a92e2e25-a698-45cc-a781-167cf465257c',
  varMargin: { currency: '', units: 0, nano: 0 },
  expectedYieldFifo: { units: 0, nano: 0 },
  dailyYield: { currency: 'rub', units: 0, nano: 0 }
}
2025-09-04T15:23:20.877Z bot:provider instrument undefined
2025-09-04T15:23:20.877Z bot:provider instrument not found by figi, skip position RUB000UTSTOM
2025-09-04T15:23:20.877Z bot:provider position {
  figi: 'TCS70A10A1L8',
  instrumentType: 'etf',
  quantity: { units: 52, nano: 0 },
  averagePositionPrice: { currency: 'rub', units: 13, nano: 440000000 },
  expectedYield: { units: 0, nano: 140000000 },
  currentNkd: undefined,
  averagePositionPricePt: { units: 0, nano: 0 },
  currentPrice: { currency: 'rub', units: 13, nano: 440000000 },
  averagePositionPriceFifo: { currency: 'rub', units: 13, nano: 440000000 },
  quantityLots: { units: 52, nano: 0 },
  blocked: false,
  blockedLots: { units: 0, nano: 0 },
  positionUid: '83fd264c-28fc-4b6a-b8f2-ae090148050d',
  instrumentUid: 'c5049184-ded4-49d0-8e14-bffefc40a223',
  varMargin: { currency: '', units: 0, nano: 0 },
  expectedYieldFifo: { units: 0, nano: 140000000 },
  dailyYield: { currency: 'rub', units: 0, nano: 140000000 }
}
2025-09-04T15:23:20.877Z bot:provider instrument {
  figi: 'TCS70A10A1L8',
  ticker: 'TOFZ@',
  classCode: 'SPBRU',
  isin: 'RU000A10A1L8',
  lot: 1,
  currency: 'rub',
  klong: { units: 2, nano: 0 },
  kshort: { units: 2, nano: 0 },
  dlong: { units: 0, nano: 250000000 },
  dshort: { units: 0, nano: 300000000 },
  dlongMin: { units: 0, nano: 200000000 },
  dshortMin: { units: 0, nano: 250000000 },
  shortEnabledFlag: true,
  name: '–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±–ª–∏–≥–∞—Ü–∏–∏',
  exchange: 'spb_etf_ru_noweekend',
  fixedCommission: { units: 1, nano: 500000000 },
  focusType: 'fixed_income',
  releasedDate: 2024-11-07T00:00:00.000Z,
  numShares: undefined,
  countryOfRisk: 'RU',
  countryOfRiskName: '–†–æ—Å—Å–∏–π—Å–∫–∞—è –§–µ–¥–µ—Ä–∞—Ü–∏—è',
  sector: 'other',
  rebalancingFreq: 'semi_annual',
  tradingStatus: 5,
  otcFlag: false,
  buyAvailableFlag: true,
  sellAvailableFlag: true,
  minPriceIncrement: { units: 0, nano: 10000000 },
  apiTradeAvailableFlag: true,
  uid: 'c5049184-ded4-49d0-8e14-bffefc40a223',
  realExchange: 2,
  positionUid: '83fd264c-28fc-4b6a-b8f2-ae090148050d',
  assetUid: 'a20a8e51-dd4e-4ba3-beb0-a9bf4dd0a983',
  instrumentExchange: 0,
  forIisFlag: true,
  forQualInvestorFlag: false,
  weekendFlag: false,
  blockedTcaFlag: false,
  liquidityFlag: true,
  first1minCandleDate: 2024-12-09T07:02:00.000Z,
  first1dayCandleDate: 2024-12-09T00:00:00.000Z,
  brand: {
    logoName: 'TOFZ.png',
    logoBaseColor: '#000000',
    textColor: '#ffffff'
  },
  dlongClient: { units: 0, nano: 200000000 },
  dshortClient: { units: 0, nano: 250000000 }
}
2025-09-04T15:23:20.878Z bot:provider Getting last price
2025-09-04T15:23:21.034Z bot:provider lastPriceResult {
  lastPrices: [
    {
      figi: 'TCS70A10A1L8',
      price: [Object],
      time: 2025-09-04T15:22:47.545Z,
      instrumentUid: 'c5049184-ded4-49d0-8e14-bffefc40a223',
      lastPriceType: 1
    }
  ]
}
2025-09-04T15:23:21.035Z bot:provider lastPrice { units: 13, nano: 440000000 }
2025-09-04T15:23:26.037Z bot:provider priceWhenAddToWallet { units: 13, nano: 440000000 }
2025-09-04T15:23:26.037Z bot:provider corePosition {
  pair: 'TOFZ@/RUB',
  base: 'TOFZ@',
  quote: 'RUB',
  figi: 'TCS70A10A1L8',
  amount: 52,
  lotSize: 1,
  price: { units: 13, nano: 440000000 },
  priceNumber: 13.44,
  lotPrice: { units: 13, nano: 440000000 },
  totalPrice: { units: 698, nano: 880000000 },
  totalPriceNumber: 698.88,
  averagePositionPriceFifoNumber: 13.44,
  averagePositionPriceNumber: 13.44
}
2025-09-04T15:23:26.038Z bot:provider position {
  figi: 'TCS60A101X76',
  instrumentType: 'etf',
  quantity: { units: 106, nano: 0 },
  averagePositionPrice: { currency: 'rub', units: 6, nano: 650000000 },
  expectedYield: { units: 0, nano: 140000000 },
  currentNkd: undefined,
  averagePositionPricePt: { units: 0, nano: 0 },
  currentPrice: { currency: 'rub', units: 6, nano: 650000000 },
  averagePositionPriceFifo: { currency: 'rub', units: 6, nano: 650000000 },
  quantityLots: { units: 106, nano: 0 },
  blocked: false,
  blockedLots: { units: 0, nano: 0 },
  positionUid: 'ffd48f38-aa9b-491c-8e40-140a3f0bc931',
  instrumentUid: 'f509af83-6e71-462f-901f-bcb073f6773b',
  varMargin: { currency: '', units: 0, nano: 0 },
  expectedYieldFifo: { units: 0, nano: 140000000 },
  dailyYield: { currency: 'rub', units: 0, nano: 140000000 }
}
2025-09-04T15:23:26.040Z bot:provider instrument {
  figi: 'TCS60A101X76',
  ticker: 'TMOS@',
  classCode: 'SPBRU',
  isin: 'RU000A101X76',
  lot: 1,
  currency: 'rub',
  klong: { units: 2, nano: 0 },
  kshort: { units: 2, nano: 0 },
  dlong: { units: 0, nano: 181800000 },
  dshort: { units: 0, nano: 200000000 },
  dlongMin: { units: 0, nano: 125000000 },
  dshortMin: { units: 0, nano: 142800000 },
  shortEnabledFlag: true,
  name: '–ö—Ä—É–ø–Ω–µ–π—à–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –†–§',
  exchange: 'spb_etf_ru_noweekend',
  fixedCommission: { units: 0, nano: 700000000 },
  focusType: 'equity',
  releasedDate: 2020-07-13T00:00:00.000Z,
  numShares: undefined,
  countryOfRisk: 'RU',
  countryOfRiskName: '–†–æ—Å—Å–∏–π—Å–∫–∞—è –§–µ–¥–µ—Ä–∞—Ü–∏—è',
  sector: 'other',
  rebalancingFreq: 'quarterly',
  tradingStatus: 5,
  otcFlag: false,
  buyAvailableFlag: true,
  sellAvailableFlag: true,
  minPriceIncrement: { units: 0, nano: 10000000 },
  apiTradeAvailableFlag: true,
  uid: 'f509af83-6e71-462f-901f-bcb073f6773b',
  realExchange: 2,
  positionUid: 'ffd48f38-aa9b-491c-8e40-140a3f0bc931',
  assetUid: '41ee95a0-318f-49e1-bfe4-2c3f7c83fe21',
  instrumentExchange: 0,
  forIisFlag: true,
  forQualInvestorFlag: false,
  weekendFlag: false,
  blockedTcaFlag: false,
  liquidityFlag: true,
  first1minCandleDate: 2020-08-26T07:14:00.000Z,
  first1dayCandleDate: 2020-08-26T07:00:00.000Z,
  brand: {
    logoName: 'TMOS.png',
    logoBaseColor: '#000000',
    textColor: '#ffffff'
  },
  dlongClient: { units: 0, nano: 125000000 },
  dshortClient: { units: 0, nano: 142800000 }
}
2025-09-04T15:23:26.041Z bot:provider Getting last price
2025-09-04T15:23:26.176Z bot:provider lastPriceResult {
  lastPrices: [
    {
      figi: 'TCS60A101X76',
      price: [Object],
      time: 2025-09-04T15:23:48.011Z,
      instrumentUid: 'f509af83-6e71-462f-901f-bcb073f6773b',
      lastPriceType: 1
    }
  ]
}
2025-09-04T15:23:26.177Z bot:provider lastPrice { units: 6, nano: 650000000 }
2025-09-04T15:23:31.178Z bot:provider priceWhenAddToWallet { units: 6, nano: 650000000 }
2025-09-04T15:23:31.178Z bot:provider corePosition {
  pair: 'TMOS@/RUB',
  base: 'TMOS@',
  quote: 'RUB',
  figi: 'TCS60A101X76',
  amount: 106,
  lotSize: 1,
  price: { units: 6, nano: 650000000 },
  priceNumber: 6.65,
  lotPrice: { units: 6, nano: 650000000 },
  totalPrice: { units: 704, nano: 900000000 },
  totalPriceNumber: 704.9000000000001,
  averagePositionPriceFifoNumber: 6.65,
  averagePositionPriceNumber: 6.65
}
2025-09-04T15:23:31.179Z bot:provider [
  {
    pair: 'RUB/RUB',
    base: 'RUB',
    quote: 'RUB',
    figi: undefined,
    amount: -1164.32,
    lotSize: 1,
    price: { units: 1, nano: 0 },
    priceNumber: 1,
    lotPrice: { units: 1, nano: 0 }
  },
  {
    pair: 'TPAY/RUB',
    base: 'TPAY',
    quote: 'RUB',
    figi: 'TCS00A108WX3',
    amount: 7,
    lotSize: 1,
    price: { units: 100, nano: 680000000 },
    priceNumber: 100.68,
    lotPrice: { units: 100, nano: 680000000 },
    totalPrice: { units: 704, nano: 760000000 },
    totalPriceNumber: 704.76,
    averagePositionPriceFifoNumber: 100.68,
    averagePositionPriceNumber: 100.68
  },
  {
    pair: 'TOFZ@/RUB',
    base: 'TOFZ@',
    quote: 'RUB',
    figi: 'TCS70A10A1L8',
    amount: 52,
    lotSize: 1,
    price: { units: 13, nano: 440000000 },
    priceNumber: 13.44,
    lotPrice: { units: 13, nano: 440000000 },
    totalPrice: { units: 698, nano: 880000000 },
    totalPriceNumber: 698.88,
    averagePositionPriceFifoNumber: 13.44,
    averagePositionPriceNumber: 13.44
  },
  {
    pair: 'TMOS@/RUB',
    base: 'TMOS@',
    quote: 'RUB',
    figi: 'TCS60A101X76',
    amount: 106,
    lotSize: 1,
    price: { units: 6, nano: 650000000 },
    priceNumber: 6.65,
    lotPrice: { units: 6, nano: 650000000 },
    totalPrice: { units: 704, nano: 900000000 },
    totalPriceNumber: 704.9000000000001,
    averagePositionPriceFifoNumber: 6.65,
    averagePositionPriceNumber: 6.65
  }
]
[etfCap] buildAumMapSmart: fetched HTML length=242693
[etfCap] buildAumMapSmart: auto result: {}
[etfCap] [DEBUG] TMON AUM search: FOUND
[etfCap] [DEBUG] TMOS AUM search: FOUND
[etfCap] [DEBUG] TOFZ AUM search: FOUND
[etfCap] buildAumMapSmart: final result: {
  TMON: {
    amount: 212625657935.99,
    currency: "RUB",
  },
  TMOS: {
    amount: 12125435811.93,
    currency: "RUB",
  },
  TOFZ: {
    amount: 4175228269.23,
    currency: "RUB",
  },
  TPAY: {
    amount: 22635393237.16,
    currency: "RUB",
  },
}
[pollEtfMetrics] symbol=TMON search sharesCount via Smartfeed API
[pollEtfMetrics] smartfeed brand=–î–µ–Ω–µ–∂–Ω—ã–π —Ä—ã–Ω–æ–∫ news=50 cursorNext=ts:1751478495000‚Ä¶
[pollEtfMetrics] smartfeed hit id=18549220 title=–í —Ñ–æ–Ω–¥ –ø–æ—Å—Ç—É–ø–∏–ª–∏ –Ω–æ–≤—ã–µ –¥–µ–Ω—å–≥–∏ count=1510500000
[pollEtfMetrics] price: lastPriceRUB=142.29 for TMON
[pollEtfMetrics] payload TMON: price=142.29 shares=1510500000 aum=212625657935.99 mcap=214929045000
[pollEtfMetrics] saved /Users/suenot/projects/tinkoff-invest-etf-balancer-bot/etf_metrics/TMON.json
[pollEtfMetrics] symbol=TMOS search sharesCount via Smartfeed API
[pollEtfMetrics] smartfeed brand=–ö—Ä—É–ø–Ω–µ–π—à–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –†–§ news=50 cursorNext=ts:1753274815243‚Ä¶
[pollEtfMetrics] smartfeed hit id=18549215 title=–í —Ñ–æ–Ω–¥ –ø–æ—Å—Ç—É–ø–∏–ª–∏ –Ω–æ–≤—ã–µ –¥–µ–Ω—å–≥–∏ count=1849600000
[pollEtfMetrics] price: lastPriceRUB=6.63 for TMOS
[pollEtfMetrics] payload TMOS: price=6.63 shares=1849600000 aum=12125435811.93 mcap=12262848000
[pollEtfMetrics] saved /Users/suenot/projects/tinkoff-invest-etf-balancer-bot/etf_metrics/TMOS.json
[pollEtfMetrics] symbol=TOFZ search sharesCount via Smartfeed API
[pollEtfMetrics] smartfeed brand=–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±–ª–∏–≥–∞—Ü–∏–∏ news=50 cursorNext=ts:1753448223549‚Ä¶
[pollEtfMetrics] smartfeed hit id=18549219 title=–í —Ñ–æ–Ω–¥ –ø–æ—Å—Ç—É–ø–∏–ª–∏ –Ω–æ–≤—ã–µ –¥–µ–Ω—å–≥–∏ count=315900000
[pollEtfMetrics] price: lastPriceRUB=13.44 for TOFZ
[pollEtfMetrics] payload TOFZ: price=13.44 shares=315900000 aum=4175228269.23 mcap=4245696000
[pollEtfMetrics] saved /Users/suenot/projects/tinkoff-invest-etf-balancer-bot/etf_metrics/TOFZ.json
[pollEtfMetrics] symbol=TPAY search sharesCount via Smartfeed API
[pollEtfMetrics] smartfeed brand=–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ news=50 cursorNext=ts:1755089428151‚Ä¶
[pollEtfMetrics] smartfeed brand=–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ news=50 cursorNext=ts:1752238292570‚Ä¶
[pollEtfMetrics] smartfeed brand=–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ news=50 cursorNext=ts:1750254973012‚Ä¶
[pollEtfMetrics] smartfeed brand=–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ news=50 cursorNext=ts:1747144158727‚Ä¶
[pollEtfMetrics] smartfeed hit id=18548236 title=–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞–µ–≤ –≤ –æ–±—Ä–∞—â–µ–Ω–∏–∏ —É–º–µ–Ω—å—à–∏–ª–æ—Å—å count=225600000
[pollEtfMetrics] price: lastPriceRUB=100.68 for TPAY
[pollEtfMetrics] payload TPAY: price=100.68 shares=225600000 aum=22635393237.16 mcap=22713408000
[pollEtfMetrics] saved /Users/suenot/projects/tinkoff-invest-etf-balancer-bot/etf_metrics/TPAY.json

üìä Successfully applied mode: manual

üîç DIAGNOSIS: Portfolio state BEFORE balancing
üìä Total positions in coreWallet: 4
üí∞ RUB balance before: -1164.32
‚è∞ Timestamp before balancing: 2025-09-04T15:23:44.865Z
2025-09-04T15:23:44.869Z bot:balancer Buy requires total marginal sell is enabled, checking for special handling
2025-09-04T15:23:44.870Z bot:balancer Margin strategy: {
  shouldRemoveMargin: false,
  reason: 'Strategy: keep margin (sum 2108.54 rub <= max 5000 rub, time to close: 22 min)',
  transferCost: 0,
  timeInfo: { timeToClose: 22, timeToNextBalance: 60, isLastBalance: true },
  marginPositions: [
    {
      pair: 'TPAY/RUB',
      base: 'TPAY',
      quote: 'RUB',
      figi: 'TCS00A108WX3',
      amount: 7,
      lotSize: 1,
      price: [Object],
      priceNumber: 100.68,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 704.76,
      averagePositionPriceFifoNumber: 100.68,
      averagePositionPriceNumber: 100.68,
      isMargin: true,
      marginValue: 469.84000000000003,
      leverage: 3,
      marginCall: false
    },
    {
      pair: 'TOFZ@/RUB',
      base: 'TOFZ@',
      quote: 'RUB',
      figi: 'TCS70A10A1L8',
      amount: 52,
      lotSize: 1,
      price: [Object],
      priceNumber: 13.44,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 698.88,
      averagePositionPriceFifoNumber: 13.44,
      averagePositionPriceNumber: 13.44,
      isMargin: true,
      marginValue: 465.91999999999996,
      leverage: 3,
      marginCall: false
    },
    {
      pair: 'TMOS@/RUB',
      base: 'TMOS@',
      quote: 'RUB',
      figi: 'TCS60A101X76',
      amount: 106,
      lotSize: 1,
      price: [Object],
      priceNumber: 6.65,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 704.9000000000001,
      averagePositionPriceFifoNumber: 6.65,
      averagePositionPriceNumber: 6.65,
      isMargin: true,
      marginValue: 469.9333333333334,
      leverage: 3,
      marginCall: false
    }
  ]
}
2025-09-04T15:23:44.871Z bot:balancer Normalizing percentages to make total sum equal 100%, to exclude human factor
2025-09-04T15:23:44.871Z bot:balancer desiredWallet { TMON: 8.33, TMOS: 8.33, TOFZ: 8.33, TPAY: 8.33 }
2025-09-04T15:23:44.871Z bot:balancer desiredSum 33.32
2025-09-04T15:23:44.871Z bot:balancer normalizedDesire { TMON: 25, TMOS: 25, TOFZ: 25, TPAY: 25 }
2025-09-04T15:23:44.872Z bot:balancer Adding missing instruments from portfolio to DesireWallet with value 0
2025-09-04T15:23:44.872Z bot:balancer RUB not found in desired portfolio, adding with value 0.
2025-09-04T15:23:44.872Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:23:44.872Z bot:balancer positionIndex -1
2025-09-04T15:23:44.872Z bot:balancer Ticker from DesireWallet not found in portfolio. Creating.
2025-09-04T15:23:44.873Z bot:balancer {
  figi: 'TCS70A106DL2',
  ticker: 'TMON@',
  classCode: 'SPBRU',
  isin: 'RU000A106DL2',
  lot: 1,
  currency: 'rub',
  klong: { units: 2, nano: 0 },
  kshort: { units: 2, nano: 0 },
  dlong: { units: 0, nano: 66600000 },
  dshort: undefined,
  dlongMin: { units: 0, nano: 50000000 },
  dshortMin: undefined,
  shortEnabledFlag: false,
  name: '–î–µ–Ω–µ–∂–Ω—ã–π —Ä—ã–Ω–æ–∫',
  exchange: 'spb_etf_ru',
  fixedCommission: { units: 1, nano: 0 },
  focusType: 'equity',
  releasedDate: 2022-12-22T00:00:00.000Z,
  numShares: undefined,
  countryOfRisk: 'RU',
  countryOfRiskName: '–†–æ—Å—Å–∏–π—Å–∫–∞—è –§–µ–¥–µ—Ä–∞—Ü–∏—è',
  sector: 'other',
  rebalancingFreq: '',
  tradingStatus: 5,
  otcFlag: false,
  buyAvailableFlag: true,
  sellAvailableFlag: true,
  minPriceIncrement: { units: 0, nano: 10000000 },
  apiTradeAvailableFlag: true,
  uid: '498ec3ff-ef27-4729-9703-a5aac48d5789',
  realExchange: 2,
  positionUid: '96a4604c-79d9-4a30-8a46-95a80dfd9f02',
  assetUid: 'e16bc6c8-63c2-4023-8c95-e0d212aac4b8',
  instrumentExchange: 0,
  forIisFlag: true,
  forQualInvestorFlag: false,
  weekendFlag: false,
  blockedTcaFlag: false,
  liquidityFlag: true,
  first1minCandleDate: 2025-02-25T07:00:00.000Z,
  first1dayCandleDate: 2025-02-25T00:00:00.000Z,
  brand: {
    logoName: 'TMON2.png',
    logoBaseColor: '#000000',
    textColor: '#ffffff'
  },
  dlongClient: { units: 0, nano: 50000000 },
  dshortClient: { units: 0, nano: 0 }
}
2025-09-04T15:23:44.873Z bot:balancer TCS70A106DL2
2025-09-04T15:23:44.873Z bot:balancer 1
2025-09-04T15:23:44.873Z bot:provider Getting last price
2025-09-04T15:23:45.016Z bot:provider lastPriceResult {
  lastPrices: [
    {
      figi: 'TCS70A106DL2',
      price: [Object],
      time: 2025-09-04T15:24:14.846Z,
      instrumentUid: '498ec3ff-ef27-4729-9703-a5aac48d5789',
      lastPriceType: 1
    }
  ]
}
2025-09-04T15:23:45.016Z bot:provider lastPrice { units: 142, nano: 290000000 }
2025-09-04T15:23:50.018Z bot:balancer newPosition {
  pair: 'TMON/RUB',
  base: 'TMON',
  quote: 'RUB',
  figi: 'TCS70A106DL2',
  price: { units: 142, nano: 290000000 },
  priceNumber: 142.29,
  amount: 0,
  lotSize: 1,
  lotPrice: { units: 142, nano: 290000000 }
}
2025-09-04T15:23:50.019Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:23:50.019Z bot:balancer positionIndex 3
2025-09-04T15:23:50.019Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:23:50.019Z bot:balancer positionIndex 2
2025-09-04T15:23:50.019Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:23:50.019Z bot:balancer positionIndex 1
2025-09-04T15:23:50.019Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:23:50.019Z bot:balancer positionIndex 0
2025-09-04T15:23:50.019Z bot:balancer Calculating totalPrice
2025-09-04T15:23:50.020Z bot:balancer walletWithtotalPrice: map start: position {
  pair: 'RUB/RUB',
  base: 'RUB',
  quote: 'RUB',
  figi: undefined,
  amount: -1164.32,
  lotSize: 1,
  price: { units: 1, nano: 0 },
  priceNumber: 1,
  lotPrice: { units: 1, nano: 0 }
}
2025-09-04T15:23:50.020Z bot:balancer lotPriceNumber 1
2025-09-04T15:23:50.020Z bot:balancer position.amount, position.priceNumber
2025-09-04T15:23:50.020Z bot:balancer -1164.32 1
2025-09-04T15:23:50.020Z bot:balancer totalPriceNumber -1164.32
2025-09-04T15:23:50.020Z bot:balancer totalPrice { units: -1164, nano: 320000000 }
2025-09-04T15:23:50.020Z bot:balancer walletWithtotalPrice: map end: position {
  pair: 'RUB/RUB',
  base: 'RUB',
  quote: 'RUB',
  figi: undefined,
  amount: -1164.32,
  lotSize: 1,
  price: { units: 1, nano: 0 },
  priceNumber: 1,
  lotPrice: { units: 1, nano: 0 },
  totalPrice: { units: -1164, nano: 320000000 }
}
2025-09-04T15:23:50.020Z bot:balancer walletWithtotalPrice: map start: position {
  pair: 'TPAY/RUB',
  base: 'TPAY',
  quote: 'RUB',
  figi: 'TCS00A108WX3',
  amount: 7,
  lotSize: 1,
  price: { units: 100, nano: 680000000 },
  priceNumber: 100.68,
  lotPrice: { units: 100, nano: 680000000 },
  totalPrice: { units: 704, nano: 760000000 },
  totalPriceNumber: 704.76,
  averagePositionPriceFifoNumber: 100.68,
  averagePositionPriceNumber: 100.68
}
2025-09-04T15:23:50.020Z bot:balancer lotPriceNumber 100.68
2025-09-04T15:23:50.020Z bot:balancer position.amount, position.priceNumber
2025-09-04T15:23:50.020Z bot:balancer 7 100.68
2025-09-04T15:23:50.020Z bot:balancer totalPriceNumber 704.76
2025-09-04T15:23:50.020Z bot:balancer totalPrice { units: 704, nano: 760000000 }
2025-09-04T15:23:50.020Z bot:balancer walletWithtotalPrice: map end: position {
  pair: 'TPAY/RUB',
  base: 'TPAY',
  quote: 'RUB',
  figi: 'TCS00A108WX3',
  amount: 7,
  lotSize: 1,
  price: { units: 100, nano: 680000000 },
  priceNumber: 100.68,
  lotPrice: { units: 100, nano: 680000000 },
  totalPrice: { units: 704, nano: 760000000 },
  totalPriceNumber: 704.76,
  averagePositionPriceFifoNumber: 100.68,
  averagePositionPriceNumber: 100.68
}
2025-09-04T15:23:50.020Z bot:balancer walletWithtotalPrice: map start: position {
  pair: 'TOFZ@/RUB',
  base: 'TOFZ@',
  quote: 'RUB',
  figi: 'TCS70A10A1L8',
  amount: 52,
  lotSize: 1,
  price: { units: 13, nano: 440000000 },
  priceNumber: 13.44,
  lotPrice: { units: 13, nano: 440000000 },
  totalPrice: { units: 698, nano: 880000000 },
  totalPriceNumber: 698.88,
  averagePositionPriceFifoNumber: 13.44,
  averagePositionPriceNumber: 13.44
}
2025-09-04T15:23:50.021Z bot:balancer lotPriceNumber 13.44
2025-09-04T15:23:50.021Z bot:balancer position.amount, position.priceNumber
2025-09-04T15:23:50.021Z bot:balancer 52 13.44
2025-09-04T15:23:50.021Z bot:balancer totalPriceNumber 698.88
2025-09-04T15:23:50.021Z bot:balancer totalPrice { units: 698, nano: 880000000 }
2025-09-04T15:23:50.021Z bot:balancer walletWithtotalPrice: map end: position {
  pair: 'TOFZ@/RUB',
  base: 'TOFZ@',
  quote: 'RUB',
  figi: 'TCS70A10A1L8',
  amount: 52,
  lotSize: 1,
  price: { units: 13, nano: 440000000 },
  priceNumber: 13.44,
  lotPrice: { units: 13, nano: 440000000 },
  totalPrice: { units: 698, nano: 880000000 },
  totalPriceNumber: 698.88,
  averagePositionPriceFifoNumber: 13.44,
  averagePositionPriceNumber: 13.44
}
2025-09-04T15:23:50.021Z bot:balancer walletWithtotalPrice: map start: position {
  pair: 'TMOS@/RUB',
  base: 'TMOS@',
  quote: 'RUB',
  figi: 'TCS60A101X76',
  amount: 106,
  lotSize: 1,
  price: { units: 6, nano: 650000000 },
  priceNumber: 6.65,
  lotPrice: { units: 6, nano: 650000000 },
  totalPrice: { units: 704, nano: 900000000 },
  totalPriceNumber: 704.9000000000001,
  averagePositionPriceFifoNumber: 6.65,
  averagePositionPriceNumber: 6.65
}
2025-09-04T15:23:50.021Z bot:balancer lotPriceNumber 6.65
2025-09-04T15:23:50.021Z bot:balancer position.amount, position.priceNumber
2025-09-04T15:23:50.021Z bot:balancer 106 6.65
2025-09-04T15:23:50.021Z bot:balancer totalPriceNumber 704.9000000000001
2025-09-04T15:23:50.021Z bot:balancer totalPrice { units: 704, nano: 900000000 }
2025-09-04T15:23:50.021Z bot:balancer walletWithtotalPrice: map end: position {
  pair: 'TMOS@/RUB',
  base: 'TMOS@',
  quote: 'RUB',
  figi: 'TCS60A101X76',
  amount: 106,
  lotSize: 1,
  price: { units: 6, nano: 650000000 },
  priceNumber: 6.65,
  lotPrice: { units: 6, nano: 650000000 },
  totalPrice: { units: 704, nano: 900000000 },
  totalPriceNumber: 704.9000000000001,
  averagePositionPriceFifoNumber: 6.65,
  averagePositionPriceNumber: 6.65
}
2025-09-04T15:23:50.021Z bot:balancer walletWithtotalPrice: map start: position {
  pair: 'TMON/RUB',
  base: 'TMON',
  quote: 'RUB',
  figi: 'TCS70A106DL2',
  price: { units: 142, nano: 290000000 },
  priceNumber: 142.29,
  amount: 0,
  lotSize: 1,
  lotPrice: { units: 142, nano: 290000000 }
}
2025-09-04T15:23:50.021Z bot:balancer lotPriceNumber 142.29
2025-09-04T15:23:50.021Z bot:balancer position.amount, position.priceNumber
2025-09-04T15:23:50.021Z bot:balancer 0 142.29
2025-09-04T15:23:50.021Z bot:balancer walletWithtotalPrice: map end: position {
  pair: 'TMON/RUB',
  base: 'TMON',
  quote: 'RUB',
  figi: 'TCS70A106DL2',
  price: { units: 142, nano: 290000000 },
  priceNumber: 142.29,
  amount: 0,
  lotSize: 1,
  lotPrice: { units: 142, nano: 290000000 }
}
2025-09-04T15:23:50.022Z bot:balancer addNumbersToPosition start
2025-09-04T15:23:50.022Z bot:balancer position.price { units: 1, nano: 0 }
2025-09-04T15:23:50.022Z bot:balancer position.priceNumber 1
2025-09-04T15:23:50.022Z bot:balancer position.lotPrice { units: 1, nano: 0 }
2025-09-04T15:23:50.022Z bot:balancer position.lotPriceNumber 1
2025-09-04T15:23:50.022Z bot:balancer position.totalPrice { units: -1164, nano: 320000000 }
2025-09-04T15:23:50.022Z bot:balancer position.totalPriceNumber -1164.32
2025-09-04T15:23:50.022Z bot:balancer addNumbersToPosition end {
  pair: 'RUB/RUB',
  base: 'RUB',
  quote: 'RUB',
  figi: undefined,
  amount: -1164.32,
  lotSize: 1,
  price: { units: 1, nano: 0 },
  priceNumber: 1,
  lotPrice: { units: 1, nano: 0 },
  totalPrice: { units: -1164, nano: 320000000 },
  lotPriceNumber: 1,
  totalPriceNumber: -1164.32
}
2025-09-04T15:23:50.022Z bot:balancer addNumbersToPosition start
2025-09-04T15:23:50.022Z bot:balancer position.price { units: 100, nano: 680000000 }
2025-09-04T15:23:50.022Z bot:balancer position.priceNumber 100.68
2025-09-04T15:23:50.022Z bot:balancer position.lotPrice { units: 100, nano: 680000000 }
2025-09-04T15:23:50.022Z bot:balancer position.lotPriceNumber 100.68
2025-09-04T15:23:50.022Z bot:balancer position.totalPrice { units: 704, nano: 760000000 }
2025-09-04T15:23:50.022Z bot:balancer position.totalPriceNumber 704.76
2025-09-04T15:23:50.022Z bot:balancer addNumbersToPosition end {
  pair: 'TPAY/RUB',
  base: 'TPAY',
  quote: 'RUB',
  figi: 'TCS00A108WX3',
  amount: 7,
  lotSize: 1,
  price: { units: 100, nano: 680000000 },
  priceNumber: 100.68,
  lotPrice: { units: 100, nano: 680000000 },
  totalPrice: { units: 704, nano: 760000000 },
  totalPriceNumber: 704.76,
  averagePositionPriceFifoNumber: 100.68,
  averagePositionPriceNumber: 100.68,
  lotPriceNumber: 100.68
}
2025-09-04T15:23:50.022Z bot:balancer addNumbersToPosition start
2025-09-04T15:23:50.022Z bot:balancer position.price { units: 13, nano: 440000000 }
2025-09-04T15:23:50.022Z bot:balancer position.priceNumber 13.44
2025-09-04T15:23:50.022Z bot:balancer position.lotPrice { units: 13, nano: 440000000 }
2025-09-04T15:23:50.022Z bot:balancer position.lotPriceNumber 13.44
2025-09-04T15:23:50.022Z bot:balancer position.totalPrice { units: 698, nano: 880000000 }
2025-09-04T15:23:50.022Z bot:balancer position.totalPriceNumber 698.88
2025-09-04T15:23:50.023Z bot:balancer addNumbersToPosition end {
  pair: 'TOFZ@/RUB',
  base: 'TOFZ@',
  quote: 'RUB',
  figi: 'TCS70A10A1L8',
  amount: 52,
  lotSize: 1,
  price: { units: 13, nano: 440000000 },
  priceNumber: 13.44,
  lotPrice: { units: 13, nano: 440000000 },
  totalPrice: { units: 698, nano: 880000000 },
  totalPriceNumber: 698.88,
  averagePositionPriceFifoNumber: 13.44,
  averagePositionPriceNumber: 13.44,
  lotPriceNumber: 13.44
}
2025-09-04T15:23:50.023Z bot:balancer addNumbersToPosition start
2025-09-04T15:23:50.023Z bot:balancer position.price { units: 6, nano: 650000000 }
2025-09-04T15:23:50.023Z bot:balancer position.priceNumber 6.65
2025-09-04T15:23:50.023Z bot:balancer position.lotPrice { units: 6, nano: 650000000 }
2025-09-04T15:23:50.023Z bot:balancer position.lotPriceNumber 6.65
2025-09-04T15:23:50.023Z bot:balancer position.totalPrice { units: 704, nano: 900000000 }
2025-09-04T15:23:50.023Z bot:balancer position.totalPriceNumber 704.9
2025-09-04T15:23:50.023Z bot:balancer addNumbersToPosition end {
  pair: 'TMOS@/RUB',
  base: 'TMOS@',
  quote: 'RUB',
  figi: 'TCS60A101X76',
  amount: 106,
  lotSize: 1,
  price: { units: 6, nano: 650000000 },
  priceNumber: 6.65,
  lotPrice: { units: 6, nano: 650000000 },
  totalPrice: { units: 704, nano: 900000000 },
  totalPriceNumber: 704.9,
  averagePositionPriceFifoNumber: 6.65,
  averagePositionPriceNumber: 6.65,
  lotPriceNumber: 6.65
}
2025-09-04T15:23:50.023Z bot:balancer addNumbersToPosition start
2025-09-04T15:23:50.023Z bot:balancer position.price { units: 142, nano: 290000000 }
2025-09-04T15:23:50.023Z bot:balancer position.priceNumber 142.29
2025-09-04T15:23:50.023Z bot:balancer position.lotPrice { units: 142, nano: 290000000 }
2025-09-04T15:23:50.023Z bot:balancer position.lotPriceNumber 142.29
2025-09-04T15:23:50.023Z bot:balancer position.totalPrice undefined
2025-09-04T15:23:50.023Z bot:balancer addNumbersToPosition end {
  pair: 'TMON/RUB',
  base: 'TMON',
  quote: 'RUB',
  figi: 'TCS70A106DL2',
  price: { units: 142, nano: 290000000 },
  priceNumber: 142.29,
  amount: 0,
  lotSize: 1,
  lotPrice: { units: 142, nano: 290000000 },
  lotPriceNumber: 142.29
}
2025-09-04T15:23:50.023Z bot:balancer addNumbersToWallet [
  {
    pair: 'RUB/RUB',
    base: 'RUB',
    quote: 'RUB',
    figi: undefined,
    amount: -1164.32,
    lotSize: 1,
    price: { units: 1, nano: 0 },
    priceNumber: 1,
    lotPrice: { units: 1, nano: 0 },
    totalPrice: { units: -1164, nano: 320000000 },
    lotPriceNumber: 1,
    totalPriceNumber: -1164.32
  },
  {
    pair: 'TPAY/RUB',
    base: 'TPAY',
    quote: 'RUB',
    figi: 'TCS00A108WX3',
    amount: 7,
    lotSize: 1,
    price: { units: 100, nano: 680000000 },
    priceNumber: 100.68,
    lotPrice: { units: 100, nano: 680000000 },
    totalPrice: { units: 704, nano: 760000000 },
    totalPriceNumber: 704.76,
    averagePositionPriceFifoNumber: 100.68,
    averagePositionPriceNumber: 100.68,
    lotPriceNumber: 100.68
  },
  {
    pair: 'TOFZ@/RUB',
    base: 'TOFZ@',
    quote: 'RUB',
    figi: 'TCS70A10A1L8',
    amount: 52,
    lotSize: 1,
    price: { units: 13, nano: 440000000 },
    priceNumber: 13.44,
    lotPrice: { units: 13, nano: 440000000 },
    totalPrice: { units: 698, nano: 880000000 },
    totalPriceNumber: 698.88,
    averagePositionPriceFifoNumber: 13.44,
    averagePositionPriceNumber: 13.44,
    lotPriceNumber: 13.44
  },
  {
    pair: 'TMOS@/RUB',
    base: 'TMOS@',
    quote: 'RUB',
    figi: 'TCS60A101X76',
    amount: 106,
    lotSize: 1,
    price: { units: 6, nano: 650000000 },
    priceNumber: 6.65,
    lotPrice: { units: 6, nano: 650000000 },
    totalPrice: { units: 704, nano: 900000000 },
    totalPriceNumber: 704.9,
    averagePositionPriceFifoNumber: 6.65,
    averagePositionPriceNumber: 6.65,
    lotPriceNumber: 6.65
  },
  {
    pair: 'TMON/RUB',
    base: 'TMON',
    quote: 'RUB',
    figi: 'TCS70A106DL2',
    price: { units: 142, nano: 290000000 },
    priceNumber: 142.29,
    amount: 0,
    lotSize: 1,
    lotPrice: { units: 142, nano: 290000000 },
    lotPriceNumber: 142.29
  }
]
2025-09-04T15:23:50.023Z bot:balancer addNumbersToWallet [Function: addNumbersToWallet]
2025-09-04T15:23:50.026Z bot:balancer sortedWallet [
  {
    pair: 'TMON/RUB',
    base: 'TMON',
    quote: 'RUB',
    figi: 'TCS70A106DL2',
    price: { units: 142, nano: 290000000 },
    priceNumber: 142.29,
    amount: 0,
    lotSize: 1,
    lotPrice: { units: 142, nano: 290000000 },
    lotPriceNumber: 142.29
  },
  {
    pair: 'TPAY/RUB',
    base: 'TPAY',
    quote: 'RUB',
    figi: 'TCS00A108WX3',
    amount: 7,
    lotSize: 1,
    price: { units: 100, nano: 680000000 },
    priceNumber: 100.68,
    lotPrice: { units: 100, nano: 680000000 },
    totalPrice: { units: 704, nano: 760000000 },
    totalPriceNumber: 704.76,
    averagePositionPriceFifoNumber: 100.68,
    averagePositionPriceNumber: 100.68,
    lotPriceNumber: 100.68
  },
  {
    pair: 'TOFZ@/RUB',
    base: 'TOFZ@',
    quote: 'RUB',
    figi: 'TCS70A10A1L8',
    amount: 52,
    lotSize: 1,
    price: { units: 13, nano: 440000000 },
    priceNumber: 13.44,
    lotPrice: { units: 13, nano: 440000000 },
    totalPrice: { units: 698, nano: 880000000 },
    totalPriceNumber: 698.88,
    averagePositionPriceFifoNumber: 13.44,
    averagePositionPriceNumber: 13.44,
    lotPriceNumber: 13.44
  },
  {
    pair: 'TMOS@/RUB',
    base: 'TMOS@',
    quote: 'RUB',
    figi: 'TCS60A101X76',
    amount: 106,
    lotSize: 1,
    price: { units: 6, nano: 650000000 },
    priceNumber: 6.65,
    lotPrice: { units: 6, nano: 650000000 },
    totalPrice: { units: 704, nano: 900000000 },
    totalPriceNumber: 704.9,
    averagePositionPriceFifoNumber: 6.65,
    averagePositionPriceNumber: 6.65,
    lotPriceNumber: 6.65
  },
  {
    pair: 'RUB/RUB',
    base: 'RUB',
    quote: 'RUB',
    figi: undefined,
    amount: -1164.32,
    lotSize: 1,
    price: { units: 1, nano: 0 },
    priceNumber: 1,
    lotPrice: { units: 1, nano: 0 },
    totalPrice: { units: -1164, nano: 320000000 },
    lotPriceNumber: 1,
    totalPriceNumber: -1164.32
  }
]
2025-09-04T15:23:50.026Z bot:balancer Summing up all positions in portfolio
2025-09-04T15:23:50.027Z bot:balancer [
  {
    pair: 'TMON/RUB',
    base: 'TMON',
    quote: 'RUB',
    figi: 'TCS70A106DL2',
    price: { units: 142, nano: 290000000 },
    priceNumber: 142.29,
    amount: 0,
    lotSize: 1,
    lotPrice: { units: 142, nano: 290000000 },
    lotPriceNumber: 142.29
  },
  {
    pair: 'TPAY/RUB',
    base: 'TPAY',
    quote: 'RUB',
    figi: 'TCS00A108WX3',
    amount: 7,
    lotSize: 1,
    price: { units: 100, nano: 680000000 },
    priceNumber: 100.68,
    lotPrice: { units: 100, nano: 680000000 },
    totalPrice: { units: 704, nano: 760000000 },
    totalPriceNumber: 704.76,
    averagePositionPriceFifoNumber: 100.68,
    averagePositionPriceNumber: 100.68,
    lotPriceNumber: 100.68
  },
  {
    pair: 'TOFZ@/RUB',
    base: 'TOFZ@',
    quote: 'RUB',
    figi: 'TCS70A10A1L8',
    amount: 52,
    lotSize: 1,
    price: { units: 13, nano: 440000000 },
    priceNumber: 13.44,
    lotPrice: { units: 13, nano: 440000000 },
    totalPrice: { units: 698, nano: 880000000 },
    totalPriceNumber: 698.88,
    averagePositionPriceFifoNumber: 13.44,
    averagePositionPriceNumber: 13.44,
    lotPriceNumber: 13.44
  },
  {
    pair: 'TMOS@/RUB',
    base: 'TMOS@',
    quote: 'RUB',
    figi: 'TCS60A101X76',
    amount: 106,
    lotSize: 1,
    price: { units: 6, nano: 650000000 },
    priceNumber: 6.65,
    lotPrice: { units: 6, nano: 650000000 },
    totalPrice: { units: 704, nano: 900000000 },
    totalPriceNumber: 704.9,
    averagePositionPriceFifoNumber: 6.65,
    averagePositionPriceNumber: 6.65,
    lotPriceNumber: 6.65
  },
  {
    pair: 'RUB/RUB',
    base: 'RUB',
    quote: 'RUB',
    figi: undefined,
    amount: -1164.32,
    lotSize: 1,
    price: { units: 1, nano: 0 },
    priceNumber: 1,
    lotPrice: { units: 1, nano: 0 },
    totalPrice: { units: -1164, nano: 320000000 },
    lotPriceNumber: 1,
    totalPriceNumber: -1164.32
  }
]
2025-09-04T15:23:50.027Z bot:balancer walletSumNumber 944.22
2025-09-04T15:23:50.027Z bot:balancer Optimal position sizes: {
  TMON: { baseSize: 236.055, marginSize: 472.11, totalSize: 708.165 },
  TMOS: { baseSize: 236.055, marginSize: 472.11, totalSize: 708.165 },
  TOFZ: { baseSize: 236.055, marginSize: 472.11, totalSize: 708.165 },
  TPAY: { baseSize: 236.055, marginSize: 472.11, totalSize: 708.165 },
  RUB: { baseSize: 0, marginSize: 0, totalSize: 0 }
}
2025-09-04T15:23:50.027Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:23:50.027Z bot:balancer positionIndex 0
2025-09-04T15:23:50.027Z bot:balancer position {
  pair: 'TMON/RUB',
  base: 'TMON',
  quote: 'RUB',
  figi: 'TCS70A106DL2',
  price: { units: 142, nano: 290000000 },
  priceNumber: 142.29,
  amount: 0,
  lotSize: 1,
  lotPrice: { units: 142, nano: 290000000 },
  lotPriceNumber: 142.29
}
2025-09-04T15:23:50.027Z bot:balancer Calculating how many rubles the desired share will be with multiplier
2025-09-04T15:23:50.027Z bot:balancer walletSumNumber 944.22
2025-09-04T15:23:50.027Z bot:balancer desiredPercent 25
2025-09-04T15:23:50.027Z bot:balancer desiredAmountNumber (considering multiplier) 708.165
2025-09-04T15:23:50.027Z bot:balancer Calculating how many lots can be bought before desired target
2025-09-04T15:23:50.027Z bot:balancer canBuyBeforeTargetLots 4
2025-09-04T15:23:50.028Z bot:balancer Calculating cost of position that can be bought before desired target
2025-09-04T15:23:50.028Z bot:balancer canBuyBeforeTargetNumber 569.16
2025-09-04T15:23:50.028Z bot:balancer Calculating difference between desired value and value before target. Unallocated remainder.
2025-09-04T15:23:50.028Z bot:balancer beforeDiffNumber 139.005
2025-09-04T15:23:50.028Z bot:balancer Summing up remainders
2025-09-04T15:23:50.028Z bot:balancer How much to buy (can be negative, then need to sell)
2025-09-04T15:23:50.028Z bot:balancer How many lots to buy (can be negative, then need to sell)
2025-09-04T15:23:50.028Z bot:balancer New position with positive target: setting toBuyLots to minimum 1 TMON
2025-09-04T15:23:50.028Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:23:50.028Z bot:balancer positionIndex 3
2025-09-04T15:23:50.028Z bot:balancer position {
  pair: 'TMOS@/RUB',
  base: 'TMOS@',
  quote: 'RUB',
  figi: 'TCS60A101X76',
  amount: 106,
  lotSize: 1,
  price: { units: 6, nano: 650000000 },
  priceNumber: 6.65,
  lotPrice: { units: 6, nano: 650000000 },
  totalPrice: { units: 704, nano: 900000000 },
  totalPriceNumber: 704.9,
  averagePositionPriceFifoNumber: 6.65,
  averagePositionPriceNumber: 6.65,
  lotPriceNumber: 6.65
}
2025-09-04T15:23:50.028Z bot:balancer Calculating how many rubles the desired share will be with multiplier
2025-09-04T15:23:50.028Z bot:balancer walletSumNumber 944.22
2025-09-04T15:23:50.028Z bot:balancer desiredPercent 25
2025-09-04T15:23:50.028Z bot:balancer desiredAmountNumber (considering multiplier) 708.165
2025-09-04T15:23:50.028Z bot:balancer Calculating how many lots can be bought before desired target
2025-09-04T15:23:50.028Z bot:balancer canBuyBeforeTargetLots 106
2025-09-04T15:23:50.028Z bot:balancer Calculating cost of position that can be bought before desired target
2025-09-04T15:23:50.028Z bot:balancer canBuyBeforeTargetNumber 704.9000000000001
2025-09-04T15:23:50.028Z bot:balancer Calculating difference between desired value and value before target. Unallocated remainder.
2025-09-04T15:23:50.028Z bot:balancer beforeDiffNumber 3.2649999999998727
2025-09-04T15:23:50.028Z bot:balancer Summing up remainders
2025-09-04T15:23:50.028Z bot:balancer How much to buy (can be negative, then need to sell)
2025-09-04T15:23:50.028Z bot:balancer toBuyNumber 1.1368683772161603e-13
2025-09-04T15:23:50.028Z bot:balancer How many lots to buy (can be negative, then need to sell)
2025-09-04T15:23:50.028Z bot:balancer toBuyLots 0
2025-09-04T15:23:50.028Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:23:50.028Z bot:balancer positionIndex 2
2025-09-04T15:23:50.028Z bot:balancer position {
  pair: 'TOFZ@/RUB',
  base: 'TOFZ@',
  quote: 'RUB',
  figi: 'TCS70A10A1L8',
  amount: 52,
  lotSize: 1,
  price: { units: 13, nano: 440000000 },
  priceNumber: 13.44,
  lotPrice: { units: 13, nano: 440000000 },
  totalPrice: { units: 698, nano: 880000000 },
  totalPriceNumber: 698.88,
  averagePositionPriceFifoNumber: 13.44,
  averagePositionPriceNumber: 13.44,
  lotPriceNumber: 13.44
}
2025-09-04T15:23:50.028Z bot:balancer Calculating how many rubles the desired share will be with multiplier
2025-09-04T15:23:50.028Z bot:balancer walletSumNumber 944.22
2025-09-04T15:23:50.028Z bot:balancer desiredPercent 25
2025-09-04T15:23:50.028Z bot:balancer desiredAmountNumber (considering multiplier) 708.165
2025-09-04T15:23:50.028Z bot:balancer Calculating how many lots can be bought before desired target
2025-09-04T15:23:50.028Z bot:balancer canBuyBeforeTargetLots 52
2025-09-04T15:23:50.028Z bot:balancer Calculating cost of position that can be bought before desired target
2025-09-04T15:23:50.028Z bot:balancer canBuyBeforeTargetNumber 698.88
2025-09-04T15:23:50.028Z bot:balancer Calculating difference between desired value and value before target. Unallocated remainder.
2025-09-04T15:23:50.028Z bot:balancer beforeDiffNumber 9.284999999999968
2025-09-04T15:23:50.028Z bot:balancer Summing up remainders
2025-09-04T15:23:50.028Z bot:balancer How much to buy (can be negative, then need to sell)
2025-09-04T15:23:50.028Z bot:balancer toBuyNumber 0
2025-09-04T15:23:50.028Z bot:balancer How many lots to buy (can be negative, then need to sell)
2025-09-04T15:23:50.028Z bot:balancer toBuyLots 0
2025-09-04T15:23:50.028Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:23:50.028Z bot:balancer positionIndex 1
2025-09-04T15:23:50.028Z bot:balancer position {
  pair: 'TPAY/RUB',
  base: 'TPAY',
  quote: 'RUB',
  figi: 'TCS00A108WX3',
  amount: 7,
  lotSize: 1,
  price: { units: 100, nano: 680000000 },
  priceNumber: 100.68,
  lotPrice: { units: 100, nano: 680000000 },
  totalPrice: { units: 704, nano: 760000000 },
  totalPriceNumber: 704.76,
  averagePositionPriceFifoNumber: 100.68,
  averagePositionPriceNumber: 100.68,
  lotPriceNumber: 100.68
}
2025-09-04T15:23:50.028Z bot:balancer Calculating how many rubles the desired share will be with multiplier
2025-09-04T15:23:50.028Z bot:balancer walletSumNumber 944.22
2025-09-04T15:23:50.028Z bot:balancer desiredPercent 25
2025-09-04T15:23:50.028Z bot:balancer desiredAmountNumber (considering multiplier) 708.165
2025-09-04T15:23:50.028Z bot:balancer Calculating how many lots can be bought before desired target
2025-09-04T15:23:50.028Z bot:balancer canBuyBeforeTargetLots 7
2025-09-04T15:23:50.028Z bot:balancer Calculating cost of position that can be bought before desired target
2025-09-04T15:23:50.028Z bot:balancer canBuyBeforeTargetNumber 704.76
2025-09-04T15:23:50.028Z bot:balancer Calculating difference between desired value and value before target. Unallocated remainder.
2025-09-04T15:23:50.028Z bot:balancer beforeDiffNumber 3.4049999999999727
2025-09-04T15:23:50.028Z bot:balancer Summing up remainders
2025-09-04T15:23:50.028Z bot:balancer How much to buy (can be negative, then need to sell)
2025-09-04T15:23:50.028Z bot:balancer toBuyNumber 0
2025-09-04T15:23:50.028Z bot:balancer How many lots to buy (can be negative, then need to sell)
2025-09-04T15:23:50.028Z bot:balancer toBuyLots 0
2025-09-04T15:23:50.028Z bot:balancer  Looking for base (ticker) in wallet
2025-09-04T15:23:50.028Z bot:balancer positionIndex 4
2025-09-04T15:23:50.028Z bot:balancer position {
  pair: 'RUB/RUB',
  base: 'RUB',
  quote: 'RUB',
  figi: undefined,
  amount: -1164.32,
  lotSize: 1,
  price: { units: 1, nano: 0 },
  priceNumber: 1,
  lotPrice: { units: 1, nano: 0 },
  totalPrice: { units: -1164, nano: 320000000 },
  lotPriceNumber: 1,
  totalPriceNumber: -1164.32
}
2025-09-04T15:23:50.028Z bot:balancer Calculating how many rubles the desired share will be with multiplier
2025-09-04T15:23:50.028Z bot:balancer walletSumNumber 944.22
2025-09-04T15:23:50.028Z bot:balancer desiredPercent 0
2025-09-04T15:23:50.028Z bot:balancer desiredAmountNumber (considering multiplier) 0
2025-09-04T15:23:50.028Z bot:balancer Calculating how many lots can be bought before desired target
2025-09-04T15:23:50.028Z bot:balancer canBuyBeforeTargetLots 0
2025-09-04T15:23:50.028Z bot:balancer Calculating cost of position that can be bought before desired target
2025-09-04T15:23:50.028Z bot:balancer canBuyBeforeTargetNumber 0
2025-09-04T15:23:50.029Z bot:balancer Calculating difference between desired value and value before target. Unallocated remainder.
2025-09-04T15:23:50.029Z bot:balancer beforeDiffNumber 0
2025-09-04T15:23:50.029Z bot:balancer Summing up remainders
2025-09-04T15:23:50.029Z bot:balancer How much to buy (can be negative, then need to sell)
2025-09-04T15:23:50.029Z bot:balancer toBuyNumber 1164.32
2025-09-04T15:23:50.029Z bot:balancer How many lots to buy (can be negative, then need to sell)
2025-09-04T15:23:50.029Z bot:balancer toBuyLots 1164.32
2025-09-04T15:23:50.029Z bot:balancer Processing buy_requires_total_marginal_sell configuration
2025-09-04T15:23:50.029Z bot:balancer Identifying positions for selling using mode: equal_in_percents
2025-09-04T15:23:50.029Z bot:balancer Found position for proportional selling: TPAY with value 704.76 RUB
2025-09-04T15:23:50.029Z bot:balancer Found position for proportional selling: TOFZ@ with value 698.88 RUB
2025-09-04T15:23:50.029Z bot:balancer Found position for proportional selling: TMOS@ with value 704.90 RUB
2025-09-04T15:23:50.029Z bot:balancer Found 3 positions available for selling in mode: equal_in_percents
2025-09-04T15:23:50.030Z bot:balancer Calculating required funds for non-margin instrument purchases
2025-09-04T15:23:50.030Z bot:balancer Threshold for TMON: 0.94 RUB (portfolio value: 944.22 RUB, min_percent: 0.1%)
2025-09-04T15:23:50.030Z bot:balancer Need to buy TMON: 569.16 RUB (threshold: 0.94 RUB)
2025-09-04T15:23:50.030Z bot:balancer üîç CALCULATE SELLING DEBUG:
2025-09-04T15:23:50.030Z bot:balancer    Current RUB balance: -1164.32 RUB
2025-09-04T15:23:50.030Z bot:balancer    Required funds: { TMON: 569.16 }
2025-09-04T15:23:50.030Z bot:balancer    Sellable positions count: 3
2025-09-04T15:23:50.030Z bot:balancer    Mode: equal_in_percents
2025-09-04T15:23:50.030Z bot:balancer Calculating selling amounts using mode: equal_in_percents
2025-09-04T15:23:50.030Z bot:balancer üîç CALCULATE SELLING AMOUNTS INTERNAL:
2025-09-04T15:23:50.030Z bot:balancer    Current RUB balance: -1164.32 RUB
2025-09-04T15:23:50.030Z bot:balancer    Funds needed for purchases: 569.16 RUB
2025-09-04T15:23:50.031Z bot:balancer    Total funds needed to sell: 1733.48 RUB
2025-09-04T15:23:50.031Z bot:balancer    Profitable positions available: 3
2025-09-04T15:23:50.031Z bot:balancer      1. TPAY: 704.76 RUB (7 lots √ó 100.68)
2025-09-04T15:23:50.031Z bot:balancer      2. TOFZ@: 698.88 RUB (52 lots √ó 13.44)
2025-09-04T15:23:50.031Z bot:balancer      3. TMOS@: 704.90 RUB (106 lots √ó 6.65)
2025-09-04T15:23:50.031Z bot:balancer    Total funds available from profitable positions: 2108.54 RUB
2025-09-04T15:23:50.031Z bot:balancer Planning to sell 5 lots of TPAY for 503.40 RUB (proportional)
2025-09-04T15:23:50.031Z bot:balancer Planning to sell 42 lots of TOFZ@ for 564.48 RUB (proportional)
2025-09-04T15:23:50.031Z bot:balancer Planning to sell 87 lots of TMOS@ for 578.55 RUB (proportional)
2025-09-04T15:23:50.031Z bot:balancer Funds still needed after selling: 87.05 RUB
2025-09-04T15:23:50.031Z bot:balancer ‚úÖ Special selling plan calculated: {
  TPAY: {
    position: {
      pair: 'TPAY/RUB',
      base: 'TPAY',
      quote: 'RUB',
      figi: 'TCS00A108WX3',
      amount: 7,
      lotSize: 1,
      price: [Object],
      priceNumber: 100.68,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 704.76,
      averagePositionPriceFifoNumber: 100.68,
      averagePositionPriceNumber: 100.68,
      lotPriceNumber: 100.68,
      desiredAmountNumber: 708.165,
      canBuyBeforeTargetLots: 7,
      canBuyBeforeTargetNumber: 704.76,
      beforeDiffNumber: 3.4049999999999727,
      toBuyNumber: 0,
      toBuyLots: 0
    },
    sellAmount: 503.40000000000003,
    sellLots: 5
  },
  'TOFZ@': {
    position: {
      pair: 'TOFZ@/RUB',
      base: 'TOFZ@',
      quote: 'RUB',
      figi: 'TCS70A10A1L8',
      amount: 52,
      lotSize: 1,
      price: [Object],
      priceNumber: 13.44,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 698.88,
      averagePositionPriceFifoNumber: 13.44,
      averagePositionPriceNumber: 13.44,
      lotPriceNumber: 13.44,
      desiredAmountNumber: 708.165,
      canBuyBeforeTargetLots: 52,
      canBuyBeforeTargetNumber: 698.88,
      beforeDiffNumber: 9.284999999999968,
      toBuyNumber: 0,
      toBuyLots: 0
    },
    sellAmount: 564.48,
    sellLots: 42
  },
  'TMOS@': {
    position: {
      pair: 'TMOS@/RUB',
      base: 'TMOS@',
      quote: 'RUB',
      figi: 'TCS60A101X76',
      amount: 106,
      lotSize: 1,
      price: [Object],
      priceNumber: 6.65,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 704.9,
      averagePositionPriceFifoNumber: 6.65,
      averagePositionPriceNumber: 6.65,
      lotPriceNumber: 6.65,
      desiredAmountNumber: 708.165,
      canBuyBeforeTargetLots: 106,
      canBuyBeforeTargetNumber: 704.9000000000001,
      beforeDiffNumber: 3.2649999999998727,
      toBuyNumber: 1.1368683772161603e-13,
      toBuyLots: 0
    },
    sellAmount: 578.5500000000001,
    sellLots: 87
  }
}
2025-09-04T15:23:50.031Z bot:balancer ‚ö†Ô∏è  PARTIAL FUNDS WARNING:
2025-09-04T15:23:50.031Z bot:balancer    Funds needed: 1733.48 RUB
2025-09-04T15:23:50.031Z bot:balancer    Funds from selling: 1646.43 RUB
2025-09-04T15:23:50.031Z bot:balancer    Shortfall: 87.05 RUB (5.0%)
2025-09-04T15:23:50.031Z bot:balancer üìà PROCEEDING: Shortfall acceptable (<50%), executing partial funding strategy
2025-09-04T15:23:50.031Z bot:balancer Adjusted selling plan for TPAY: 5 lots, 503.40 RUB
2025-09-04T15:23:50.031Z bot:balancer Adjusted selling plan for TOFZ@: 42 lots, 564.48 RUB
2025-09-04T15:23:50.031Z bot:balancer Adjusted selling plan for TMOS@: 87 lots, 578.55 RUB
2025-09-04T15:23:50.031Z bot:balancer sortedWallet [
  {
    pair: 'TMON/RUB',
    base: 'TMON',
    quote: 'RUB',
    figi: 'TCS70A106DL2',
    price: { units: 142, nano: 290000000 },
    priceNumber: 142.29,
    amount: 0,
    lotSize: 1,
    lotPrice: { units: 142, nano: 290000000 },
    lotPriceNumber: 142.29,
    desiredAmountNumber: 708.165,
    canBuyBeforeTargetLots: 4,
    canBuyBeforeTargetNumber: 569.16,
    beforeDiffNumber: 139.005,
    toBuyLots: 4,
    toBuyNumber: 569.16
  },
  {
    pair: 'TPAY/RUB',
    base: 'TPAY',
    quote: 'RUB',
    figi: 'TCS00A108WX3',
    amount: 7,
    lotSize: 1,
    price: { units: 100, nano: 680000000 },
    priceNumber: 100.68,
    lotPrice: { units: 100, nano: 680000000 },
    totalPrice: { units: 704, nano: 760000000 },
    totalPriceNumber: 704.76,
    averagePositionPriceFifoNumber: 100.68,
    averagePositionPriceNumber: 100.68,
    lotPriceNumber: 100.68,
    desiredAmountNumber: 708.165,
    canBuyBeforeTargetLots: 7,
    canBuyBeforeTargetNumber: 704.76,
    beforeDiffNumber: 3.4049999999999727,
    toBuyNumber: -503.40000000000003,
    toBuyLots: -5
  },
  {
    pair: 'TOFZ@/RUB',
    base: 'TOFZ@',
    quote: 'RUB',
    figi: 'TCS70A10A1L8',
    amount: 52,
    lotSize: 1,
    price: { units: 13, nano: 440000000 },
    priceNumber: 13.44,
    lotPrice: { units: 13, nano: 440000000 },
    totalPrice: { units: 698, nano: 880000000 },
    totalPriceNumber: 698.88,
    averagePositionPriceFifoNumber: 13.44,
    averagePositionPriceNumber: 13.44,
    lotPriceNumber: 13.44,
    desiredAmountNumber: 708.165,
    canBuyBeforeTargetLots: 52,
    canBuyBeforeTargetNumber: 698.88,
    beforeDiffNumber: 9.284999999999968,
    toBuyNumber: -564.48,
    toBuyLots: -42
  },
  {
    pair: 'TMOS@/RUB',
    base: 'TMOS@',
    quote: 'RUB',
    figi: 'TCS60A101X76',
    amount: 106,
    lotSize: 1,
    price: { units: 6, nano: 650000000 },
    priceNumber: 6.65,
    lotPrice: { units: 6, nano: 650000000 },
    totalPrice: { units: 704, nano: 900000000 },
    totalPriceNumber: 704.9,
    averagePositionPriceFifoNumber: 6.65,
    averagePositionPriceNumber: 6.65,
    lotPriceNumber: 6.65,
    desiredAmountNumber: 708.165,
    canBuyBeforeTargetLots: 106,
    canBuyBeforeTargetNumber: 704.9000000000001,
    beforeDiffNumber: 3.2649999999998727,
    toBuyNumber: -578.55,
    toBuyLots: -87
  },
  {
    pair: 'RUB/RUB',
    base: 'RUB',
    quote: 'RUB',
    figi: undefined,
    amount: -1164.32,
    lotSize: 1,
    price: { units: 1, nano: 0 },
    priceNumber: 1,
    lotPrice: { units: 1, nano: 0 },
    totalPrice: { units: -1164, nano: 320000000 },
    lotPriceNumber: 1,
    totalPriceNumber: -1164.32,
    desiredAmountNumber: 0,
    canBuyBeforeTargetLots: 0,
    canBuyBeforeTargetNumber: 0,
    beforeDiffNumber: 0,
    toBuyNumber: 1164.32,
    toBuyLots: 1164.32
  }
]
2025-09-04T15:23:50.032Z bot:balancer specialSellingPlan {
  TPAY: {
    position: {
      pair: 'TPAY/RUB',
      base: 'TPAY',
      quote: 'RUB',
      figi: 'TCS00A108WX3',
      amount: 7,
      lotSize: 1,
      price: [Object],
      priceNumber: 100.68,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 704.76,
      averagePositionPriceFifoNumber: 100.68,
      averagePositionPriceNumber: 100.68,
      lotPriceNumber: 100.68,
      desiredAmountNumber: 708.165,
      canBuyBeforeTargetLots: 7,
      canBuyBeforeTargetNumber: 704.76,
      beforeDiffNumber: 3.4049999999999727,
      toBuyNumber: -503.40000000000003,
      toBuyLots: -5
    },
    sellAmount: 503.40000000000003,
    sellLots: 5
  },
  'TOFZ@': {
    position: {
      pair: 'TOFZ@/RUB',
      base: 'TOFZ@',
      quote: 'RUB',
      figi: 'TCS70A10A1L8',
      amount: 52,
      lotSize: 1,
      price: [Object],
      priceNumber: 13.44,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 698.88,
      averagePositionPriceFifoNumber: 13.44,
      averagePositionPriceNumber: 13.44,
      lotPriceNumber: 13.44,
      desiredAmountNumber: 708.165,
      canBuyBeforeTargetLots: 52,
      canBuyBeforeTargetNumber: 698.88,
      beforeDiffNumber: 9.284999999999968,
      toBuyNumber: -564.48,
      toBuyLots: -42
    },
    sellAmount: 564.48,
    sellLots: 42
  },
  'TMOS@': {
    position: {
      pair: 'TMOS@/RUB',
      base: 'TMOS@',
      quote: 'RUB',
      figi: 'TCS60A101X76',
      amount: 106,
      lotSize: 1,
      price: [Object],
      priceNumber: 6.65,
      lotPrice: [Object],
      totalPrice: [Object],
      totalPriceNumber: 704.9,
      averagePositionPriceFifoNumber: 6.65,
      averagePositionPriceNumber: 6.65,
      lotPriceNumber: 6.65,
      desiredAmountNumber: 708.165,
      canBuyBeforeTargetLots: 106,
      canBuyBeforeTargetNumber: 704.9000000000001,
      beforeDiffNumber: 3.2649999999998727,
      toBuyNumber: -578.55,
      toBuyLots: -87
    },
    sellAmount: 578.5500000000001,
    sellLots: 87
  }
}
2025-09-04T15:23:50.032Z bot:balancer ordersPlanned [
  {
    pair: 'TMOS@/RUB',
    base: 'TMOS@',
    quote: 'RUB',
    figi: 'TCS60A101X76',
    amount: 106,
    lotSize: 1,
    price: { units: 6, nano: 650000000 },
    priceNumber: 6.65,
    lotPrice: { units: 6, nano: 650000000 },
    totalPrice: { units: 704, nano: 900000000 },
    totalPriceNumber: 704.9,
    averagePositionPriceFifoNumber: 6.65,
    averagePositionPriceNumber: 6.65,
    lotPriceNumber: 6.65,
    desiredAmountNumber: 708.165,
    canBuyBeforeTargetLots: 106,
    canBuyBeforeTargetNumber: 704.9000000000001,
    beforeDiffNumber: 3.2649999999998727,
    toBuyNumber: -578.55,
    toBuyLots: -87
  },
  {
    pair: 'TOFZ@/RUB',
    base: 'TOFZ@',
    quote: 'RUB',
    figi: 'TCS70A10A1L8',
    amount: 52,
    lotSize: 1,
    price: { units: 13, nano: 440000000 },
    priceNumber: 13.44,
    lotPrice: { units: 13, nano: 440000000 },
    totalPrice: { units: 698, nano: 880000000 },
    totalPriceNumber: 698.88,
    averagePositionPriceFifoNumber: 13.44,
    averagePositionPriceNumber: 13.44,
    lotPriceNumber: 13.44,
    desiredAmountNumber: 708.165,
    canBuyBeforeTargetLots: 52,
    canBuyBeforeTargetNumber: 698.88,
    beforeDiffNumber: 9.284999999999968,
    toBuyNumber: -564.48,
    toBuyLots: -42
  },
  {
    pair: 'TPAY/RUB',
    base: 'TPAY',
    quote: 'RUB',
    figi: 'TCS00A108WX3',
    amount: 7,
    lotSize: 1,
    price: { units: 100, nano: 680000000 },
    priceNumber: 100.68,
    lotPrice: { units: 100, nano: 680000000 },
    totalPrice: { units: 704, nano: 760000000 },
    totalPriceNumber: 704.76,
    averagePositionPriceFifoNumber: 100.68,
    averagePositionPriceNumber: 100.68,
    lotPriceNumber: 100.68,
    desiredAmountNumber: 708.165,
    canBuyBeforeTargetLots: 7,
    canBuyBeforeTargetNumber: 704.76,
    beforeDiffNumber: 3.4049999999999727,
    toBuyNumber: -503.40000000000003,
    toBuyLots: -5
  },
  {
    pair: 'TMON/RUB',
    base: 'TMON',
    quote: 'RUB',
    figi: 'TCS70A106DL2',
    price: { units: 142, nano: 290000000 },
    priceNumber: 142.29,
    amount: 0,
    lotSize: 1,
    lotPrice: { units: 142, nano: 290000000 },
    lotPriceNumber: 142.29,
    desiredAmountNumber: 708.165,
    canBuyBeforeTargetLots: 4,
    canBuyBeforeTargetNumber: 569.16,
    beforeDiffNumber: 139.005,
    toBuyLots: 4,
    toBuyNumber: 569.16
  },
  {
    pair: 'RUB/RUB',
    base: 'RUB',
    quote: 'RUB',
    figi: undefined,
    amount: -1164.32,
    lotSize: 1,
    price: { units: 1, nano: 0 },
    priceNumber: 1,
    lotPrice: { units: 1, nano: 0 },
    totalPrice: { units: -1164, nano: 320000000 },
    lotPriceNumber: 1,
    totalPriceNumber: -1164.32,
    desiredAmountNumber: 0,
    canBuyBeforeTargetLots: 0,
    canBuyBeforeTargetNumber: 0,
    beforeDiffNumber: 0,
    toBuyNumber: 1164.32,
    toBuyLots: 1164.32
  }
]
2025-09-04T15:23:50.033Z bot:balancer walletInfo { remains: 154.9599999999998 }
2025-09-04T15:23:50.033Z bot:balancer Creating necessary orders for all positions
2025-09-04T15:23:50.033Z bot:provider generateOrders
2025-09-04T15:23:50.034Z bot:provider generateOrder
2025-09-04T15:23:50.034Z bot:provider position {
  pair: 'TMOS@/RUB',
  base: 'TMOS@',
  quote: 'RUB',
  figi: 'TCS60A101X76',
  amount: 106,
  lotSize: 1,
  price: { units: 6, nano: 650000000 },
  priceNumber: 6.65,
  lotPrice: { units: 6, nano: 650000000 },
  totalPrice: { units: 704, nano: 900000000 },
  totalPriceNumber: 704.9,
  averagePositionPriceFifoNumber: 6.65,
  averagePositionPriceNumber: 6.65,
  lotPriceNumber: 6.65,
  desiredAmountNumber: 708.165,
  canBuyBeforeTargetLots: 106,
  canBuyBeforeTargetNumber: 704.9000000000001,
  beforeDiffNumber: 3.2649999999998727,
  toBuyNumber: -578.55,
  toBuyLots: -87
}
2025-09-04T15:23:50.034Z bot:provider üí∞ About to place SELL order: 87 lots √ó 6.65 = 578.55 RUB for TMOS@
2025-09-04T15:23:50.034Z bot:provider Position is not currency
2025-09-04T15:23:50.034Z bot:provider position.toBuyLots -87
2025-09-04T15:23:50.034Z bot:provider Position is greater than or equal to 1 lot
2025-09-04T15:23:50.034Z bot:provider direction 2
2025-09-04T15:23:50.034Z bot:provider position {
  pair: 'TMOS@/RUB',
  base: 'TMOS@',
  quote: 'RUB',
  figi: 'TCS60A101X76',
  amount: 106,
  lotSize: 1,
  price: { units: 6, nano: 650000000 },
  priceNumber: 6.65,
  lotPrice: { units: 6, nano: 650000000 },
  totalPrice: { units: 704, nano: 900000000 },
  totalPriceNumber: 704.9,
  averagePositionPriceFifoNumber: 6.65,
  averagePositionPriceNumber: 6.65,
  lotPriceNumber: 6.65,
  desiredAmountNumber: 708.165,
  canBuyBeforeTargetLots: 106,
  canBuyBeforeTargetNumber: 704.9000000000001,
  beforeDiffNumber: 3.2649999999998727,
  toBuyNumber: -578.55,
  toBuyLots: -87
}
2025-09-04T15:23:50.034Z bot:provider Creating market order
2025-09-04T15:23:50.034Z bot:provider Sending market order {
  accountId: '2272547076',
  figi: 'TCS60A101X76',
  quantity: 87,
  direction: 2,
  orderType: 2,
  orderId: '1q6g1immf5k3gr7'
}
2025-09-04T15:23:50.504Z bot:provider Successfully placed order {
  orderId: '620087726890',
  executionReportStatus: 1,
  lotsRequested: 87,
  lotsExecuted: 87,
  initialOrderPrice: { currency: 'rub', units: 575, nano: 940000000 },
  executedOrderPrice: { currency: 'rub', units: 6, nano: 630000000 },
  totalOrderAmount: { currency: 'rub', units: 576, nano: 810000000 },
  initialCommission: { currency: 'rub', units: 0, nano: 0 },
  executedCommission: { currency: 'rub', units: 0, nano: 0 },
  aciValue: undefined,
  figi: 'TCS60A101X76',
  direction: 2,
  initialSecurityPrice: { currency: 'rub', units: 6, nano: 630000000 },
  orderType: 2,
  message: '',
  initialOrderPricePt: undefined,
  instrumentUid: 'f509af83-6e71-462f-901f-bcb073f6773b',
  orderRequestId: '1q6g1immf5k3gr7',
  responseMetadata: {
    trackingId: 'bbdf3d0a7dfc6f7f92e6982c8c890c1a',
    serverTime: 2025-09-04T15:24:20.505Z
  }
}
2025-09-04T15:23:55.506Z bot:provider generateOrder
2025-09-04T15:23:55.506Z bot:provider position {
  pair: 'TOFZ@/RUB',
  base: 'TOFZ@',
  quote: 'RUB',
  figi: 'TCS70A10A1L8',
  amount: 52,
  lotSize: 1,
  price: { units: 13, nano: 440000000 },
  priceNumber: 13.44,
  lotPrice: { units: 13, nano: 440000000 },
  totalPrice: { units: 698, nano: 880000000 },
  totalPriceNumber: 698.88,
  averagePositionPriceFifoNumber: 13.44,
  averagePositionPriceNumber: 13.44,
  lotPriceNumber: 13.44,
  desiredAmountNumber: 708.165,
  canBuyBeforeTargetLots: 52,
  canBuyBeforeTargetNumber: 698.88,
  beforeDiffNumber: 9.284999999999968,
  toBuyNumber: -564.48,
  toBuyLots: -42
}
2025-09-04T15:23:55.507Z bot:provider üí∞ About to place SELL order: 42 lots √ó 13.44 = 564.48 RUB for TOFZ@
2025-09-04T15:23:55.507Z bot:provider Position is not currency
2025-09-04T15:23:55.507Z bot:provider position.toBuyLots -42
2025-09-04T15:23:55.507Z bot:provider Position is greater than or equal to 1 lot
2025-09-04T15:23:55.507Z bot:provider direction 2
2025-09-04T15:23:55.507Z bot:provider position {
  pair: 'TOFZ@/RUB',
  base: 'TOFZ@',
  quote: 'RUB',
  figi: 'TCS70A10A1L8',
  amount: 52,
  lotSize: 1,
  price: { units: 13, nano: 440000000 },
  priceNumber: 13.44,
  lotPrice: { units: 13, nano: 440000000 },
  totalPrice: { units: 698, nano: 880000000 },
  totalPriceNumber: 698.88,
  averagePositionPriceFifoNumber: 13.44,
  averagePositionPriceNumber: 13.44,
  lotPriceNumber: 13.44,
  desiredAmountNumber: 708.165,
  canBuyBeforeTargetLots: 52,
  canBuyBeforeTargetNumber: 698.88,
  beforeDiffNumber: 9.284999999999968,
  toBuyNumber: -564.48,
  toBuyLots: -42
}
2025-09-04T15:23:55.507Z bot:provider Creating market order
2025-09-04T15:23:55.507Z bot:provider Sending market order {
  accountId: '2272547076',
  figi: 'TCS70A10A1L8',
  quantity: 42,
  direction: 2,
  orderType: 2,
  orderId: '1q6g1immf5k3kz7'
}
2025-09-04T15:23:55.990Z bot:provider Successfully placed order {
  orderId: '620087727850',
  executionReportStatus: 1,
  lotsRequested: 42,
  lotsExecuted: 42,
  initialOrderPrice: { currency: 'rub', units: 561, nano: 960000000 },
  executedOrderPrice: { currency: 'rub', units: 13, nano: 430000000 },
  totalOrderAmount: { currency: 'rub', units: 564, nano: 60000000 },
  initialCommission: { currency: 'rub', units: 0, nano: 0 },
  executedCommission: { currency: 'rub', units: 0, nano: 0 },
  aciValue: undefined,
  figi: 'TCS70A10A1L8',
  direction: 2,
  initialSecurityPrice: { currency: 'rub', units: 13, nano: 380000000 },
  orderType: 2,
  message: '',
  initialOrderPricePt: undefined,
  instrumentUid: 'c5049184-ded4-49d0-8e14-bffefc40a223',
  orderRequestId: '1q6g1immf5k3kz7',
  responseMetadata: {
    trackingId: 'cb940671d84ba5f5e84b8d5389001960',
    serverTime: 2025-09-04T15:24:25.993Z
  }
}
2025-09-04T15:24:00.992Z bot:provider generateOrder
2025-09-04T15:24:00.992Z bot:provider position {
  pair: 'TPAY/RUB',
  base: 'TPAY',
  quote: 'RUB',
  figi: 'TCS00A108WX3',
  amount: 7,
  lotSize: 1,
  price: { units: 100, nano: 680000000 },
  priceNumber: 100.68,
  lotPrice: { units: 100, nano: 680000000 },
  totalPrice: { units: 704, nano: 760000000 },
  totalPriceNumber: 704.76,
  averagePositionPriceFifoNumber: 100.68,
  averagePositionPriceNumber: 100.68,
  lotPriceNumber: 100.68,
  desiredAmountNumber: 708.165,
  canBuyBeforeTargetLots: 7,
  canBuyBeforeTargetNumber: 704.76,
  beforeDiffNumber: 3.4049999999999727,
  toBuyNumber: -503.40000000000003,
  toBuyLots: -5
}
2025-09-04T15:24:00.992Z bot:provider üí∞ About to place SELL order: 5 lots √ó 100.68 = 503.40 RUB for TPAY
2025-09-04T15:24:00.992Z bot:provider Position is not currency
2025-09-04T15:24:00.992Z bot:provider position.toBuyLots -5
2025-09-04T15:24:00.992Z bot:provider Position is greater than or equal to 1 lot
2025-09-04T15:24:00.992Z bot:provider direction 2
2025-09-04T15:24:00.992Z bot:provider position {
  pair: 'TPAY/RUB',
  base: 'TPAY',
  quote: 'RUB',
  figi: 'TCS00A108WX3',
  amount: 7,
  lotSize: 1,
  price: { units: 100, nano: 680000000 },
  priceNumber: 100.68,
  lotPrice: { units: 100, nano: 680000000 },
  totalPrice: { units: 704, nano: 760000000 },
  totalPriceNumber: 704.76,
  averagePositionPriceFifoNumber: 100.68,
  averagePositionPriceNumber: 100.68,
  lotPriceNumber: 100.68,
  desiredAmountNumber: 708.165,
  canBuyBeforeTargetLots: 7,
  canBuyBeforeTargetNumber: 704.76,
  beforeDiffNumber: 3.4049999999999727,
  toBuyNumber: -503.40000000000003,
  toBuyLots: -5
}
2025-09-04T15:24:00.992Z bot:provider Creating market order
2025-09-04T15:24:00.992Z bot:provider Sending market order {
  accountId: '2272547076',
  figi: 'TCS00A108WX3',
  quantity: 5,
  direction: 2,
  orderType: 2,
  orderId: '1q6g1immf5k3p7k'
}
2025-09-04T15:24:01.389Z bot:provider Successfully placed order {
  orderId: '70225129439',
  executionReportStatus: 1,
  lotsRequested: 5,
  lotsExecuted: 5,
  initialOrderPrice: { currency: 'rub', units: 501, nano: 800000000 },
  executedOrderPrice: { currency: 'rub', units: 100, nano: 670000000 },
  totalOrderAmount: { currency: 'rub', units: 503, nano: 350000000 },
  initialCommission: { currency: 'rub', units: 0, nano: 0 },
  executedCommission: { currency: 'rub', units: 0, nano: 0 },
  aciValue: undefined,
  figi: 'TCS00A108WX3',
  direction: 2,
  initialSecurityPrice: { currency: 'rub', units: 100, nano: 360000000 },
  orderType: 2,
  message: '',
  initialOrderPricePt: undefined,
  instrumentUid: '1d0e01e5-148c-40e5-bb8f-1bf2d8e03c1a',
  orderRequestId: '1q6g1immf5k3p7k',
  responseMetadata: {
    trackingId: '1939895de996f76ae311351b8b304bda',
    serverTime: 2025-09-04T15:24:31.392Z
  }
}
2025-09-04T15:24:06.393Z bot:provider generateOrder
2025-09-04T15:24:06.393Z bot:provider position {
  pair: 'TMON/RUB',
  base: 'TMON',
  quote: 'RUB',
  figi: 'TCS70A106DL2',
  price: { units: 142, nano: 290000000 },
  priceNumber: 142.29,
  amount: 0,
  lotSize: 1,
  lotPrice: { units: 142, nano: 290000000 },
  lotPriceNumber: 142.29,
  desiredAmountNumber: 708.165,
  canBuyBeforeTargetLots: 4,
  canBuyBeforeTargetNumber: 569.16,
  beforeDiffNumber: 139.005,
  toBuyLots: 4,
  toBuyNumber: 569.16
}
2025-09-04T15:24:06.393Z bot:provider üí∞ About to place BUY order: 4 lots √ó 142.29 = 569.16 RUB for TMON
2025-09-04T15:24:06.393Z bot:provider Position is not currency
2025-09-04T15:24:06.393Z bot:provider position.toBuyLots 4
2025-09-04T15:24:06.393Z bot:provider Position is greater than or equal to 1 lot
2025-09-04T15:24:06.393Z bot:provider direction 1
2025-09-04T15:24:06.393Z bot:provider position {
  pair: 'TMON/RUB',
  base: 'TMON',
  quote: 'RUB',
  figi: 'TCS70A106DL2',
  price: { units: 142, nano: 290000000 },
  priceNumber: 142.29,
  amount: 0,
  lotSize: 1,
  lotPrice: { units: 142, nano: 290000000 },
  lotPriceNumber: 142.29,
  desiredAmountNumber: 708.165,
  canBuyBeforeTargetLots: 4,
  canBuyBeforeTargetNumber: 569.16,
  beforeDiffNumber: 139.005,
  toBuyLots: 4,
  toBuyNumber: 569.16
}
2025-09-04T15:24:06.393Z bot:provider Creating market order
2025-09-04T15:24:06.393Z bot:provider Sending market order {
  accountId: '2272547076',
  figi: 'TCS70A106DL2',
  quantity: 4,
  direction: 1,
  orderType: 2,
  orderId: '1q6g1immf5k3tdl'
}
{
  trackId: "44ce820b556216e2b984c2a756a1e129",
  message: "Post order error: Vozniknovenie ili uvelichenie nepokry`toj poziczii pri sovershenii sdelok s aktivom nedostupno",
  rateLimit: "300, 300;w=60",
  rateLimitRemaining: "296",
  rateLimitReset: "24",
}
Client error: INVALID_ARGUMENT(30049) 
–û—à–∏–±–∫–∞ –º–µ—Ç–æ–¥–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –ø–æ—Ä—É—á–µ–Ω–∏—è.<br/>–°–º–æ—Ç—Ä–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤ —Ç–µ–∫—Å—Ç–µ –æ—à–∏–±–∫–∏. 
/tinkoff.public.invest.api.contract.v1.OrdersService/PostOrder
2025-09-04T15:24:06.625Z bot:provider Error placing order
2025-09-04T15:24:06.625Z bot:provider ClientError: /tinkoff.public.invest.api.contract.v1.OrdersService/PostOrder INVALID_ARGUMENT: 30049
    at wrapClientError (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/nice-grpc/lib/client/wrapClientError.js:9:39)
    at <anonymous> (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/nice-grpc/lib/client/createUnaryMethod.js:27:50)
    at onReceiveStatus (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/@grpc/grpc-js/build/src/client.js:195:36)
    at onReceiveStatus (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:365:141)
    at onReceiveStatus (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:328:181)
    at <anonymous> (/Users/suenot/projects/tinkoff-invest-etf-balancer-bot/node_modules/tinkoff-sdk-grpc-js/node_modules/@grpc/grpc-js/build/src/call-stream.js:188:78)
    at processTicksAndRejections (native:7:39)
2025-09-04T15:24:11.638Z bot:provider generateOrder
2025-09-04T15:24:11.638Z bot:provider position {
  pair: 'RUB/RUB',
  base: 'RUB',
  quote: 'RUB',
  figi: undefined,
  amount: -1164.32,
  lotSize: 1,
  price: { units: 1, nano: 0 },
  priceNumber: 1,
  lotPrice: { units: 1, nano: 0 },
  totalPrice: { units: -1164, nano: 320000000 },
  lotPriceNumber: 1,
  totalPriceNumber: -1164.32,
  desiredAmountNumber: 0,
  canBuyBeforeTargetLots: 0,
  canBuyBeforeTargetNumber: 0,
  beforeDiffNumber: 0,
  toBuyNumber: 1164.32,
  toBuyLots: 1164.32
}
2025-09-04T15:24:11.639Z bot:provider If position is RUB, do nothing
2025-09-04T15:24:11.641Z bot:balancer Final calculation for TMON: currentLots=0, plannedLots=4, finalLots=4, finalValue=569.16
2025-09-04T15:24:11.641Z bot:balancer Final calculation for TPAY: currentLots=7, plannedLots=-5, finalLots=2, finalValue=201.36
2025-09-04T15:24:11.641Z bot:balancer Final calculation for TOFZ@: currentLots=52, plannedLots=-42, finalLots=10, finalValue=134.4
2025-09-04T15:24:11.641Z bot:balancer Final calculation for TMOS@: currentLots=106, plannedLots=-87, finalLots=19, finalValue=126.35000000000001

‚ö° DIAGNOSIS: Orders executed, BUT coreWallet NOT updated!
‚è∞ Timestamp after balancing: 2025-09-04T15:24:11.641Z
üí∞ RUB balance in OLD coreWallet: -1164.32 (should be same as before)
‚ùå This is the problem: afterShares will be calculated using OLD data!

üìä Margin Information:
  Total margin used: 1405.69 RUB
  Within limits: ‚úÖ Yes
  Margin positions: 3

üîÑ DIAGNOSIS: Fetching FRESH portfolio data after order execution...
üí∞ RUB balance in FRESH wallet: 477.96
üìä Difference in RUB: 1642.28
üéØ FOUND IT! Portfolio changed after balancing - dividends or order execution detected!

üéØ DIAGNOSIS: beforeShares vs afterShares comparison
üìà TPAY: 33.42% -> 43.57% (+10.15%)
üìà TOFZ: 33.15% -> 29.09% (-4.06%)
üìà TMOS: 33.43% -> 27.34% (-6.09%)

üéØ BALANCING RESULT:
Mode used: manual
Format: TICKER: diff: before% -> after% (target%)
Where: before% = current share, after% = actual share after balancing, (target%) = target from balancer, diff = change in percentage points

TPAY: +10.15%: 33.42% -> 43.57% (19.53%)
TOFZ: -4.06%: 33.15% -> 29.09% (13.03%)
TMOS: -6.09%: 33.43% -> 27.34% (12.25%)
TMON: 0%: 0.00% -> 0.00% (55.19%)
RUR: -1164.32 RUB
2025-09-04T15:24:12.004Z bot:provider ITERATION #1 FINISHED. TIME: Thu Sep 04 2025 18:24:12 GMT+0300 (Moscow Standard Time)
